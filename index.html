<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All InfoZone & Hisab (Personal AI V5 - Ultimate Fixed)</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Tesseract.js -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- QR Generator Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style> 
        :root {
            /* --- THEME COLORS --- */
            --primary: #21D4FD; 
            --secondary: #B721FF; 
            --accent: #f72585;
            --success: #10B981; 
            --danger: #e63946; 
            --text-light: #f0f2f5;
            --component-bg: rgba(23, 28, 44, 0.6); 
            --border-color: rgba(255, 255, 255, 0.18);
            --border-radius: 16px; 
            --box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --bottom-nav-height: 70px; 
            --transition: all 0.3s ease-in-out;
            --bank-color: #4F46E5; 
            --goal-color: #EA580C; 
            --dps-color: #7C3AED;
            --loading-bg: #050510;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif; color: var(--text-light);
            background: linear-gradient(320deg, #1d2b64 0%, #000000 50%, #f8cdda 100%);
            background-size: 200% 200%; animation: cosmic-bg 25s ease infinite;
            min-height: 100vh; padding-bottom: var(--bottom-nav-height); 
        }
        @keyframes cosmic-bg { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass-ui {
            background: var(--component-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--box-shadow);
        }
        
        /* LOADING SCREEN */
     #loading-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--loading-bg); 
    z-index: 99999999 !important; /* এখানে মানটি আরও বাড়িয়ে দিন */
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    transition: opacity 0.5s ease-out;
}
        .tech-loader { position: relative; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; }
        .tech-ring { position: absolute; border-radius: 50%; border: 2px solid transparent; }
        .tr-1 { width: 100%; height: 100%; border-top: 4px solid var(--primary); border-bottom: 4px solid var(--primary); box-shadow: 0 0 15px var(--primary); animation: spin 1.5s linear infinite; }
        .tr-2 { width: 70%; height: 70%; border-left: 4px solid var(--secondary); border-right: 4px solid var(--secondary); box-shadow: 0 0 10px var(--secondary); animation: spin-reverse 1s linear infinite; }
        .tr-dot { width: 20%; height: 20%; background: var(--accent); border-radius: 50%; box-shadow: 0 0 20px var(--accent); animation: pulse 1s ease-in-out infinite; }
        .loading-text { margin-top: 30px; color: var(--primary); font-size: 1rem; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; text-shadow: 0 0 10px var(--primary); animation: pulse 1.5s ease-in-out infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-reverse { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }
        @keyframes pulse { 0% { opacity: 0.5; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.9); } }

        /* Login Styles */
        #login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; width: 100%; padding: 1rem; }
        .login-container { width: 100%; max-width: 400px; padding: 2rem; }
        .login-container h2 { color: var(--primary); margin-bottom: 1.5rem; text-align: center; }
        #login-error { color: var(--danger); text-align: center; margin-bottom: 1rem; height: 20px; }
        .password-container { position: relative; }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--primary); z-index: 10; font-size: 1.1rem; }
        .btn { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border-color); color: var(--text-light); padding: 12px 25px; border-radius: 12px; font-weight: 500; cursor: pointer; transition: var(--transition); width: 100%; font-family: 'Poppins', sans-serif; }
        .btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }
        .process-btn { background: var(--secondary); color: white; margin-top: 5px; margin-bottom: 15px; }
        .process-btn:hover { background: var(--accent); }
        .ai-btn { background: linear-gradient(90deg, #FF3CAC 0%, #784BA0 50%, #2B86C5 100%); color: white; border: none; font-weight: bold; margin-bottom: 10px; }
        .ai-btn:hover { box-shadow: 0 0 20px rgba(183, 33, 255, 0.6); transform: scale(1.02); }

        #admin-panel { display: none; }
        .topbar { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; z-index: 1000; margin: 0 1rem; margin-top: 1rem; }
        .topbar h2 { color: var(--primary); font-size: 1.5rem; font-weight: 700; text-shadow: 0 0 10px rgba(33, 212, 253, 0.4); }
        .top-actions { display: flex; align-items: center; gap: 10px; }
        .logout-btn { background: none; border: 1px solid var(--danger); color: var(--danger); border-radius: 50px; padding: 8px 15px; cursor: pointer; transition: 0.3s; }
        .logout-btn:hover { background: var(--danger); color: white; }
        .about-toggle-btn { background: rgba(33, 212, 253, 0.1); border: 1px solid var(--primary); color: var(--primary); width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .about-toggle-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary); }

        .content { padding: 1rem; }
        .page-content { display: none; } 
        .page-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav { 
    position: fixed; bottom: 0; left: 0; right: 0; 
    height: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom));
    padding-bottom: env(safe-area-inset-bottom);
    display: flex; justify-content: space-around; z-index: 1000; overflow-x: auto; 
}
        .bottom-nav a { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: rgba(255, 255, 255, 0.7); text-decoration: none; font-size: 0.6rem; transition: var(--transition); text-align: center; min-width: 60px; }
        .bottom-nav a i { font-size: 1.3rem; margin-bottom: 4px; }
        .bottom-nav a.active { color: var(--primary); transform: translateY(-5px); }
        .bottom-nav a.active i { text-shadow: 0 0 10px var(--primary); }

        .stats-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
  /* ============================================================
   All Info List - PREMIUM CARD & ICON DESIGN (FIXED)
   ============================================================ */

/* ১. কার্ডের মূল কন্টেইনার */
#all-info-list-container {
    display: flex !important;
    flex-direction: column !important;
    gap: 16px !important;
    padding: 10px 5px 100px 5px !important; /* নিচে গ্যাপ রাখা হয়েছে যাতে নেভবারে না ঢাকে */
}

/* ২. প্রিমিয়াম কার্ড ডিজাইন (CONTACTS পেজের মতো) */
.info-card {
    background: rgba(255, 255, 255, 0.04) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 24px !important;
    padding: 20px !important;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4) !important;
    transition: transform 0.3s ease, border 0.3s ease !important;
}

/* ৩. টাইটেল স্টাইল */
.info-title-cell {
    color: #21D4FD !important;
    font-size: 1.2rem !important;
    font-weight: 700 !important;
    margin-bottom: 8px !important;
    line-height: 1.3 !important;
}

/* ৪. আইডি এবং ক্যাটাগরি রো */
.info-meta-row {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    margin-bottom: 20px !important;
}

.id-text {
    color: #94a3b8 !important;
    font-size: 0.85rem !important;
    font-weight: 500 !important;
}

.badge-cat {
    background: rgba(33, 212, 253, 0.15) !important;
    color: #21D4FD !important;
    padding: 3px 12px !important;
    border-radius: 8px !important;
    font-size: 0.75rem !important;
    border: 1px solid rgba(33, 212, 253, 0.3) !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
}

/* ৫. প্রিমিয়াম আইকন বাটন গ্রুপ (একদম ডানে গ্যাপ দিয়ে সাজানো) */
.premium-action-group {
    display: flex !important;
    gap: 14px !important; /* আইকনগুলোর মাঝে চমৎকার দূরত্ব */
    margin-left: 10px !important;
}

.icon-btn-premium {
    width: 44px !important; /* বাটন সাইজ বড় করা হয়েছে */
    height: 44px !important;
    background: rgba(255, 255, 255, 0.06) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 1.35rem !important; /* বড় ও স্পষ্ট আইকন */
    cursor: pointer !important;
    transition: all 0.2s ease !important;
}

/* আইকন কালার */
.btn-share-pr { color: #10B981 !important; border-color: rgba(16, 185, 129, 0.2) !important; }
.btn-edit-pr { color: #21D4FD !important; border-color: rgba(33, 212, 253, 0.2) !important; }
.btn-delete-pr { color: #EF4444 !important; border-color: rgba(239, 68, 68, 0.2) !important; }

/* ক্লিক ইফেক্ট */
.icon-btn-premium:active {
    transform: scale(0.88) !important;
    background: rgba(255, 255, 255, 0.12) !important;
}

/* ৬. View Details বাটন (CONTACTS পেজের স্টাইলে) */
.view-btn-full {
    width: 100% !important;
    padding: 12px !important;
    background: rgba(33, 212, 253, 0.08) !important;
    border: 1px solid rgba(33, 212, 253, 0.5) !important;
    color: #21D4FD !important;
    border-radius: 14px !important;
    font-weight: 600 !important;
    font-size: 0.95rem !important;
    cursor: pointer !important;
    text-transform: uppercase !important;
    letter-spacing: 1.5px !important;
    margin-top: 10px !important;
}

.view-btn-full:active {
    background: rgba(33, 212, 253, 0.2) !important;
}

/* ১. প্রতিটি গ্রুপের মাঝখানের গ্যাপ কমানো */
.form-group { 
    margin-bottom: 10px !important; /* আগে ১.৫ রেম ছিল, এখন ১০ পিক্সেল */
}

/* ২. লেবেল এবং ইনপুট বক্সের মাঝখানের গ্যাপ কমানো */
.form-group label { 
    margin-bottom: 4px !important; 
    font-size: 0.85rem !important; /* লেবেল একটু ছোট করা হলো */
}

/* ৩. ইনপুট বক্সগুলোর হাইট এবং মার্জিন কমানো */
input[type="text"], 
input[type="number"], 
input[type="email"], 
input[type="password"], 
input[type="tel"], 
input[type="url"], 
input[type="date"], 
select {
    height: 42px !important; /* আগে ৫২ পিক্সেল ছিল, এখন ৪২ পিক্সেল */
    margin-bottom: 0px !important; /* নিচের বাড়তি মার্জিন জিরো করা হলো */
    padding: 0 12px !important;
    font-size: 0.9rem !important;
}

/* ৪. টেক্সট এরিয়া (Address) এর গ্যাপ কমানো */
textarea {
    padding: 10px !important;
    margin-bottom: 0px !important;
}

/* ৫. প্লাস (+) বাটন বা ছোট বাটনগুলোর সাইজ এডজাস্ট করা */
.add-phone-btn, .add-social-btn, .add-mail-btn {
    height: 42px !important;
    padding: 0 15px !important;
}

/* ৬. পেজের টাইটেল এবং ফরমের মাঝখানের দূরত্ব কমানো */
#add-contact-page h2, #add-info-page h2 {
    margin-bottom: 15px !important;
}

/* --- ৩. মোডাল ডিজাইন (গ্লাস ইফেক্ট সহ) --- */
.modal { 
    display: none; 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    background-color: rgba(0,0,0,0.8); 
    z-index: 2000; 
    justify-content: center; 
    align-items: center; 
    padding: 1rem; 
    backdrop-filter: blur(8px);
}
.modal-content { 
    color: var(--text-light); 
    width: 100%; 
    max-width: 500px; 
    padding: 2rem; 
    max-height: 90vh; 
    overflow-y: auto; 
    background: linear-gradient(145deg, #171c2c, #0a0a14); 
    border: 1px solid var(--primary); 
    box-shadow: 0 0 40px rgba(33, 212, 253, 0.2); 
    border-radius: 24px; 
}
        /* QR Modal */
        #qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; justify-content: center; align-items: center; flex-direction: column; }
        #reader { width: 300px; height: 300px; background: black; border: 2px solid var(--primary); border-radius: 10px; margin-bottom: 20px;}
        .chat-opt-btn { background: linear-gradient(135deg, #00C6FF, #0072FF); border: none; padding: 8px 15px; color: white; border-radius: 20px; margin: 5px; cursor: pointer; font-size: 0.8rem; }

        .phone-input-group, .social-input-group, .mail-input-group, .bulk-contact-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .phone-input-group input, .social-input-group input, .mail-input-group input, .bulk-contact-row input { flex-grow: 1; }
        .remove-btn { background-color: var(--danger) !important; border-color: var(--danger) !important; color: white; }
        .mail-entry-box { padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .mail-row-compact { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem; }
        .copy-btn-small { background: none; border: 1px solid var(--primary); color: var(--primary); cursor: pointer; padding: 4px 8px; border-radius: 5px; margin-left: 5px; }
        
        .category-filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; justify-content: center; }
        .category-filters .btn { width: auto; }
        .category-filters .btn.active { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }
        .search-controls { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem; }
        .toggle-label { display: flex; align-items: center; cursor: pointer; gap: 10px; margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; }
        .toggle-label input { width: auto; margin: 0; }

        /* Hisab Colors & Style */
        .hisab-tabs { display: flex; overflow-x: auto; gap: 10px; margin-bottom: 20px; padding-bottom: 5px; }
        .hisab-tab { white-space: nowrap; padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.1); cursor: pointer; font-size: 0.85rem; border: 1px solid var(--border-color); color: var(--text-light); }
        .hisab-tab.active { background: var(--primary); color: #000; border-color: var(--primary); }
        .hisab-view { display: none; animation: fadeIn 0.3s; }
        .hisab-view.active { display: block; }
        .balance-hero { background: linear-gradient(135deg, #2563EB, #1D4ED8); color: white; text-align: center; padding: 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4); }
        .balance-hero h1 { font-size: 2.2rem; margin: 5px 0; }
        .hisab-card { background: var(--component-bg); backdrop-filter: blur(12px); border: 1px solid var(--border-color); padding: 15px; border-radius: 16px; margin-bottom: 15px; position: relative; }
        .hisab-card.bank { border-left: 4px solid var(--bank-color); }
        .hisab-card.goal { border-left: 4px solid var(--goal-color); }
        .hisab-card.dps { border-left: 4px solid var(--dps-color); }
        .row-between { display: flex; justify-content: space-between; align-items: center; }
        .action-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .section-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-daily { background: var(--primary); color: #000; }
        .btn-bank { background: var(--bank-color); }
        .btn-goal { background: var(--goal-color); }
        .btn-dps { background: var(--dps-color); }
        .list-delete-btn, .card-delete-btn { color: var(--danger); cursor: pointer; background: rgba(230, 57, 70, 0.1); padding: 5px; border-radius: 5px; border: none; }

.card-delete-btn {
    display: none; 
}
        .pay-btn { padding: 4px 10px; border-radius: 5px; border: none; font-size: 0.75rem; background: var(--primary); color: #000; cursor: pointer; }
 
     /* CHATBOT TRIGGER MODIFIED */
#chatbot-trigger { 
    position: fixed !important; 
    bottom: 100px; 
    right: 20px; 
    width: 65px; 
    height: 65px; 
    border-radius: 50%; 
    background: rgba(23, 28, 44, 0.8) !important; 
    border: 2px solid rgba(33, 212, 253, 0.3) !important;
    cursor: move; 
    z-index: 20000 !important; 
    display: flex !important; 
    align-items: center; 
    justify-content: center; 
    overflow: visible !important;
    touch-action: none !important;
    padding: 5px !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}

.svg-bot { width: 100%; height: 100%; }

/* ১. ভাসমান এনিমেশন (Floating) */
.bot-moving-part {
    animation: botFloat 3s ease-in-out infinite;
    transform-origin: center;
}

/* ২. চোখের পলক ফেলার এনিমেশন (Blinking) */
.bot-eye {
    animation: botBlink 4s infinite;
    transform-origin: center;
}

/* ৩. বাইরের নীল আলোর পালস (Pulse) */
.bot-glow {
    fill: rgba(33, 212, 253, 0.05);
    stroke: rgba(33, 212, 253, 0.2);
    stroke-width: 1;
    animation: botGlowPulse 2s ease-in-out infinite;
}

@keyframes botFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
}

@keyframes botBlink {
    0%, 90%, 100% { transform: scaleY(1); }
    95% { transform: scaleY(0); }
}

@keyframes botGlowPulse {
    0% { r: 42; opacity: 0.3; }
    50% { r: 47; opacity: 0.7; }
    100% { r: 42; opacity: 0.3; }
}
/* চ্যাটবট এবং ব্যাক বাটন শুরুতে হাইড করে রাখার জন্য */
#chatbot-trigger, #back-button-trigger { 
    display: none !important; /* শুরুতে কেউ দেখবে না */
    position: fixed !important;
    z-index: 20000 !important;
}

/* লোডিং স্ক্রিন যাতে সবকিছুর ওপরে থাকে */
#loading-screen {
    z-index: 99999999 !important; /* এর মান বাড়িয়ে দিন */
}
#chatbot-trigger:active { 
    transform: scale(0.9); /* চাপ দিলে আইকনটি একটু দেবে যাবে, যা প্রিমিয়াম ফিল দেবে */
}
        #chatbot-container { display: none; position: fixed; bottom: 100px; right: 20px; width: 320px; height: 450px; flex-direction: column; z-index: 2000; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
        .chat-header { padding: 15px; background: rgba(0,0,0,0.4); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: bold; color: var(--primary); }
        #close-chat { background: none; border: none; color: white; cursor: pointer; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 80%; padding: 10px; border-radius: 10px; font-size: 0.85rem; word-wrap: break-word; }
        .message.bot { align-self: flex-start; background: rgba(255,255,255,0.1); border-top-left-radius: 0; }
        .message.user { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 0; }
        .chat-input-area { padding: 10px; background: rgba(0,0,0,0.3); display: flex; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); }
        #chat-input { flex: 1; border-radius: 20px; font-size: 0.8rem; padding: 8px 12px; }
        #chat-send-btn, #chat-img-btn { background: var(--secondary); border: none; width: 35px; height: 35px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #chat-img-btn { background: rgba(255,255,255,0.1); }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .setting-row:last-child { border-bottom: none; }
        .logic-tag { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 5px; font-size: 0.7rem; color: #aaa; margin-right: 5px; }

        /* THEME STORE STYLES */
        .theme-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); padding: 12px; border-radius: 12px; margin-bottom: 10px; transition: 0.2s; }
        .theme-name { font-weight: 600; color: #fff; font-size: 0.95rem; }
        .theme-actions { display: flex; gap: 8px; align-items: center; }
        .btn-mini { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; color: white; }
        .btn-download { background: linear-gradient(135deg, #00C6FF, #0072FF); }
        .btn-apply { background: #10B981; color: white; font-weight: 500; }
        .btn-delete { background: rgba(239, 68, 68, 0.2); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .badge-active { color: #10B981; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; background: rgba(16, 185, 129, 0.1); padding: 5px 10px; border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.2); }

        /* DASHBOARD STYLES */
        .dashboard-wrapper { width: 100%; max-width: 100%; }
        .section-header { display: flex; align-items: center; gap: 10px; margin: 25px 0 15px 0; color: var(--text-light); opacity: 0.8; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
        .section-header::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
        .finance-card { background: linear-gradient(135deg, #3b82f6 0%, #2dd4bf 100%); padding: 25px; border-radius: 20px; color: white; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3); position: relative; margin-bottom: 20px; }
        .finance-top-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; }
        .f-item h3 { font-size: 0.85rem; font-weight: 500; opacity: 0.9; margin-bottom: 5px; }
        .f-item h1 { font-size: 1.8rem; font-weight: 700; line-height: 1; margin: 0; }
        .text-right { text-align: right; }
        .finance-stats { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); }
        .mini-stat span { display: block; font-size: 0.75rem; opacity: 0.9; }
        .mini-stat b { font-size: 1.1rem; }
        .media-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .media-card { background: var(--component-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; display: flex; align-items: center; gap: 15px; }
        .icon-box { width: 45px; height: 45px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        .bg-photo { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
        .bg-video { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .bg-audio { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .bg-file { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .media-info h4 { font-size: 0.95rem; margin-bottom: 2px; }
        .media-info p { font-size: 0.75rem; color: #ccc; margin: 0; }
        .data-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;}
        .data-card { background: var(--component-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px 10px; text-align: center; }
        .data-card i { font-size: 1.2rem; margin-bottom: 8px; color: #60a5fa; }
        .data-card .num { display: block; font-size: 1.2rem; font-weight: 700; }
        .data-card .label { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }
        .contact-bar { background: linear-gradient(90deg, rgba(30,41,59,0.8), rgba(15,23,42,0.8)); border: 1px solid var(--border-color); padding: 15px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .c-left { display: flex; align-items: center; gap: 15px; }
        .c-icon { width: 40px; height: 40px; background: #3b82f6; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
   /* --- Global Premium Input & Select Style (All Pages) --- */

/* ১. সব ইনপুট, সিলেক্ট এবং টেক্সটএরিয়া বড় ও প্রিমিয়াম করা */
input[type="text"], 
input[type="number"], 
input[type="email"], 
input[type="password"], 
input[type="tel"], 
input[type="url"], 
input[type="date"], 
select, 
textarea {
    width: 100% !important;
    height: 52px; /* বড় সাইজ */
    margin-bottom: 15px; /* নিচের বক্স থেকে দূরত্ব */
    padding: 0 18px;
    background: rgba(255, 255, 255, 0.05) !important; /* হালকা গ্লাস লুক */
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    color: #fff !important;
    font-size: 0.95rem;
    font-family: 'Poppins', sans-serif;
    outline: none;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

/* ২. ফোকাস করলে গ্লো ইফেক্ট */
input:focus, select:focus, textarea:focus {
    border-color: var(--primary) !important;
    background: rgba(255, 255, 255, 0.1) !important;
    box-shadow: 0 0 15px rgba(33, 212, 253, 0.2);
}

/* ৩. টেক্সটএরিয়া (বড় বক্স) এর জন্য আলাদা হাইট */
textarea {
    height: auto !important;
    padding: 15px !important;
}

/* ৪. সিলেক্ট বক্স (Dropdown) এর জন্য মডার্ন লুক */
select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") !important;
    background-repeat: no-repeat !important;
    background-position: right 15px center !important;
    background-size: 16px !important;
}

/* ৫. প্লেসহোল্ডার কালার (ঝাপসা সাদা) */
::placeholder {
    color: rgba(255, 255, 255, 0.3);
    font-size: 0.85rem;
    letter-spacing: 1px;
}

/* ৬. মোডাল (Add New Popup) এর ডিজাইন উন্নত করা */
.modal-content {
    border-radius: 24px !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    padding: 25px !important;
}

.modal-content h3 {
    margin-bottom: 20px;
    letter-spacing: 1px;
    text-transform: uppercase;
    font-size: 1.1rem;
}

/* ৭. সেভ এবং ক্যানসেল বাটন স্টাইল */
.modal-content .btn {
    height: 50px;
    border-radius: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 10px;
}
/* Savings Progress Bar Style */
.goal-progress-wrapper {
    width: 100%;
    margin-top: 12px;
}
.progress-bg {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #EA580C, #FB923C); /* গোল কালার গ্রেডিয়েন্ট */
    border-radius: 10px;
    transition: width 0.5s ease-in-out;
}
.percent-text {
    font-size: 0.75rem;
    color: var(--goal-color);
    font-weight: 600;
    margin-bottom: 4px;
    display: block;
    text-align: right;
}
/* --- চ্যাট মেসেজ সোয়াইপ এনিমেশন (সংশোধিত) --- */
.message {
    transition: transform 0.3s ease, opacity 0.3s ease;
    position: relative;
    user-select: none;
    -webkit-user-select: none;
    touch-action: pan-y; /* স্ক্রিন উপরে-নিচে স্ক্রল হবে কিন্তু ডানে-বামে মেসেজ সরবে */
}

/* আপনার (User) মেসেজ বামে সোয়াইপ হয়ে ডিলিট হবে */
.message.user.deleting {
    transform: translateX(-150%) !important;
    opacity: 0;
}

/* বটের (Bot) মেসেজ ডানে সোয়াইপ হয়ে ডিলিট হবে */
.message.bot.deleting {
    transform: translateX(150%) !important;
    opacity: 0;
}
/* PIN টাইপ করার সময় লেখা গোপন করার জন্য */
.pin-hidden {
    -webkit-text-security: disc !important;
    text-security: disc !important;
}
/* Custom Confirm Box Style */
#custom-confirm-overlay {
    display: none;
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 100000;
    backdrop-filter: blur(5px);
}
#custom-confirm-box {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(145deg, #171c2c, #0a0a14);
    border: 1px solid var(--primary);
    padding: 25px;
    border-radius: 20px;
    width: 85%; max-width: 320px;
    text-align: center;
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
}
#custom-confirm-box p { color: #fff; margin-bottom: 25px; font-size: 1.1rem; }
.confirm-btns { display: flex; gap: 10px; }
.confirm-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
.btn-no { background: rgba(255,255,255,0.1); color: #fff; }
.btn-yes { background: var(--danger); color: #fff; }
/* --- TELEGRAM STYLE API PORTAL CSS --- */
.api-item-box {
    background: rgba(0, 0, 0, 0.3) !important;
    padding: 14px !important;
    border-radius: 10px !important;
    display: flex !important;
    align-items: center !important;
    gap: 15px !important;
    cursor: pointer !important;
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    transition: 0.3s !important;
    margin-bottom: 8px !important;
    overflow: hidden !important;
}

.api-item-box:hover { 
    background: rgba(255, 255, 255, 0.05) !important; 
    border-color: var(--primary) !important;
}

.scramble-text {
    font-family: 'Courier New', Courier, monospace !important;
    font-size: 0.85rem !important;
    color: #00ff88 !important; /* প্রফেশনাল গ্রিন কালার */
    word-break: break-all !important;
    flex: 1 !important;
    letter-spacing: 1px !important;
}

/* জির জির বা কাঁপানো অ্যানিমেশন */
.jir-jir {
    color: #666 !important; /* হাইড থাকা অবস্থায় ঝাপসা রং */
    animation: flicker 0.15s infinite !important;
    opacity: 0.6 !important;
}

@keyframes flicker {
    0% { opacity: 0.4; }
    50% { opacity: 1; }
    100% { opacity: 0.4; }
}
/* --- ড্যাশবোর্ড বা হোম পেজের টেবিল ফিক্স --- */

/* ১. ড্যাশবোর্ডের ভেতর টেবিলের লেআউট ঠিক করা */
.dashboard-wrapper .info-table {
    table-layout: auto !important; /* লেখা অনুযায়ী জায়গা নেবে */
    width: 100% !important;
    border-spacing: 0 8px !important; /* রো গুলোর মাঝে গ্যাপ */
    border-collapse: separate !important;
}

/* ২. টেবিল হেডার (Name, Phone, UID) এর গ্যাপ ঠিক করা */
.dashboard-wrapper .info-table th {
    padding: 10px 5px !important;
    text-align: left !important;
    color: var(--primary) !important;
    font-size: 0.8rem !important;
    text-transform: uppercase;
}

/* ৩. টেবিলের প্রতিটা ঘরের (Cell) প্যাডিং বাড়ানো */
.dashboard-wrapper .info-table td {
    padding: 12px 8px !important;
    background: rgba(255, 255, 255, 0.03); /* হালকা ব্যাকগ্রাউন্ড */
    font-size: 0.85rem !important;
    border: none !important;
}

/* ৪. UID এবং Title মিশে যাওয়া বন্ধ করা */
.dashboard-wrapper .info-table td:first-child {
    border-radius: 10px 0 0 10px;
    padding-left: 15px !important;
    font-weight: bold;
    color: #94a3b8;
    width: 60px !important; /* আইডি কলামের জন্য ফিক্সড জায়গা */
}

/* ৫. অ্যাকশন বাটনের কলাম ঠিক করা */
.dashboard-wrapper .info-table td:last-child {
    border-radius: 0 10px 10px 0;
    text-align: right !important;
}

/* ৬. ড্যাশবোর্ডের "View" বাটনটিকে সুন্দর করা */
.dashboard-wrapper .open-btn {
    background: rgba(33, 212, 253, 0.1) !important;
    border: 1px solid var(--primary) !important;
    color: var(--primary) !important;
    padding: 4px 10px !important;
    font-size: 0.75rem !important;
    border-radius: 6px !important;
}

/* টেবিল কন্টেইনারের বাড়তি সাদা বর্ডার বা স্ক্রলবার ঠিক করা */
.dashboard-wrapper .glass-ui {
    padding: 10px !important;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
}
/* --- কন্টাক্ট ডিটেইলস মোডাল স্টাইল --- */
.modal-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    padding: 12px 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}
.modal-info-label {
    font-size: 0.7rem;
    color: var(--primary);
    font-weight: 700;
    text-transform: uppercase;
    display: block;
    margin-bottom: 3px;
    letter-spacing: 1px;
}
.modal-info-text {
    font-size: 0.95rem;
    color: #ffffff;
    word-break: break-all;
}
.copy-btn-action {
    background: rgba(33, 212, 253, 0.1);
    border: none;
    color: var(--primary);
    width: 35px;
    height: 35px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s;
}
.copy-btn-action:hover {
    background: var(--primary);
    color: #000;
}
/* Premium Financial Card Style */
.fin-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 25px;
    margin-bottom: 20px;
}
.fin-header {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: #fff;
}
.chart-container {
    position: relative;
    width: 180px;
    height: 180px;
    margin: 0 auto 30px auto;
    display: flex;
    align-items: center;
    justify-content: center;
}
.donut-chart {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    /* Default gradient if values are 0 */
    background: conic-gradient(#21D4FD 0% 0%, #B721FF 0% 0%, #EA580C 0% 0%, #10B981 0% 0%, #333 0% 100%);
    display: flex;
    align-items: center;
    justify-content: center;
}
.donut-inner {
    width: 82%;
    height: 82%;
    background: #0f172a; /* আপনার অ্যাপের ব্যাকগ্রাউন্ডের সাথে মিল রেখে */
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.fin-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}
.fin-item {
    padding: 12px;
    border-radius: 16px;
    border-left: 3px solid transparent;
    background: rgba(255,255,255,0.02);
}
.fin-item h4 { font-size: 0.75rem; color: #94a3b8; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
.fin-item .val { font-size: 1rem; font-weight: 700; color: #fff; }
.fin-item .perc { font-size: 0.75rem; font-weight: 600; float: right; margin-top: 5px; }

/* Category Colors */
.c-cash { border-color: #21D4FD; } .t-cash { color: #21D4FD; }
.c-bank { border-color: #B721FF; } .t-bank { color: #B721FF; }
.c-goal { border-color: #EA580C; } .t-goal { color: #EA580C; }
.c-dps { border-color: #10B981; } .t-dps { color: #10B981; }

/* সেটিংসের আইকনগুলোর জন্য বাড়তি স্টাইল */
.icon-btn-premium {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
}

.icon-btn-premium:active {
    transform: scale(0.9);
}

.btn-edit-pr { color: #21D4FD; }
.btn-delete-pr { color: #EF4444; }

#chatbot-trigger {
    /* আগের সব স্টাইল থাকবে, শুধু নিচের লাইনগুলো নিশ্চিত করুন */
    touch-action: none; /* যাতে সরানোর সময় পেজ স্ক্রল না হয়ে যায় */
    user-select: none;
    position: fixed; /* এটি নিশ্চিত করুন */
    z-index: 9999;
}
#back-button-trigger {
    position: fixed !important;
    bottom: 160px; /* চ্যাটবট থেকে একটু ওপরে */
    right: 20px;
    width: 50px; /* চ্যাটবট থেকে সাইজে একটু ছোট */
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    display: flex !important;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20001 !important; /* চ্যাটবট থেকে এক ধাপ ওপরে */
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    touch-action: none !important;
    transition: transform 0.2s ease;
}

#back-button-trigger i {
    font-size: 1.2rem !important;
}

#back-button-trigger:active {
    transform: scale(0.9);
}
.list-delete-btn {
    color: var(--danger);
    cursor: pointer;
    background: rgba(230, 57, 70, 0.1);
    padding: 8px;
    border-radius: 8px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
}
.hisab-card small {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 5px;
    font-size: 0.75rem;
}
/* =========================================
   PROFESSIONAL MUSIC PLAYER STYLES (MODIFIED)
   ========================================= */

/* ১. প্লেয়ারের কভার আর্ট (সাইজ একটু বাড়িয়ে এনিমেশন রাখা হয়েছে) */
.music-cover-art {
    width: 130px;
    height: 130px;
    background: linear-gradient(135deg, #21D4FD, #B721FF);
    border-radius: 20px;
    margin: 10px auto 20px auto;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 10px 30px rgba(183, 33, 255, 0.4);
    animation: pulse-glow 3s infinite;
}
@keyframes pulse-glow { 
    0% { box-shadow: 0 10px 30px rgba(183, 33, 255, 0.4); } 
    50% { box-shadow: 0 10px 40px rgba(33, 212, 253, 0.6); } 
    100% { box-shadow: 0 10px 30px rgba(183, 33, 255, 0.4); } 
}

/* ২. কন্ট্রোল বাটনসমূহ */
.pro-player-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 25px;
    margin: 20px 0;
}
.ctrl-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.4rem;
    cursor: pointer;
    transition: 0.2s;
    opacity: 0.8;
}
.ctrl-btn:active { transform: scale(0.9); }
.ctrl-btn:hover { opacity: 1; transform: scale(1.1); }

.play-pause-btn {
    width: 65px;
    height: 65px;
    background: white;
    color: var(--secondary);
    border-radius: 50%;
    font-size: 1.8rem;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 0 20px rgba(255,255,255,0.3);
}


/* ৩. প্রোগ্রেস বার (সংশোধিত) */
.progress-area {
    width: 100%;
    height: auto !important; /* আগে 10px ছিল, এখন auto করা হলো যাতে লেখা দেখা যায় */
    display: flex;
    flex-direction: column; /* বার এবং সময়কে উপর-নিচে রাখার জন্য */
    justify-content: center;
    cursor: pointer;
    margin-bottom: 10px; 
    touch-action: none; 
    position: relative;
    z-index: 10; 
}

.progress-bar {
    width: 100%;
    height: 6px; 
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    position: relative;
    pointer-events: none; 
}

/* টাইম ফিক্সড ডিজাইন (সংশোধিত) */
.time-row {
    display: flex;
    justify-content: space-between; /* এটিই সময়কে দুই পাশে (বাম ও ডানে) ঠেলে দেবে */
    align-items: center;
    width: 100%;  
    margin-top: 12px; /* বার থেকে সময়ের দূরত্ব */
    font-size: 0.85rem; /* ফন্ট সাইজ একটু স্পষ্ট করা হলো */
    color: #ccc;
    font-weight: 500;
    pointer-events: none; 
}

/* ৪. প্লেলিস্ট ডিজাইন */
.music-list-container {
    background: rgba(0,0,0,0.2);
    border-radius: 15px;
    max-height: 220px; 
    overflow-y: auto;
    margin-top: 10px;
    padding: 5px;
}
.music-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer;
    border-radius: 8px;
    margin-bottom: 5px;
}
.music-item:hover { background: rgba(255,255,255,0.05); }
.music-item.active {
    background: linear-gradient(90deg, rgba(33, 212, 253, 0.15), transparent);
    border-left: 3px solid var(--primary);
}
.music-title { font-size: 0.9rem; color: #eee; font-weight: 500; }
.music-icon { width: 30px; text-align: center; color: var(--secondary); }


/* --- MUSIC BUTTON & EQUALIZER STYLE --- */
#music-button-trigger {
    position: fixed !important;
    bottom: 100px;
    left: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #1e293b, #0f172a); 
    border: 2px solid rgba(33, 212, 253, 0.5);
    color: white;
    display: none !important; /* শুরুতে হাইড থাকবে, গান বাজলে স্ক্রিপ্ট একে শো করবে */
    align-items: center;
    justify-content: center;
    cursor: move;
    z-index: 20000 !important;
    font-size: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    overflow: hidden;
}

/* ডিফল্ট অবস্থায় ইকুলাইজার লুকানো থাকবে */
.equalizer {
    display: none;
    align-items: flex-end;
    gap: 4px;
    height: 30px;
}

.bar {
    width: 6px;
    background: linear-gradient(to top, #21D4FD, #B721FF);
    border-radius: 2px;
    animation: bounce 1s infinite ease-in-out;
}

/* গান বাজলে এই ক্লাসটি যুক্ত হবে */
#music-button-trigger.playing .equalizer {
    display: flex; 
}
#music-button-trigger.playing #music-btn-icon {
    display: none; 
}
#music-button-trigger.playing {
    border-color: #B721FF; 
    box-shadow: 0 0 20px rgba(183, 33, 255, 0.6); 
}

/* লাফানোর এনিমেশন */
.bar1 { animation-duration: 0.9s; height: 10px; }
.bar2 { animation-duration: 0.7s; height: 20px; }
.bar3 { animation-duration: 0.8s; height: 15px; }
.bar4 { animation-duration: 0.6s; height: 12px; }
.bar5 { animation-duration: 0.7s; height: 16px; }
.bar6 { animation-duration: 0.8s; height: 11px; }

@keyframes bounce {
    0%, 100% { height: 10px; }
    50% { height: 25px; } 
}



</style>
</head>
<body>
<!-- APP LOCK OVERLAY -->
<div id="app-lock-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:20000; flex-direction:column; justify-content:center; align-items:center; backdrop-filter:blur(15px);">
    <div class="glass-ui" style="padding:30px; text-align:center; width:85%; max-width:350px; border:1px solid var(--primary);">
        <i class="fas fa-user-shield" style="font-size:3.5rem; color:var(--primary); margin-bottom:20px; text-shadow:0 0 15px var(--primary);"></i>
        <h2 id="lock-msg" style="margin-bottom:20px; font-size:1.2rem;">System Locked</h2>
        
        <input type="password" id="app-pin-input" placeholder="Enter PIN/Password" 
               style="text-align:center; font-size:1.2rem; letter-spacing:3px; margin-bottom:15px; border-color:var(--primary);">
        
        <button class="btn" onclick="unlockApp()" style="background:var(--primary); color:black; font-weight:bold;">UNLOCK <i class="fas fa-unlock"></i></button>
        
        <button onclick="forgotPinReset()" style="background:none; border:none; color:var(--primary); font-size:0.8rem; margin-top:10px; cursor:pointer; text-decoration:underline;">Forgot PIN/Password?</button>
        
        <div id="fingerprint-lock-section" style="margin-top:20px; display:none;">
            <p style="font-size:0.8rem; color:#888; margin-bottom:10px;">Or use Biometric</p>
            <button type="button" onclick="triggerLockFingerprint()" style="background:none; border:none; cursor:pointer;">
                <i class="fas fa-fingerprint" style="font-size:3rem; color:var(--primary);"></i>
            </button>
        </div>
    </div>
</div>

<!-- DYNAMIC THEME LAYER -->
<div id="theme-bg-layer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; overflow: hidden;"></div>
<style id="theme-custom-style"></style>

<!-- LOADING SCREEN -->
<div id="loading-screen">
    <div class="tech-loader">
        <div class="tech-ring tr-1"></div>
        <div class="tech-ring tr-2"></div>
        <div class="tech-ring tr-dot"></div>
    </div>
    <div class="loading-text">SYSTEM LOADING...</div>
</div>

<!-- LOGIN PAGE -->
<div id="login-page">
    <div class="login-container glass-ui">
        <h2>Login Now</h2>
        <p id="login-error"></p>
        <form id="login-form">
            <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" placeholder="Enter your email" required></div>
            
            <div class="form-group">
                <label for="login-password">Password</label>
                <div class="password-container">
                    <input type="password" id="login-password" placeholder="Enter your password" required>
                    <i class="fas fa-eye password-toggle" id="toggle-password-btn"></i>
                </div>
            </div>
            <button type="submit" class="btn">Login</button>
            
            <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <p id="fingerprint-text" style="font-size: 0.8rem; color: #999; margin-bottom: 10px; display: none;">Or unlock with</p>
                <button type="button" id="fingerprint-btn" style="background: none; border: none; cursor: pointer; display: none;">
                    <i class="fas fa-fingerprint" style="font-size: 2.5rem; color: var(--primary);"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ADMIN PANEL -->
<div id="admin-panel">
    <!-- TOPBAR -->
    <div class="topbar glass-ui">
        <h2>All InfoZone</h2>
        <div class="top-actions">
            <button id="about-btn" class="about-toggle-btn" title="About"><i class="fas fa-info"></i></button>
            <button class="logout-btn" id="logout-button" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>

    <div class="content" id="content">
        <!-- DASHBOARD PAGE -->
        <div id="dashboard-page" class="page-content active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><h2>Dashboard</h2></div>
            <div class="dashboard-wrapper">
                <!-- FINANCE SECTION -->
                <div class="section-header"><i class="fas fa-wallet"></i> <span>Overview</span></div>
                <div class="finance-card">
                    <div class="finance-top-row">
                        <div class="f-item"><h3>Net Worth</h3><h1 id="dashboard-net-worth">৳ 0</h1></div>
                        <div class="f-item text-right"><h3>Total Info</h3><h1 id="dash-total-info">0</h1></div>
                    </div>
                    <div class="finance-stats">
                        <div class="mini-stat"><span>Cash</span><b id="dash-cash">৳ 0</b></div>
                        <div class="mini-stat"><span>Bank</span><b id="dash-bank">৳ 0</b></div>
                        <div class="mini-stat"><span>Savings (Goal+DPS)</span><b id="dash-savings">৳ 0</b></div>
                    </div>
                </div>
                
                <!-- MEDIA LIBRARY SECTION -->
                <div class="section-header"><i class="fas fa-folder-open"></i> <span>Media Library</span></div>
                <div class="media-grid">
                    <div class="media-card"><div class="icon-box bg-photo"><i class="fas fa-image"></i></div><div class="media-info"><h4>Photos</h4><p><span id="count-photo">0</span> items</p></div></div>
                    <div class="media-card"><div class="icon-box bg-video"><i class="fas fa-video"></i></div><div class="media-info"><h4>Videos</h4><p><span id="count-video">0</span> items</p></div></div>
                    <div class="media-card"><div class="icon-box bg-audio"><i class="fas fa-music"></i></div><div class="media-info"><h4>Audio</h4><p><span id="count-audio">0</span> items</p></div></div>
                    <div class="media-card"><div class="icon-box bg-file"><i class="fas fa-file-alt"></i></div><div class="media-info"><h4>Files</h4><p><span id="count-file">0</span> docs</p></div></div>
                </div>
                
                <!-- DATA DETAILS SECTION -->
                <div class="section-header"><i class="fas fa-database"></i> <span>Data Details</span></div>
                <div class="data-grid">
                    <div class="data-card"><i class="fas fa-align-left"></i><span class="num" id="count-text">0</span><span class="label">Text Info</span></div>
                    <div class="data-card"><i class="fas fa-link"></i><span class="num" id="count-link">0</span><span class="label">Links</span></div>
                    <div class="data-card"><i class="fas fa-envelope"></i><span class="num" id="count-mail">0</span><span class="label">Mails</span></div>
                </div>
                
                <!-- CONTACTS SECTION -->
                <div class="section-header"><i class="fas fa-users"></i> <span>People</span></div>
                <div class="contact-bar">
                    <div class="c-left"><div class="c-icon"><i class="fas fa-address-book"></i></div><div><h4 style="margin:0; font-weight:600;">All Contacts</h4><small style="color:#94a3b8;">Saved numbers</small></div></div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;" id="count-contacts">0</div>
                </div>
                
                <!-- RECENT CONTACTS -->
                <h3 style="margin-top: 1.5rem; font-size:1rem;">Recent Contacts</h3>
                <div class="glass-ui" style="overflow-x: auto; margin-bottom: 20px;">
                    <table class="info-table"><thead><tr><th>UID</th><th>Name</th><th>Phone</th><th>Actions</th></tr></thead><tbody id="recent-contacts-table"></tbody></table>
                </div>
                
                <!-- RECENT INFORMATION -->
                <h3 style="font-size:1rem;">Recent Information</h3>
                <div class="glass-ui" style="overflow-x: auto;">
                    <table class="info-table"><thead><tr><th>UID</th><th>Title</th><th>Actions</th></tr></thead><tbody id="recent-info-table"></tbody></table>
                </div>
            </div>
        </div>

        <!-- SEARCH PAGE -->
        <div id="search-page" class="page-content">
            <h2>Search Information</h2>
            <div class="glass-ui" style="padding: 1.5rem;">
                <div class="search-controls">
                    <select id="search-category" class="btn">
                        <option value="all">All</option>
                        <option value="hisab">My Finance</option>
                        <option value="text">Text Info</option>
                        <option value="link">Link Info</option>
                        <option value="mail">Mail Info</option>
                        <option value="contacts">Contacts</option>
                        <option value="photo">Photo</option>
                        <option value="video">Video</option>
                        <option value="audio">Music/Audio</option>
                        <option value="file">File (PDF/Docs)</option>
                    </select>
                    <input type="text" id="search-keyword" placeholder="Search by UID, Title, Name...">
                    <button class="btn" id="search-button"><i class="fas fa-search"></i> Search</button>
                </div>
                <div id="search-results" style="overflow-x: auto;">
                    <table class="info-table"><thead id="search-results-thead"></thead><tbody id="search-results-tbody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- ADD INFO PAGE -->
        <div id="add-info-page" class="page-content">
            <h2 id="info-form-title">Add New Information</h2>
            <div class="glass-ui" style="padding: 1.5rem;">
                <div class="form-group">
                    <label>Category</label>
                    <select id="info-category" required>
                        <option value="">Select Category</option>
                        <option value="text">Text Info</option>
                        <option value="link">Link Info</option>
                        <option value="mail">Mail Info</option>
                        <option value="photo">Photo / Image</option>
                        <option value="video">Video Info</option>
                        <option value="audio">Music / Audio</option>
                        <option value="file">File (PDF/Docs)</option>
                    </select>
                </div>
                <label class="toggle-label" id="mail-bulk-toggle-wrapper" style="display: none;"><input type="checkbox" id="mail-bulk-toggle"><span><i class="fas fa-layer-group"></i> Bulk Import Mode</span></label>
                <form id="add-info-form">
                    <div class="form-group"><label>Title</label><input type="text" id="info-title" placeholder="Enter title" required></div>
                    <div class="form-group" id="text-upload-group"><button type="button" class="btn ai-btn" id="ai-scan-info-btn"><i class="fas fa-magic"></i> AI Scan Image to Text</button><label>Text Content</label><textarea id="info-content" placeholder="Enter text or use AI Scan..."></textarea></div>
                    <div class="form-group" id="link-upload-group" style="display: none;"><label>Website/Link</label><input type="url" id="info-link" placeholder="https://example.com"></div>
                    <div class="form-group" id="file-upload-group" style="display: none;"><label id="file-label">Upload File</label><input type="file" id="info-file-input" style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; width: 100%;"><div id="upload-status" style="margin-top:5px; font-size:0.8rem; color: var(--secondary);"></div></div>
                    <div class="form-group" id="mail-bulk-mode" style="display: none;"><button type="button" class="btn ai-btn" id="ai-scan-mail-btn"><i class="fas fa-magic"></i> AI Scan Mail List</button><label>Bulk Import List</label><textarea id="bulk-mail-text" placeholder="Paste your list here..." style="height: 120px;"></textarea><button type="button" class="btn process-btn" id="process-mail-btn">Direct Now <i class="fas fa-arrow-down"></i></button></div>
                    <div class="form-group" id="mail-manual-mode" style="display: none;"><label>Mail Credentials</label><div id="mail-rows-container"><div class="mail-input-group"><input type="email" class="mail-email" placeholder="Email"><input type="text" class="mail-password" placeholder="Pass"><button type="button" class="add-mail-btn btn">+</button></div></div></div>
                    <button type="submit" id="info-submit-btn" class="btn">Add Information</button>
                </form>
    </div>
</div>

<!-- ৪. All Information List Page -->
<div id="all-category-info-page" class="page-content">
    <h2>All Information List</h2>
    <div class="category-filters">
        <button class="btn filter-btn active" data-category="all">All</button>
        <button class="btn filter-btn" data-category="text">Text</button>
        <button class="btn filter-btn" data-category="link">Link</button>
        <button class="btn filter-btn" data-category="mail">Mail</button>
        <button class="btn filter-btn" data-category="photo">Photo</button>
        <button class="btn filter-btn" data-category="video">Video</button>
        <button class="btn filter-btn" data-category="audio">Audio</button> 
        <button class="btn filter-btn" data-category="file">File</button>
    </div>

    <!-- সরাসরি ডিভ কন্টেইনার, কোনো বাড়তি টেবিল বা গ্লাস-ইউআই লাগবে না -->
    <div id="all-info-list-container" style="margin-top: 15px;"></div>
</div>
        <!-- ADD CONTACT PAGE -->
        <div id="add-contact-page" class="page-content">
            <h2>Add New Contact</h2>
            <div class="glass-ui" style="padding: 1.5rem;">
                <label class="toggle-label"><input type="checkbox" id="contact-bulk-toggle"><span><i class="fas fa-layer-group"></i> Bulk Import Mode</span></label>
                <form id="add-contact-form">
                    <div id="single-contact-mode">
                        <div class="form-group"><label>Name</label><input type="text" id="contact-name" placeholder="Enter full name"></div>
                        <div class="form-group"><label>Phone(s)</label><div id="phone-numbers-container"><div class="phone-input-group"><input type="tel" class="contact-phone" placeholder="Phone"><button type="button" class="add-phone-btn btn">+</button></div></div></div>
                        <div class="form-group"><label>Email</label><input type="email" id="contact-email" placeholder="Email"></div>
                        <div class="form-group"><label>Address</label><textarea id="contact-address" placeholder="Address"></textarea></div>
                        <div class="form-group"><label>Social Link(s)</label><div id="social-links-container"><div class="social-input-group"><input type="url" class="contact-social" placeholder="Link"><button type="button" class="add-social-btn btn">+</button></div></div></div>
                    </div>
                <div id="bulk-contact-mode" style="display: none;">
    <!-- স্ক্যান এবং পেস্ট এরিয়া -->
    <div class="form-group">
        <button type="button" class="btn ai-btn" id="ai-scan-contact-btn"><i class="fas fa-magic"></i> AI Scan List Image</button>
        <label>Paste List</label>
        <textarea id="bulk-contact-text" placeholder="Paste data here..." style="height: 150px;"></textarea>
        <button type="button" class="btn process-btn" id="process-contact-btn">Direct Now ↓</button>
    </div>
    
    <!-- প্রসেস হওয়া ডেটা দেখার জায়গা -->
    <div id="bulk-contact-preview"></div>

    <!-- ✅ এই বাটনটি এখন শুধু এই ব্লকের ভেতরে থাকবে -->
    <div style="text-align: right; margin-bottom: 15px; margin-top: 10px;">
        <button type="button" class="btn" style="width: auto; padding: 10px 20px; background: var(--success); color: black; font-weight: bold; border-radius: 50px;" onclick="renderBulkRow('', '', '')">
            <i class="fas fa-plus"></i> Add Row Manually
        </button>
    </div>
</div>
                    <button type="submit" class="btn" id="contact-submit-btn">Add Contact</button>
                </form>
            </div>
        </div>

        <!-- ALL CONTACTS PAGE -->
<div id="all-contacts-page" class="page-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2>All Contacts</h2>
        <button class="open-btn" onclick="openAddContactPage()" style="background: var(--primary); color: black; font-weight: bold; border-radius: 50px; padding: 8px 20px;">+ Add New</button>
    </div>
    <!-- টেবিলের বদলে এখানে আমরা একটি খালি ডিভ (Container) ব্যবহার করব -->
    <div id="contacts-list-container" style="display: flex; flex-direction: column; gap: 12px;">
        <!-- এখানে কন্টাক্ট কার্ডগুলো অটোমেটিক আসবে -->
    </div>
</div>

        <!-- HISAB TRACKER PAGE -->
        <div id="hisab-page" class="page-content">
            <h2>My Finance</h2>
            <div class="hisab-tabs">
                <div class="hisab-tab active" onclick="switchHisabTab('home')">Home</div>
                <div class="hisab-tab" onclick="switchHisabTab('daily')">Daily</div>
                <div class="hisab-tab" onclick="switchHisabTab('bank')">Bank</div>
                <div class="hisab-tab" onclick="switchHisabTab('goal')">Goal</div>
                <div class="hisab-tab" onclick="switchHisabTab('dps')">DPS</div>
            </div>
            
            <!-- HOME VIEW (UPDATED WITH PREMIUM CHART) -->
<div id="hisab-view-home" class="hisab-view active">
    <div class="fin-card" style="margin-top: 10px;">
        <div class="chart-container">
            <div class="donut-chart" id="hisab-donut-chart">
                <div class="donut-inner">
                    <span style="font-size: 0.65rem; color: #94a3b8; letter-spacing: 1px; font-weight: 600;">NET WORTH</span>
                    <h2 id="hisab-net-worth-text" style="margin: 0; font-size: 1.4rem; color: #fff;">৳ 0</h2>
                </div>
            </div>
        </div>

        <div class="fin-grid">
            <!-- Cash -->
            <div class="fin-item c-cash">
                <h4><i class="fas fa-hand-holding-usd t-cash"></i> Cash</h4>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="val" id="h-cash-val">৳ 0</span>
                    <span class="perc t-cash" id="h-cash-perc">0%</span>
                </div>
            </div>
            <!-- Bank -->
            <div class="fin-item c-bank">
                <h4><i class="fas fa-university t-bank"></i> Bank</h4>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="val" id="h-bank-val">৳ 0</span>
                    <span class="perc t-bank" id="h-bank-perc">0%</span>
                </div>
            </div>
            <!-- Goal -->
            <div class="fin-item c-goal">
                <h4><i class="fas fa-bullseye t-goal"></i> Goal</h4>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="val" id="h-goal-val">৳ 0</span>
                    <span class="perc t-goal" id="h-goal-perc">0%</span>
                </div>
            </div>
            <!-- DPS -->
            <div class="fin-item c-dps">
                <h4><i class="fas fa-piggy-bank t-dps"></i> DPS</h4>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="val" id="h-dps-val">৳ 0</span>
                    <span class="perc t-dps" id="h-dps-perc">0%</span>
                </div>
            </div>
        </div>
        <!-- BUDGET INSIGHTS (Donut Chart এর নিচেই এটা বসান) -->
<div class="glass-ui" style="margin-top: 20px; padding: 15px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="font-size: 0.85rem; font-weight: 600; color: #94a3b8;">Income vs Expense Ratio</span>
        <span id="budget-status-tag" style="font-size: 0.7rem; background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 2px 8px; border-radius: 20px; font-weight: bold;">HEALTHY</span>
    </div>
    
    <!-- Ratio Bar -->
    <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; display: flex; margin-bottom: 20px;">
        <div id="income-ratio-bar" style="height: 100%; background: #10B981; width: 0%; transition: width 1s ease-in-out;"></div>
        <div id="expense-ratio-bar" style="height: 100%; background: #e63946; width: 0%; transition: width 1s ease-in-out;"></div>
    </div>

    <!-- Quick Insights Grid -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; border-left: 3px solid #10B981;">
            <p style="font-size: 0.65rem; color: #94a3b8; margin: 0;">This Month Income</p>
            <h3 id="month-income-val" style="margin: 5px 0; color: #fff; font-size: 1rem;">৳ 0</h3>
        </div>
        <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; border-left: 3px solid #e63946;">
            <p style="font-size: 0.65rem; color: #94a3b8; margin: 0;">This Month Expense</p>
            <h3 id="month-expense-val" style="margin: 5px 0; color: #fff; font-size: 1rem;">৳ 0</h3>
        </div>
    </div>
</div>
<!-- FEATURE 4: RECENT TRANSACTIONS & GOAL PREVIEW -->
<div class="section-header" style="margin-top:20px; display: flex; justify-content: space-between; align-items: center;">
    <span><i class="fas fa-history"></i> Recent Activity</span>
    <span onclick="switchHisabTab('daily')" style="font-size: 0.7rem; color: var(--primary); cursor: pointer; text-transform: none; letter-spacing: 0;">View All</span>
</div>
<div id="quick-recent-list" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
    <!-- JS থেকে এখানে ডাটা আসবে -->
</div>

<!-- FEATURE 5: TOP GOAL COUNTDOWN -->
<div id="top-goal-preview" class="hisab-card goal" style="display:none; border-left: 4px solid var(--goal-color); background: rgba(234, 88, 12, 0.05);">
    <div class="row-between">
        <div>
            <span style="font-size: 0.7rem; color: var(--goal-color); font-weight: bold; text-transform: uppercase;">Top Savings Goal</span>
            <h3 id="top-goal-name" style="margin: 5px 0;">No Goal Set</h3>
            <p id="top-goal-remaining" style="font-size: 0.8rem; color: #aaa;">Remaining: ৳ 0</p>
        </div>
        <div style="text-align: right;">
            <h2 id="top-goal-percent" style="color: var(--goal-color); margin:0;">0%</h2>
        </div>
    </div>
    <div class="progress-bg" style="margin-top: 10px; height: 6px;">
        <div id="top-goal-bar" class="progress-fill" style="width: 0%;"></div>
    </div>
</div>


    </div>
</div>
            
            <!-- DAILY VIEW -->
            <div id="hisab-view-daily" class="hisab-view">
                <div class="action-row"><button class="section-btn btn-daily" onclick="openHisabModal('daily_entry')"><i class="fas fa-plus-circle"></i> Add Entry</button></div>
                <div id="daily-list"></div>
            </div>
            
            <!-- BANK VIEW -->
            <div id="hisab-view-bank" class="hisab-view">
                <div class="action-row"><button class="section-btn btn-bank" onclick="openHisabModal('new_bank')"><i class="fas fa-university"></i> New A/C</button></div>
                <div id="bank-list"></div>
            </div>
            
            <!-- GOAL VIEW -->
            <div id="hisab-view-goal" class="hisab-view">
                <div class="action-row"><button class="section-btn btn-goal" onclick="openHisabModal('new_goal')"><i class="fas fa-bullseye"></i> New Goal</button></div>
                <div id="goal-list"></div>
            </div>
            
            <!-- DPS VIEW -->
            <div id="hisab-view-dps" class="hisab-view">
                <div class="action-row"><button class="section-btn btn-dps" onclick="openHisabModal('new_dps')"><i class="fas fa-piggy-bank"></i> New DPS</button></div>
                <div id="dps-list"></div>
            </div>
        </div>
    </div>
    
    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav glass-ui">
        <a href="#" class="active" data-page="dashboard"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="#" data-page="search"><i class="fas fa-search"></i><span>Search</span></a>
        <a href="#" data-page="hisab"><i class="fas fa-calculator"></i><span>My Finance</span></a>
        <a href="#" data-page="add-info"><i class="fas fa-plus-circle"></i><span>Add Info</span></a>
        <a href="#" data-page="all-category-info"><i class="fas fa-list"></i><span>Info List</span></a>
        <a href="#" data-page="add-contact"><i class="fas fa-user-plus"></i><span>Add Cont.</span></a>
        <a href="#" data-page="all-contacts"><i class="fas fa-address-book"></i><span>Contacts</span></a>
    </nav>
</div>

<!-- INFO MODAL -->
<div class="modal" id="info-modal">
    <div class="modal-content glass-ui">
        <div class="modal-header" id="info-modal-header"></div>
        <div class="modal-body" id="info-modal-body" style="margin: 1.5rem 0; max-height: 60vh; overflow-y: auto;"></div>
        <div id="info-modal-footer"></div>
        <button class="btn" id="close-info-modal" style="margin-top:10px">Close</button>
    </div>
</div>

<!-- HISAB MODAL -->
<div class="modal" id="hisab-modal">
    <div class="modal-content glass-ui">
        <h3 id="hisab-modal-title" style="margin-bottom: 15px; color: var(--primary);">Add New</h3>
        <input type="hidden" id="hisab-modal-context">
        <div id="hisab-modal-inputs"></div>
        <button class="btn" style="margin-top: 15px;" onclick="submitHisabData()">Save</button>
        <button class="btn" style="background:none; border:none; margin-top:5px; color: #ccc;" onclick="document.getElementById('hisab-modal').style.display='none'">Cancel</button>
    </div>
</div>
    
    <!-- ABOUT MODAL -->
    <div class="modal" id="about-modal" style="z-index: 5000;">
        <div class="modal-content glass-ui" style="text-align: center; position: relative; overflow: hidden; max-width: 380px;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #21D4FD, #B721FF, #f72585);"></div>
            <button onclick="document.getElementById('about-modal').style.display='none'" style="position: absolute; top: 10px; right: 15px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h1 style="color: var(--primary); font-size: 26px; font-weight: 800; margin-top: 15px; margin-bottom: 5px;">All Info Zone</h1>
            <div style="background: rgba(33, 212, 253, 0.15); color: var(--primary); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; display: inline-block; margin-bottom: 20px; border: 1px solid var(--primary);">v5.6.4</div>
            <p style="color: #ccc; font-size: 14px; line-height: 1.5; margin-bottom: 25px; padding: 0 10px;">I personally developed this app to keep important information in one place easily and quickly.</p>
            <div style="background: rgba(255, 255, 255, 0.05); border: 1px dashed var(--border-color); padding: 10px; border-radius: 10px; font-size: 13px; color: #aaa; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fa-solid fa-code" style="color: var(--secondary);"></i><span>Developer: <strong style="color: white;">Me</strong> (Personal Project)</span>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <a href="https://www.facebook.com/piyashhasan.ph" target="_blank" style="text-decoration: none;"><button class="btn" style="background: linear-gradient(135deg, #1877F2, #104996); border: none; display: flex; align-items: center; justify-content: space-between; padding: 12px 20px;"><span style="display: flex; align-items: center; gap: 10px;"><i class="fab fa-facebook-f"></i> Facebook</span><i class="fas fa-chevron-right" style="font-size: 10px; opacity: 0.6;"></i></button></a>
                <a href="https://wa.me/+8801325428923" target="_blank" style="text-decoration: none;"><button class="btn" style="background: linear-gradient(135deg, #25D366, #0e5e54); border: none; display: flex; align-items: center; justify-content: space-between; padding: 12px 20px;"><span style="display: flex; align-items: center; gap: 10px;"><i class="fab fa-whatsapp"></i> WhatsApp</span><i class="fas fa-chevron-right" style="font-size: 10px; opacity: 0.6;"></i></button></a>
                <a href="https://t.me/piyashhasan_ph564" target="_blank" style="text-decoration: none;"><button class="btn" style="background: linear-gradient(135deg, #2AABEE, #187db3); border: none; display: flex; align-items: center; justify-content: space-between; padding: 12px 20px;"><span style="display: flex; align-items: center; gap: 10px;"><i class="fab fa-telegram-plane"></i> Telegram</span><i class="fas fa-chevron-right" style="font-size: 10px; opacity: 0.6;"></i></button></a>
            </div>
            <div style="margin-top: 30px; font-size: 12px; color: #666;">&copy; 2025 All Info Zone.</div>
        </div>
    </div>
    
    <div class="modal" id="update-modal" style="z-index: 3000; display: none !important;">
        <div class="modal-content glass-ui" style="text-align: center;">
            <i class="fas fa-rocket" style="font-size: 3rem; color: var(--secondary); margin-bottom: 15px;"></i>
            <h2 style="color: var(--primary);">Update Available!</h2>
            <p id="update-msg" style="margin: 10px 0; color: #ccc;">A new version of the app is available.</p>
            <p style="font-size: 0.8rem; color: gray;">Version: <span id="new-version-display"></span></p>
            <a id="update-link" href="#" target="_blank" style="text-decoration: none;"><button class="btn" style="background: var(--success); color: #000; margin-top: 15px;">Download Now <i class="fas fa-download"></i></button></a>
            <button class="btn" style="background: none; border: 1px solid var(--danger); margin-top: 10px; font-size: 0.8rem;" onclick="document.getElementById('update-modal').style.display='none'">Remind Me Later</button>
        </div>
    </div>
        <!-- TRAINING MODAL -->
    <div class="modal" id="training-modal" style="z-index: 4000;">
        <div class="modal-content glass-ui">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:10px;">
                <h3 style="color:var(--secondary); margin:0;"><i class="fas fa-brain"></i> AI Brain (Personal)</h3>
                <div>
                    <button class="btn" onclick="switchTrainView('form')" style="width:auto; padding:5px 10px; display:inline-block;" title="Add New"><i class="fas fa-plus"></i></button>
                    <button class="btn" onclick="switchTrainView('list')" style="width:auto; padding:5px 10px; display:inline-block; background:var(--primary); color:black;" title="History"><i class="fas fa-history"></i></button>
                    <button onclick="document.getElementById('training-modal').style.display='none'" style="background:none; border:none; color:white; font-size:1.2rem; margin-left:10px; cursor:pointer;">&times;</button>
                </div>
            </div>
            
            <div id="train-view-form">
                <input type="hidden" id="edit-train-id">
                <div class="form-group"><label>When I say... (Keyword)</label><input type="text" id="train-q" placeholder="e.g. kemon acho"></div>
                <div class="form-group"><label>Bot replies...</label><textarea id="train-a" placeholder="e.g. Ami valo achi boss" rows="3"></textarea></div>
                <button class="btn" onclick="saveTraining()" id="train-save-btn">Save Lesson</button>
            </div>
            <div id="train-view-list" style="display:none;">
                <input type="text" id="train-search" placeholder="Search history..." onkeyup="filterTraining()" style="margin-bottom:10px; padding:10px; width:100%; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white;">
                <div id="training-list-container" style="max-height: 250px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    <!-- MODERN PIN RESET MODAL -->
<div class="modal" id="pin-reset-modal" style="z-index: 25000;">
    <div class="modal-content glass-ui" style="text-align: center; max-width: 350px; border: 1px solid var(--primary);">
        <i class="fas fa-user-lock" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px; text-shadow: 0 0 15px var(--primary);"></i>
        <h3 style="color: white; margin-bottom: 10px;">Security Check</h3>
        <p style="font-size: 0.85rem; color: #ccc; margin-bottom: 20px;">Reset PIN lock with your main login password:</p>
        
        <input type="password" id="master-pass-input" placeholder="Enter Login Password" 
               style="text-align: center; border-color: var(--primary); background: rgba(0,0,0,0.3); margin-bottom: 15px;">
        
        <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="executePinReset()" style="background: var(--primary); color: black; flex: 1; font-weight: bold;">RESET PIN</button>
            <button class="btn" onclick="document.getElementById('pin-reset-modal').style.display='none'" style="background: rgba(255,255,255,0.1); flex: 1;">CANCEL</button>
        </div>
        <div id="reset-error-msg" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px;"></div>
    </div>
</div>
 <!-- MODERN SHARE PASSWORD MODAL (Lines 471+) -->
<div class="modal" id="share-pass-modal" style="z-index: 26000;">
    <div class="modal-content glass-ui" style="text-align: center; max-width: 380px; border: 1px solid var(--primary); position: relative;">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--primary), var(--secondary));"></div>
        <i class="fas fa-share-nodes" style="font-size: 2.8rem; color: var(--primary); margin-bottom: 20px; text-shadow: 0 0 15px var(--primary);"></i>
        <h3 style="color: white; margin-bottom: 10px;">Secure Sharing</h3>
        <p style="font-size: 0.85rem; color: #aaa; margin-bottom: 20px;">If you want to set a password for this link, enter the following (optional):</p>
        <input type="text" id="set-share-password" placeholder="Password (Optional)" 
               style="text-align: center; border-color: var(--primary); background: rgba(0,0,0,0.3); margin-bottom: 20px;">
        <div style="display: flex; gap: 10px;">
            <button class="btn" id="final-share-btn" style="background: var(--primary); color: black; flex: 1; font-weight: bold;">GENERATE LINK</button>
            <button class="btn" onclick="document.getElementById('share-pass-modal').style.display='none'" style="background: rgba(255,255,255,0.1); flex: 1;">CANCEL</button>
        </div>
    </div>
</div>

    <!-- NEW SETTINGS MODAL -->
    <div class="modal" id="settings-modal" style="z-index: 4500;">
        <div class="modal-content glass-ui">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:10px;">
                <h3 style="color:var(--primary); margin:0;"><i class="fas fa-cogs"></i> Command Settings</h3>
                <button onclick="document.getElementById('settings-modal').style.display='none'; document.getElementById('protected-security-panel').style.display = 'none'; document.getElementById('security-unlock-section').style.display = 'block';" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            
            <!-- কাস্টম কমান্ড সেটিংস সেকশন -->
<div style="margin-bottom: 15px;">
    <h4 style="color:var(--primary); margin-bottom: 10px;"><i class="fas fa-terminal"></i> Custom Commands</h4>
    <p style="font-size:0.8rem; color:#ccc;">Set your own commands for the bot:</p>
    <div class="form-group" style="margin-top:10px;">
        <label>Select Logic</label>
        <select id="setting-logic-select">
            <option value="">-- Choose Logic --</option>
            <option value="ADD_INCOME">1. Income Add (+)</option>
            <option value="ADD_EXPENSE">2. Expense Add (-)</option>
            <option value="VIEW_BALANCE">3. View Total Balance</option>
            <option value="VIEW_HISTORY">4. View History</option>
            <option value="NEW_BANK">5. New Bank A/C</option>
            <option value="DEPOSIT_BANK">6. Deposit to Bank</option>
            <option value="WITHDRAW_BANK">7. Withdraw from Bank</option>
            <option value="BANK_LIST">8. Bank List</option>
            <option value="NEW_GOAL">9. New Goal</option>
            <option value="SAVE_GOAL">10. Save to Goal</option>
            <option value="GOAL_LIST">11. Goal List</option>
            <option value="NEW_DPS">12. New DPS</option>
            <option value="PAY_DPS">13. Pay DPS Monthly</option>
            <option value="DPS_LIST">14. DPS List</option>
            <option value="ADD_CONTACT">15. Add Contact</option>
            <option value="SEARCH_CONTACT">16. Search Contact</option>
            <option value="ADD_LINK">17. Add Link Info</option>
            <option value="ADD_INFO">18. Add Text Info</option>
            <option value="SEARCH_ALL">19. General Search</option>
            <option value="TRAIN_ON">20. Open Training (Silent)</option>
            <option value="OPEN_SETTINGS">21. Open Settings (Silent)</option>
            <option value="ADD_PHOTO">22. Add/Upload Photo</option>
            <option value="ADD_VIDEO">23. Add/Upload Video</option>
            <option value="ADD_AUDIO">24. Add/Upload Audio</option>
            <option value="ADD_FILE">25. Add/Upload File</option>
        </select>
    </div>
    <div class="form-group">
        <label>Your Custom Command</label>
        <input type="text" id="setting-custom-cmd" placeholder="e.g. taka aslo">
    </div>
    <button class="btn" onclick="saveCommandSetting()">Set Command</button>
</div>

<h4 style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">Active Commands</h4>
<div id="settings-list-container" style="max-height: 200px; overflow-y: auto; margin-top: 10px;"></div>
            
            <!-- SECURITY SETTINGS SECTION (UPDATED) -->
<div class="form-group" style="border-top:1px solid rgba(255,255,255,0.1); margin-top:20px; padding-top:15px;">
    <h4 style="color:var(--secondary); margin-bottom:10px;"><i class="fas fa-shield-halved"></i> Security Settings</h4>
    
    <!-- শুরুতে শুধু এই বাটনটি দেখা যাবে -->
    <div id="security-unlock-section" style="text-align: center; padding: 10px;">
        <p style="font-size: 0.75rem; color: #aaa; margin-bottom: 10px;">Verification required to access security panel.</p>
        <button class="btn" onclick="openSecurityAuthModal()" style="background: rgba(183, 33, 255, 0.2); color: var(--secondary); border: 1px solid var(--secondary); width: auto; padding: 8px 20px;">
            <i class="fas fa-lock"></i> UNLOCK PANEL
        </button>
    </div>

    <!-- এই অংশটি পাসওয়ার্ড দেওয়ার আগে লুকানো থাকবে -->
    <div id="protected-security-panel" style="display: none; animation: fadeIn 0.5s;">
        <label style="font-size:0.8rem;">Select Lock Type</label>
        <select id="lock-type-select" style="margin-bottom: 10px;" onchange="updateLockPlaceholder()">
            <option value="pin">Numeric PIN (4-11 Digits)</option>
            <option value="pass">Password (6-11 Chars)</option>
        </select>

        <label style="font-size:0.8rem;">Set New Value</label>
        <input type="password" id="new-app-lock" placeholder="Enter PIN (Digits only)">
        
        <div style="display:flex; gap:10px; margin-top:5px;">
            <button class="btn" onclick="saveAppLockSettings()" style="background:var(--success); flex:1;">Save Lock</button>
            <button class="btn" id="toggle-biometric-btn" onclick="toggleBiometric()" style="background:#444; flex:1; font-size:0.7rem;">Fingerprint: OFF</button>
        </div>
    </div>
    <!-- AUTO LOCK SWITCH -->
<div style="margin-top: 15px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1);">
    <div>
        <span style="font-size: 0.9rem; color: #fff; font-weight: 600;">Auto Lock on Exit</span>
        <br>
        <small style="font-size: 0.7rem; color: #aaa;">Lock when minimized</small>
    </div>
    <!-- সুইচ আইকন -->
    <i id="auto-lock-icon" class="fas fa-toggle-on" onclick="toggleAutoLockSetting()" style="font-size: 1.8rem; color: var(--success); cursor: pointer;"></i>
</div>
</div>
<!-- PROFESSIONAL API PORTAL (REFINED) -->
<div class="form-group" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; padding-top: 15px;">
    <h4 style="color: #60cdff; margin-bottom: 15px;"><i class="fas fa-shield-halved"></i> Pro API Secure Portal</h4>
    
    <!-- মূল বাটন যা শুধু পোর্টাল ওপেন করবে -->
    <button class="btn" id="pro-view-btn" onclick="toggleApiPortal()" style="background: rgba(0, 120, 212, 0.2); color: #60cdff; border: 1px solid #0078d4;">
        <i class="fas fa-eye"></i> SEE API ACCESS
    </button>
    
    <div id="api-main-container" style="display: none; margin-top: 15px;">
        <label style="font-size: 0.7rem; color: #00ff88; margin-bottom: 5px; display: block;">SECRET API KEY (Double click to copy)</label>
        <div class="api-item-box" onclick="handleApiInteraction('key')">
            <i class="fas fa-key" style="color: #00ff88;"></i>
            <span id="pro-api-key-text" class="scramble-text"></span>
        </div>
        
        <label style="font-size: 0.7rem; color: #60cdff; margin-top: 12px; margin-bottom: 5px; display: block;">ENDPOINT URL (Double click to copy)</label>
        <div class="api-item-box" onclick="handleApiInteraction('url')">
            <i class="fas fa-link" style="color: #60cdff;"></i>
            <span id="pro-api-url-text" class="scramble-text"></span>
        </div>

        <!-- এপিআই রিসেট বা নতুন জেনারেট বাটন এখন ভেতরে থাকবে -->
        <button class="btn" onclick="generateProfessionalApi()" style="background: none; color: #e63946; margin-top: 20px; border: 1px dashed #e63946; font-size: 0.8rem; padding: 8px;">
            <i class="fas fa-sync-alt"></i> RESET & GENERATE NEW API
        </button>
    </div>
</div>

            <!-- THEME STORE SECTION IN SETTINGS -->
            <div class="form-group" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; padding-top: 10px;">
                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-layer-group"></i> My Theme Store</h4>
                <input type="file" id="theme-upload-input" accept=".html,.txt" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
    <!-- নিচে 'font-size' এবং 'white-space' যোগ করা হয়েছে যাতে লেখা নিচে না নামে -->
    <button class="btn" onclick="document.getElementById('theme-upload-input').click()" style="background: linear-gradient(90deg, #00C6FF, #0072FF); flex: 1; font-size: 0.75rem; white-space: nowrap; padding: 12px 5px;">
        <i class="fas fa-plus-circle"></i> IMPORT THEME
    </button>
    <button class="btn" onclick="resetToDefaultTheme()" style="background: #333; flex: 1; font-size: 0.75rem; white-space: nowrap; padding: 12px 5px;">
        <i class="fas fa-undo"></i> USE DEFAULT
    </button>
</div>
                <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px;">Saved Themes:</p>
                <div id="theme-store-list" style="max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; border: 1px solid rgba(255,255,255,0.1); padding: 5px; border-radius: 8px;"></div>
            </div>
        </div>
    </div>
    <!-- API SETTINGS MODAL -->
<div class="modal" id="api-settings-modal" style="z-index: 7000;">
    <div class="modal-content glass-ui">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:10px;">
            <h3 style="color:var(--primary); margin:0;"><i class="fas fa-server"></i> API Configuration</h3>
            <button onclick="document.getElementById('api-settings-modal').style.display='none'" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">&times;</button>
        </div>
        
        <div id="api-view-mode">
            <p style="font-size:0.8rem; color:#aaa;">Current Telegram Settings:</p>
            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-bottom:15px;">
                <small>Token:</small> <div id="display-bot-token" style="word-break:break-all; color:var(--secondary);">Loading...</div>
                <small>Chat ID:</small> <div id="display-chat-id" style="color:var(--success);">Loading...</div>
            </div>
            <button class="btn" onclick="requestAuthForApi()"><i class="fas fa-edit"></i> Edit API Info</button>
        </div>

        <div id="api-edit-mode" style="display: none;">
            <div class="form-group">
                <label>Telegram Bot Token</label>
                <input type="text" id="new-bot-token" placeholder="Enter Token">
            </div>
            <div class="form-group">
                <label>Telegram Chat ID</label>
                <input type="text" id="new-chat-id" placeholder="Enter Chat ID">
            </div>
            <button class="btn" onclick="saveApiSettings()" style="background:var(--success);">Update & Save</button>
            <button class="btn" onclick="closeApiEdit()" style="background:none; border:none; color:#ccc;">Cancel</button>
        </div>
    </div>
</div>
<!-- মডার্ন এপিআই পিন বক্স -->
<div class="modal" id="api-auth-modal" style="z-index: 8000;">
    <div class="modal-content glass-ui" style="text-align: center; max-width: 350px;">
        <i class="fas fa-shield-alt" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 15px;"></i>
        <h3 style="color: white; margin-bottom: 10px;">Security Check</h3>
        <p style="font-size: 0.85rem; color: #ccc; margin-bottom: 20px;">Enter PIN to change API:</p>
        
        <input type="password" id="api-auth-input" placeholder="••••" 
       inputmode="numeric" 
       pattern="[0-9]*"
       style="text-align: center; font-size: 1.5rem; letter-spacing: 5px; background: rgba(0,0,0,0.3);">
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="btn" onclick="verifyApiAuth()" style="background: var(--primary); color: black; flex: 1; font-weight: bold;">OK</button>
            <button class="btn" onclick="document.getElementById('api-auth-modal').style.display='none'" style="background: rgba(255,255,255,0.1); flex: 1;">CANCEL</button>
        </div>
    </div>
</div>
<!-- SECURITY AUTH MODAL (Login Password check) -->
<div class="modal" id="security-login-modal" style="z-index: 9000;">
    <div class="modal-content glass-ui" style="text-align: center; max-width: 350px;">
        <i class="fas fa-user-check" style="font-size: 2.5rem; color: var(--secondary); margin-bottom: 15px;"></i>
        <h3 style="color: white; margin-bottom: 10px;">Identity Verification</h3>
        <p style="font-size: 0.85rem; color: #ccc; margin-bottom: 20px;">Enter your main Login Password to continue:</p>
        
        <input type="password" id="security-master-pass" placeholder="Enter Login Password" 
               style="text-align: center; border-color: var(--secondary); background: rgba(0,0,0,0.3);">
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="btn" id="verify-sec-btn" onclick="verifySecurityAccess()" style="background: var(--secondary); color: white; flex: 1; font-weight: bold;">VERIFY</button>
            <button class="btn" onclick="document.getElementById('security-login-modal').style.display='none'" style="background: rgba(255,255,255,0.1); flex: 1;">CANCEL</button>
        </div>
    </div>
</div>
<!-- MOANA TOOLS MODAL (Fixed Box Visibility) -->
<div class="modal" id="moana-tools-modal" style="z-index: 6000; display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center;">
    <div class="modal-content" style="background: #ffffff; color: #333; border: 4px solid #f4d03f; border-radius: 25px; max-width: 480px; width: 92%; padding: 25px; position: relative; box-shadow: 0 15px 35px rgba(0,0,0,0.4);">
        
        <!-- Close Button -->
        <button onclick="document.getElementById('moana-tools-modal').style.display='none'" style="position:absolute; top:15px; right:20px; background:none; border:none; color:#333; font-size:1.8rem; cursor:pointer;">&times;</button>

        <!-- Tab Menu -->
        <div style="display: flex; background: #e0f7fa; padding: 5px; border-radius: 50px; margin-bottom: 25px; border: 2px solid #0077be;">
            <button id="moana-tab-1" class="tab-btn active" onclick="switchMoanaTab('word')" style="flex:1; border-radius: 50px; border:none; padding:12px; cursor:pointer; font-weight:bold; background:#0077be; color:white; transition: 0.3s;">Word Count</button>
            <button id="moana-tab-2" class="tab-btn" onclick="switchMoanaTab('email')" style="flex:1; border-radius: 50px; border:none; padding:12px; cursor:pointer; font-weight:bold; background:none; color:#005662; transition: 0.3s;">Email Tools</button>
        </div>

        <!-- 1. Word Counter Section -->
        <div id="moana-word-sec">
            <h2 style="color: #0077be; margin-bottom: 15px; font-size: 22px;">🌊 Word Counter</h2>
            
            <label style="display:block; font-size:14px; font-weight:bold; margin-bottom:5px; color:#1d2b64;">Input Text:</label>
            <textarea id="moana-text-input" rows="6" placeholder="Paste or type your text here..." 
                style="width: 100%; padding: 15px; border: 2px solid #0077be !important; border-radius: 15px; background: #f0faff !important; color: #000 !important; font-size: 15px; outline: none; margin-bottom: 15px; box-sizing: border-box; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); height: 150px !important;"></textarea>
            
            <div style="display:flex; justify-content:space-around; background:#e0f2f1; padding:15px; border-radius:15px; margin-bottom:15px; border: 2px solid #b2ebf2;">
                <div style="text-align:center;"><b id="m-word-count" style="color:#0077be; font-size:24px; display:block;">0</b><span style="font-size:12px; color:#555; font-weight:bold;">WORDS</span></div>
                <div style="text-align:center;"><b id="m-char-count" style="color:#0077be; font-size:24px; display:block;">0</b><span style="font-size:12px; color:#555; font-weight:bold;">CHARS</span></div>
            </div>
            
            <button class="btn" style="background:#ff6b6b; color:white; border:none; width:100%; padding: 14px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 4px 10px rgba(255,107,107,0.3);" onclick="clearMoanaText()">Clear All Text</button>
        </div>

        <!-- 2. Email Tools Section -->
        <div id="moana-email-sec" style="display:none;">
            <h2 style="color: #0077be; margin-bottom: 15px; font-size: 22px;">🌴 Email Scanner & Joiner</h2>
            
            <div style="background: #fff9c4; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #fbc02d;">
                <label style="display:block; font-size:13px; font-weight:bold; margin-bottom:8px; color:#333;">📷 Extract Emails from Image:</label>
                <input type="file" id="moana-img-input" accept="image/*" onchange="moanaScanImage()" style="width:100%; background: #fff; padding: 5px; border-radius: 8px; color: #333;">
            </div>
            
            <label style="display:block; font-size:14px; font-weight:bold; margin-bottom:5px; color:#1d2b64;">Email List:</label>
            <textarea id="moana-email-list" rows="3" placeholder="Paste emails here..." 
                style="width: 100%; padding: 12px; border: 2px solid #0077be !important; border-radius: 12px; background: #f0faff !important; color: #000 !important; font-size: 14px; outline: none; margin-bottom: 15px; box-sizing: border-box; height: 100px !important;"></textarea>
            
            <label style="display:block; font-size:14px; font-weight:bold; margin-bottom:5px; color:#1d2b64;">Set Password:</label>
            <input type="text" id="moana-pass-input" placeholder="e.g., 123456" 
                style="width: 100%; padding: 12px; border: 2px solid #0077be !important; border-radius: 12px; background: #f0faff !important; color: #000 !important; font-size: 14px; outline: none; margin-bottom: 15px; box-sizing: border-box; height: 50px !important;">
            
            <button class="btn" style="background:#0077be; color:white; border:none; width:100%; padding: 14px; border-radius: 12px; font-weight: bold; font-size: 16px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,119,190,0.3);" onclick="moanaGenerate()">Generate Format ✨</button>
            
            <label style="display:block; font-size:14px; font-weight:bold; margin-bottom:5px; color:#1d2b64;">Final Output:</label>
            <textarea id="moana-output" rows="3" readonly 
                style="width: 100%; padding: 12px; border: 2px solid #455a64 !important; border-radius: 12px; background: #eceff1 !important; color: #000 !important; font-size: 14px; outline: none; margin-bottom: 15px; box-sizing: border-box; height: 100px !important;"></textarea>
            
            <button class="btn" style="background:#546e7a; color:white; border:none; width:100%; padding: 14px; border-radius: 12px; font-weight: bold;" onclick="moanaCopy()">📋 Copy Result</button>
        </div>
    </div>
</div>
<!-- UPDATED UNIVERSAL PREVIEWER (With Expiry & Short Link Support) -->
<div id="public-share-view" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at top, #1d2b64, #000000); z-index:40000; overflow-y:auto; padding:20px; font-family: 'Poppins', sans-serif; color: white;">
    <div class="glass-ui" style="max-width:600px; margin: 40px auto; padding:35px; border:1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; position: relative;">
        
        <!-- ১. লিঙ্ক এক্সপায়ার স্ক্রিন (অটোমেটিক দেখাবে যদি সময় শেষ হয়) -->
        <div id="expire-screen" style="display:none; text-align:center; padding:40px 20px;">
            <i class="fas fa-hourglass-end fa-4x" style="color:var(--danger); margin-bottom:25px; opacity:0.8;"></i>
            <h2 style="color:white; margin-bottom:15px;">Link Expired!</h2>
            <p style="color:#aaa; font-size:0.9rem; line-height:1.6;">Sorry, this link has expired in 24 hours. Please contact the admin for a new link.</p>
        </div>

        <!-- ২. পাসওয়ার্ড প্রোটেকশন স্ক্রিন -->
        <div id="password-screen" style="display:none; text-align:center; padding:20px;">
            <i class="fas fa-lock fa-3x" style="color:var(--primary); margin-bottom:20px;"></i>
            <h3 style="margin-bottom:10px;">Locked Content</h3>
            <p style="font-size:0.8rem; color:#aaa; margin-bottom:20px;">A password is required to view this.</p>
            <input type="password" id="share-pass-input" placeholder="Password" style="text-align:center; border:1px solid var(--primary); margin-bottom:15px; background:rgba(255,255,255,0.05); color:white; border-radius:10px; padding:12px; width:85%;">
            <button class="btn" onclick="verifySharePassword()" style="background:var(--primary); color:black; font-weight:bold; width:auto; padding:10px 30px;">Unlock Now</button>
        </div>

        <!-- ৩. মেইন কন্টেন্ট এরিয়া -->
        <div id="share-content-area" style="display:none;">
            <div style="text-align:center; padding:50px;">
                <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary);"></i>
                <p style="margin-top:15px;">Loading Data...</p>
            </div>
        </div>
    </div>
</div>
<!-- FLOATING BACK BUTTON -->
<div id="back-button-trigger" class="glass-ui">
    <i class="fas fa-chevron-left"></i>
</div>
<!-- FLOATING MUSIC BUTTON WITH EQUALIZER -->
<div id="music-button-trigger" class="glass-ui">
    <!-- আইকন (যখন গান বন্ধ থাকবে) -->
    <i class="fas fa-music" id="music-btn-icon"></i>
    
    <!-- ইকুলাইজার বার (যখন গান বাজবে) -->
    <div class="equalizer">
        <span class="bar bar1"></span>
        <span class="bar bar2"></span>
        <span class="bar bar3"></span>
        <span class="bar bar4"></span>
        <span class="bar bar5"></span>
        <span class="bar bar6"></span>
    </div>
</div>
    <!-- AI CHAT BOT WIDGET -->
  <button id="chatbot-trigger">
    <!-- এটি চিরস্থায়ী SVG রোবট -->
    <svg viewBox="0 0 100 100" class="svg-bot">
        <!-- Outer Glow Circle -->
        <circle cx="50" cy="50" r="45" class="bot-glow" />
        <!-- Robot Body Group -->
        <g class="bot-moving-part">
            <!-- Antenna -->
            <line x1="50" y1="30" x2="50" y2="15" stroke="#21D4FD" stroke-width="3" />
            <circle cx="50" cy="12" r="5" fill="#21D4FD" />
            <!-- Head (Purple) -->
            <rect x="25" y="30" width="50" height="40" rx="15" fill="#B721FF" />
            <!-- Eyes (Blinking) -->
            <circle class="bot-eye" cx="40" cy="48" r="4" fill="white" />
            <circle class="bot-eye" cx="60" cy="48" r="4" fill="white" />
            <!-- Smile -->
            <path d="M40 60 Q50 65 60 60" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" />
        </g>
    </svg>
</button>
    <div id="chatbot-container" class="glass-ui">
        <div class="chat-header"><span><i class="fas fa-robot"></i> Smart Assistant</span><button id="close-chat"><i class="fas fa-times"></i></button></div>
        <div class="chat-messages" id="chat-messages"><div class="message bot">Hello Boss! How Are You? </div></div>
        <div class="chat-input-area">
            <button id="chat-img-btn"><i class="fas fa-image"></i></button>
            <input type="text" id="chat-input" placeholder="Ask me anything...">
            <button id="chat-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
        <input type="file" id="chat-file-input" accept="image/*" style="display: none;">
    </div>
<!-- Custom Confirm Modal -->
<div id="custom-confirm-overlay">
    <div id="custom-confirm-box">
        <p id="confirm-msg">Are you sure?</p>
        <div class="confirm-btns">
            <button class="confirm-btn btn-no" onclick="closeConfirm(false)">CANCEL</button>
            <button class="confirm-btn btn-yes" onclick="closeConfirm(true)">OK</button>
        </div>
    </div>
</div>

<!-- SESSION MANAGER / LOGOUT MODAL -->
<div class="modal" id="logout-manager-modal" style="z-index: 10000;">
    <div class="modal-content glass-ui" style="max-width: 450px; text-align: left;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
            <h3 style="color:var(--primary); margin:0;"><i class="fas fa-laptop-house"></i> Active Sessions</h3>
            <button onclick="document.getElementById('logout-manager-modal').style.display='none'" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">&times;</button>
        </div>

        <p style="font-size:0.8rem; color:#aaa; margin-bottom:15px;">Logged in as: <span id="session-user-email" style="color:white; font-weight:bold;"></span></p>

        <!-- DEVICE LIST CONTAINER -->
        <div id="device-list-container" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px;">
            <!-- লিস্ট জাভাস্ক্রিপ্ট দিয়ে আসবে -->
            <div style="text-align:center; color:#666;">Loading devices...</div>
        </div>

        <!-- ACTIONS -->
        <div style="display: flex; flex-direction: column; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <button class="btn" onclick="logoutAllDevices()" style="background: rgba(239, 68, 68, 0.2); color: #EF4444; border: 1px solid #EF4444;">
                <i class="fas fa-power-off"></i> LOGOUT FROM ALL DEVICES
            </button>
            <button class="btn" onclick="logoutCurrentDeviceOnly()" style="background: var(--primary); color: black; font-weight: bold;">
                <i class="fas fa-sign-out-alt"></i> LOGOUT THIS DEVICE
            </button>
        </div>
    </div>
</div>
<!-- PROFESSIONAL MUSIC PLAYER MODAL (UPDATED) -->
<div class="modal" id="global-music-modal" style="z-index: 7000;">
    <div class="modal-content glass-ui" style="max-width: 400px; padding: 25px; position: relative;">
        
        

        <!-- Header -->
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <!-- Close Button -->
    <button onclick="document.getElementById('global-music-modal').style.display='none'" style="background:none; border:none; color:#ccc; cursor:pointer;">
        <i class="fas fa-chevron-down"></i>
    </button>

    <!-- Title -->
    <h4 style="color:var(--text-light); margin:0; letter-spacing:1px;">NOW PLAYING</h4>
    
    <!-- Empty div for layout balance (যাতে টাইটেল মাঝখানে থাকে) -->
    <div style="width: 20px;"></div>
</div>

        <!-- Visual Art -->
        <div class="music-cover-art">
            <i class="fas fa-music" style="font-size: 3.5rem; color: white;"></i>
        </div>

        <!-- Title Info -->
        <div style="text-align:center; margin-bottom: 20px;">
            <h3 id="pro-track-title" style="color:white; margin-bottom:5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Select a Song</h3>
            <p style="color:#aaa; font-size:0.8rem;">Audio Library</p>
        </div>

        <!-- Progress Bar (Touch Enabled) -->
        <div class="progress-area" id="pro-progress-area">
            <div class="progress-bar">
                <div id="pro-progress-fill" class="progress-fill"></div>
            </div>
            <div class="time-row">
            <span id="pro-curr-time">0:00</span>
            <span id="pro-dur-time">0:00</span>
        </div>
        </div>

        <!-- Controls -->
        <div class="pro-player-controls">
            <button class="ctrl-btn" onclick="prevTrack()"><i class="fas fa-step-backward"></i></button>
            <button class="ctrl-btn play-pause-btn" onclick="togglePlayPause()">
                <i class="fas fa-play" id="pro-play-icon"></i>
            </button>
            <button class="ctrl-btn" onclick="nextTrack()"><i class="fas fa-step-forward"></i></button>
        </div>
        
        <audio id="global-audio-player"></audio>

        <h5 style="color: var(--primary); margin-top: 20px; margin-bottom: 10px;">Up Next</h5>
        <div id="music-playlist-container" class="music-list-container"></div>
    </div>
</div>
   <div id="reader" style="display:none;"></div>
    <input type="file" id="qr-file-input" accept="image/*" style="display: none;">

    <!-- Firebase & JS -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
     
<script>
    let auth, db; 
    let customBotData = [];
let currentSharedData = null;
    document.addEventListener('DOMContentLoaded', function() {
        const firebaseConfig = {
            apiKey: "AIzaSyAXSLgGP_fEOblHAqf1bGU5ENkUckmPnm4",
            authDomain: "all-info-f4fd6.firebaseapp.com",
            projectId: "all-info-f4fd6",
            storageBucket: "all-info-f4fd6.firebasestorage.app",
            messagingSenderId: "622193874862",
            appId: "1:622193874862:web:aff830d0cfa9b93b875a3f"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        auth = firebase.auth(); db = firebase.firestore();
        
        // ১. সিকিউরিটি ভেরিফিকেশন মোডাল ওপেন করা
window.openSecurityAuthModal = function() {
    console.log("Opening Security Auth Modal...");
    const masterPassInput = document.getElementById('security-master-pass');
    const authModal = document.getElementById('security-login-modal');
    
    if (authModal) {
        masterPassInput.value = '';
        authModal.style.display = 'flex';
        masterPassInput.focus();
    } else {
        console.error("Modal 'security-login-modal' not found!");
    }
};

// ২. মেইন লগইন পাসওয়ার্ড দিয়ে ভেরিফাই করা
window.verifySecurityAccess = async function() {
    console.log("Verifying Identity...");
    const user = firebase.auth().currentUser; // সরাসরি firebase.auth() ব্যবহার করা নিরাপদ
    const password = document.getElementById('security-master-pass').value;
    const btn = document.getElementById('verify-sec-btn');

    if (!user) {
        alert("User not logged in!");
        return;
    }

    if (!password) {
        alert("Please enter your login password!");
        return;
    }

    const originalBtnText = btn.innerText;
    btn.innerText = "Checking...";
    btn.disabled = true;

    try {
        // Firebase re-authentication logic
        const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
        await user.reauthenticateWithCredential(credential);

        // ভেরিফিকেশন সফল হলে প্যানেল আনলক করা
        document.getElementById('security-login-modal').style.display = 'none';
        document.getElementById('security-unlock-section').style.display = 'none';
        document.getElementById('protected-security-panel').style.display = 'block';
        
        alert("Access Granted! Security panel is now open. ✅");
    } catch (error) {
        console.error("Auth Error:", error);
        alert("Wrong Login Password! Identity could not be verified. ❌");
    } finally {
        btn.innerText = originalBtnText;
        btn.disabled = false;
    }
};

        const CURRENT_APP_VERSION = "5.6.4"; 
        let TG_BOT_TOKEN = ""; 
        let TG_CHAT_ID = "";
 
        let dailyData = [], bankData = [], goalData = [], dpsData = [], allInformation = [], allContacts = [];
        let categories = [{ name: 'Text Info', value: 'text' }, { name: 'Link Info', value: 'link' }, { name: 'Mail Info', value: 'mail' }, { name: 'Photo', value: 'photo' }, { name: 'Video', value: 'video' }, { name: 'Audio', value: 'audio' }, { name: 'File', value: 'file' }];
        let editingDocId = null; 
let customSettings = [];
        const loginPage = document.getElementById('login-page'); const adminPanel = document.getElementById('admin-panel'); const loginForm = document.getElementById('login-form'); const loginEmail = document.getElementById('login-email'); const loginPassword = document.getElementById('login-password'); const loginError = document.getElementById('login-error'); const logoutButton = document.getElementById('logout-button'); const navLinks = document.querySelectorAll('.bottom-nav a'); const pageContents = document.querySelectorAll('.page-content');
        
        // FINGERPRINT LOGIC (FOR KODULAR)
const fingerprintBtn = document.getElementById('fingerprint-btn');
// বাটনটি সব সময় দেখানোর জন্য
fingerprintBtn.style.display = 'inline-block'; 
document.getElementById('fingerprint-text').style.display = 'block';

fingerprintBtn.addEventListener('click', function() {
    if (window.AppInventor) {
        window.AppInventor.setWebViewString("SCAN_FINGERPRINT");
    } else {
        alert("Does not support fingerprints.");
    }
});

        auth.onAuthStateChanged(user => {
    const loader = document.getElementById('loading-screen');
    const chatbot = document.getElementById('chatbot-trigger');
    const backBtn = document.getElementById('back-button-trigger');
const musicBtn = document.getElementById('music-button-trigger');
if(musicBtn) musicBtn.style.setProperty('display', 'flex', 'important');
    if (user) { 
        showAdminPanel(user); 
        fetchDataFromFirestore(); 
        fetchAppLockSettings(); 
        fetchApiSettings(); 
        fetchCommandSettings(); 
        fetchBotTrainingData(); 

        // ============================================================
        //  NEW ADDITION: SESSION LISTENER (ধাপ ৫ - গোয়েন্দা)
        // ============================================================
        const myDeviceId = localStorage.getItem('my_device_id');

        if (myDeviceId) {
            // ডাটাবেসে আমার ডিভাইসের ফাইলের দিকে তাকিয়ে থাকা
            db.collection('users').doc(user.uid).collection('sessions').doc(myDeviceId)
            .onSnapshot((doc) => {
                // যদি ফাইলটি না পাওয়া যায় (মানে অন্য কেউ ডিলিট করে দিয়েছে)
                if (!doc.exists) {
                    console.log("Session kicked out remotely!");
                    
                    // সাথে সাথে লগআউট করে দেওয়া
                    auth.signOut().then(() => {
                        alert("Alert: You have been logged out from another device!");
                        location.reload();
                    });
                }
            });
        }
        // ============================================================

    } else { 
        showLoginPage(); 
    }

    if(loader) { 
        setTimeout(() => { 
            loader.style.opacity = '0'; 
            setTimeout(() => { 
                loader.style.display = 'none'; 
                
                // শুধুমাত্র লোডিং স্ক্রিন পুরোপুরি গায়েব হওয়ার পর বাটনগুলো দেখাবে
                if (user) {
                    if(chatbot) chatbot.style.setProperty('display', 'flex', 'important');
                    if(backBtn) backBtn.style.setProperty('display', 'flex', 'important');
                }
            }, 500); 
        }, 1500); 
    }
});

        // ১. ডিভাইসের নাম বের করার ফাংশন
function getDeviceName() {
    // ১. Kodular অ্যাপ থেকে ডাটা আসছে কিনা চেক করা
    // Kodular এ আমরা 'WebViewString' এর মাধ্যমে ফোনের নাম পাঠাবো
    if (window.AppInventor && window.AppInventor.getWebViewString()) {
        const appData = window.AppInventor.getWebViewString();
        
        // অ্যাপ থেকে আসা ডাটা যদি কোনো কমান্ড না হয় (যেমন SCAN_FINGERPRINT), তবেই এটি নাম হিসেবে নেব
        if (appData && !appData.includes("SCAN_") && appData.length > 2) {
            return appData; // অ্যাপ থেকে পাওয়া সঠিক নাম (যেমন: Vivo Y20)
        }
    }

    // ২. যদি অ্যাপ না হয় (মানে সাধারণ ব্রাউজার), তবে নিচের লজিক চলবে
    const ua = navigator.userAgent;
    let deviceName = "Unknown Device";

    if (/Android/.test(ua)) {
        // ব্রাউজার থেকে মডেল বের করার চেষ্টা
        const match = ua.match(/;\s([^;]+)\s+Build\//);
        if (match && match[1]) {
            deviceName = match[1]; 
        } else {
            deviceName = "Android Device";
        }
    }
    else if (/iPhone/.test(ua)) deviceName = "iPhone";
    else if (/iPad/.test(ua)) deviceName = "iPad";
    else if (/Windows/.test(ua)) deviceName = "Windows PC";
    else if (/Mac/.test(ua)) deviceName = "MacBook / iMac";
    else if (/Linux/.test(ua)) deviceName = "Linux PC";

    return deviceName;
}

// ২. লগইন ইভেন্ট আপডেট (Login Form)
loginForm.addEventListener('submit', e => {
    e.preventDefault(); 
    const email = loginEmail.value; 
    const pass = loginPassword.value; 
    const loginBtn = loginForm.querySelector('button');
    
    loginBtn.innerText = "Verifying..."; 
    loginError.textContent = "";

    auth.signInWithEmailAndPassword(email, pass).then(async (cred) => {
        // --- নতুন সেশন সেভ লজিক ---
        const user = cred.user;
        // প্রতিটি ব্রাউজারের জন্য ইউনিক আইডি তৈরি করা
        let deviceId = localStorage.getItem('my_device_id');
        if(!deviceId) {
            deviceId = 'dev_' + Date.now() + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('my_device_id', deviceId);
        }

        const deviceInfo = {
            deviceId: deviceId,
            deviceName: getDeviceName(),
            browser: navigator.userAgent, // বিস্তারিত জানার জন্য
            lastLogin: new Date().toLocaleString(),
            loginTime: firebase.firestore.FieldValue.serverTimestamp()
        };

        // ইউজারের ফোল্ডারে 'sessions' নামে কালেকশন তৈরি হবে
        await db.collection('users').doc(user.uid).collection('sessions').doc(deviceId).set(deviceInfo);
        
        // সাধারণ কাজগুলো
        localStorage.setItem('savedEmail', email); 
        localStorage.setItem('savedPass', pass); 
        loginBtn.innerText = "Success!";
    })
    .catch(err => { 
        loginBtn.innerText = "Login"; 
        loginError.textContent = "Error: " + err.message; 
    });
});

        document.getElementById('toggle-password-btn').addEventListener('click', function() { const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password'; loginPassword.setAttribute('type', type); this.classList.toggle('fa-eye'); this.classList.toggle('fa-eye-slash'); });
        // নতুন লগআউট লজিক

// মেইন লগআউট বাটনে ক্লিক করলে লিস্ট ওপেন হবে
document.getElementById('logout-button').addEventListener('click', () => {
    openSessionModal();
});

// মোডাল ওপেন এবং লিস্ট রেন্ডার করার ফাংশন
function openSessionModal() {
    const user = auth.currentUser;
    if(!user) return;

    document.getElementById('logout-manager-modal').style.display = 'flex';
    document.getElementById('session-user-email').innerText = user.email;
    const listCont = document.getElementById('device-list-container');
    
    // নিজের ডিভাইস আইডি চেনার জন্য
    const myDeviceId = localStorage.getItem('my_device_id');

    // ডাটাবেস থেকে লাইভ সেশন দেখা
    db.collection('users').doc(user.uid).collection('sessions').orderBy('loginTime', 'desc').onSnapshot(snap => {
        listCont.innerHTML = '';
        
        if(snap.empty) {
            listCont.innerHTML = '<p>No active sessions found.</p>';
            return;
        }

        snap.forEach(doc => {
            const data = doc.data();
            const isMe = data.deviceId === myDeviceId;
            
            // আইকন এবং কালার সেট করা
            const icon = data.deviceName.includes('Phone') ? 'fa-mobile-alt' : 'fa-laptop';
            const bg = isMe ? 'rgba(33, 212, 253, 0.15)' : 'rgba(255,255,255,0.05)';
            const border = isMe ? '1px solid var(--primary)' : '1px solid rgba(255,255,255,0.1)';
            const status = isMe ? '<span style="color:var(--primary); font-size:0.7rem; font-weight:bold;">(THIS DEVICE)</span>' : '';

            listCont.innerHTML += `
            <div style="background:${bg}; border:${border}; padding:12px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="font-size:1.5rem; color:${isMe ? 'var(--primary)' : '#aaa'};">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div>
                        <div style="color:white; font-weight:600; font-size:0.9rem;">
                            ${data.deviceName} ${status}
                        </div>
                        <div style="color:#888; font-size:0.7rem;">
                            Login: ${data.lastLogin}
                        </div>
                    </div>
                </div>
                
                ${!isMe ? `
                <button onclick="kickOutDevice('${doc.id}')" style="background:rgba(239, 68, 68, 0.1); color:#EF4444; border:1px solid #EF4444; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.8rem;">
                    LOGOUT
                </button>` : ''}
            </div>`;
        });
    });
}
        
        function showAdminPanel(user) { 
    loginPage.style.display = 'none'; 
    adminPanel.style.display = 'block'; 
    
    // বাটন দুটিকে এখানে শো করার নির্দেশ দিন
    const botBtn = document.getElementById('chatbot-trigger');
    const backBtn = document.getElementById('back-button-trigger');
    
    if(botBtn) botBtn.style.setProperty('display', 'flex', 'important');
    if(backBtn) backBtn.style.setProperty('display', 'flex', 'important');

    setTimeout(checkForUpdates, 2000); 
}
        function showLoginPage() { loginPage.style.display = 'flex'; adminPanel.style.display = 'none'; document.getElementById('chatbot-trigger').style.display = 'none'; document.getElementById('chatbot-container').style.display = 'none'; }
        async function checkForUpdates() { if (!auth.currentUser) return; try { const doc = await db.collection('app_settings').doc('config').get(); if (doc.exists) { const data = doc.data(); if (data.latestVersion !== CURRENT_APP_VERSION) { document.getElementById('update-msg').textContent = data.updateMessage; document.getElementById('new-version-display').textContent = data.latestVersion; document.getElementById('update-link').href = data.downloadLink; document.getElementById('update-modal').style.display = 'flex'; } } } catch (error) { console.log(error); } }

        async function fetchDataFromFirestore() {
            const user = auth.currentUser; if (!user) return;
            try {
                const [infoSnap, contactSnap, dailySnap, bankSnap, goalSnap, dpsSnap] = await Promise.all([
                    db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('informations').orderBy('createdAt', 'desc').get(),
                    db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('contacts').orderBy('createdAt', 'desc').get(),
                    db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('daily_transactions').get(),
                    db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bank_accounts').get(),
                    db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('savings_goals').get(),
                    db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('dps_schemes').get()
                ]);
                allInformation = infoSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })); allContacts = contactSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })); dailyData = dailySnap.docs.map(doc => ({ id: doc.id, ...doc.data() })); bankData = bankSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })); goalData = goalSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })); dpsData = dpsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllData(); refreshHisabAll();
            } catch (error) { console.error("Error fetching data:", error); }
        }
        function fetchBotTrainingData() { db.collection('global_bot_training').onSnapshot(snap => { customBotData = snap.docs.map(doc => doc.data()); }); }
        // ১. কমান্ড সেটিংস ডাটাবেজ থেকে নিয়ে আসা
function fetchCommandSettings() { 
    const user = auth.currentUser; 
    if(!user) return; 
    // হার্ডকোড করা আইডি ব্যবহার করা হয়েছে আপনার রিকুয়েস্ট অনুযায়ী
    db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bot_settings').onSnapshot(snap => { 
        customSettings = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); 
        renderSettingsList(); 
    }); 
}

// ২. নতুন কমান্ড সেভ করা
window.saveCommandSetting = async function() { 
    const logic = document.getElementById('setting-logic-select').value; 
    const cmd = document.getElementById('setting-custom-cmd').value.trim(); 
    if(!logic || !cmd) return alert("Select Logic and type the command."); 

    const existing = customSettings.find(s => s.logicId === logic); 
    try {
        if(existing) { 
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bot_settings').doc(existing.id).update({ command: cmd }); 
        } else { 
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bot_settings').add({ logicId: logic, command: cmd }); 
        } 
        alert("Command Set Successfully! ✅"); 
        document.getElementById('setting-custom-cmd').value = ''; 
    } catch(e) { alert("Error saving command!"); }
}



// ৪. কমান্ড ডিলিট করা
window.deleteCommandSetting = async function(id) { 
    window.confirmDelete("Do you want to delete this command?", function() { 
        db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bot_settings').doc(id).delete(); 
    }); 
}
        function renderAllData() { updateDashboard(); renderAllInfoPage(); renderAllContactsPage(); updateCounts(); }

        // --- NAVIGATION LOGIC FIXED ---
navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const pageId = this.dataset.page;
        window.switchPage(pageId);
    });
});

// --- OPEN ADD CONTACT PAGE FUNCTION FIXED ---
window.openAddContactPage = function() {
    resetAddContactForm();
    editingDocId = null;
    
    // সব পেজ হাইড করা
    pageContents.forEach(p => p.classList.remove('active'));
    
    // কন্টাক্ট পেজ শো করা
    const contactPage = document.getElementById('add-contact-page');
    if(contactPage) contactPage.classList.add('active');
    
    // নেভ বার আইকন ঠিক করা
    navLinks.forEach(l => l.classList.remove('active'));
    const navItem = document.querySelector('a[data-page="add-contact"]');
    if(navItem) navItem.classList.add('active');
};

// --- SWITCH PAGE FUNCTION FIXED ---
window.switchPage = function(pageName) {
    // ১. পেজ হিস্ট্রি ট্র্যাক করা
    if (pageHistoryStack[pageHistoryStack.length - 1] !== pageName) {
        pageHistoryStack.push(pageName);
    }

    // ২. সব পেজ থেকে active ক্লাস রিমুভ করা
    pageContents.forEach(p => p.classList.remove('active'));
    
    // ৩. নির্দিষ্ট পেজটি শো করা
    const target = document.getElementById(pageName + '-page');
    if(target) target.classList.add('active');
    
    // ৪. নিচের নেভিগেশন আইকন হাইলাইট করা
    navLinks.forEach(l => l.classList.remove('active'));
    const navItem = document.querySelector(`a[data-page="${pageName}"]`);
    if(navItem) navItem.classList.add('active');
    
    // ৫. পেজ পরিবর্তন হলে স্ক্রিনের উপরে নিয়ে যাওয়া
    window.scrollTo({top: 0, behavior: 'smooth'});
};
async function getNextId(counterName) { const user = auth.currentUser; const counterRef = db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('counters').doc(counterName); return db.runTransaction(async (transaction) => { const counterDoc = await transaction.get(counterRef); let newId = counterDoc.exists ? counterDoc.data().currentId + 1 : 1000; transaction.set(counterRef, { currentId: newId }); return newId; }); }

        document.getElementById('ai-scan-info-btn').addEventListener('click', () => runAIScan('info-content', 'ai-scan-info-btn')); document.getElementById('ai-scan-contact-btn').addEventListener('click', () => runAIScan('bulk-contact-text', 'ai-scan-contact-btn')); document.getElementById('ai-scan-mail-btn').addEventListener('click', () => runAIScan('bulk-mail-text', 'ai-scan-mail-btn'));
        async function fetchApiSettings() {
    const doc = await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('config').doc('telegram_api').get();
    if(doc.exists) {
        const data = doc.data();
        TG_BOT_TOKEN = data.token;
        TG_CHAT_ID = data.chatId;
        document.getElementById('display-bot-token').innerText = TG_BOT_TOKEN;
        document.getElementById('display-chat-id').innerText = TG_CHAT_ID;
    }
} 
        async function runAIScan(targetInputId, btnId) { const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = 'image/*'; fileInput.onchange = async (e) => { const file = e.target.files[0]; if (!file) return; const btn = document.getElementById(btnId); const originalHtml = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...'; btn.disabled = true; try { const { data: { text } } = await Tesseract.recognize(file, 'eng'); const targetArea = document.getElementById(targetInputId); targetArea.value = targetArea.value ? targetArea.value + "\n" + text : text; alert("AI Text Extracted!"); } catch (err) { alert("Failed to scan."); } finally { btn.innerHTML = originalHtml; btn.disabled = false; } }; fileInput.click(); }

        const infoCategory = document.getElementById('info-category'); const textUploadGroup = document.getElementById('text-upload-group'); const linkUploadGroup = document.getElementById('link-upload-group'); const fileUploadGroup = document.getElementById('file-upload-group'); const mailBulkToggleWrapper = document.getElementById('mail-bulk-toggle-wrapper'); const mailBulkToggle = document.getElementById('mail-bulk-toggle'); const mailBulkMode = document.getElementById('mail-bulk-mode'); const mailManualMode = document.getElementById('mail-manual-mode'); const bulkMailText = document.getElementById('bulk-mail-text'); const addInfoForm = document.getElementById('add-info-form'); const mailRowsContainer = document.getElementById('mail-rows-container'); const processMailBtn = document.getElementById('process-mail-btn');
        infoCategory.addEventListener('change', function() { const cat = this.value; const fileInput = document.getElementById('info-file-input'); textUploadGroup.style.display = 'none'; linkUploadGroup.style.display = 'none'; mailBulkToggleWrapper.style.display = 'none'; mailBulkMode.style.display = 'none'; mailManualMode.style.display = 'none'; fileUploadGroup.style.display = 'none'; if (cat === 'text') textUploadGroup.style.display = 'block'; else if (cat === 'link') linkUploadGroup.style.display = 'block'; else if (cat === 'mail') { mailBulkToggleWrapper.style.display = 'flex'; triggerMailMode(); } else if (['photo', 'video', 'audio', 'file'].includes(cat)) { fileUploadGroup.style.display = 'block'; if(cat === 'photo') fileInput.accept = "image/*"; else if(cat === 'video') fileInput.accept = "video/*"; else if(cat === 'audio') fileInput.accept = "audio/*"; else fileInput.accept = ".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.html,.css,.js,.php,.py,.java,.json,.xml,.psd,.ai,.svg,.eps,.cdr,.zip,.rar,.7z,.tar,.gz,.epub,.mobi,.azw3,.djvu,.apk,.exe,.msi,.ipa,.sql,.db,.sqlite,.log,.ttf,.otf,.woff"; } });
        mailBulkToggle.addEventListener('change', triggerMailMode); function triggerMailMode() { if (infoCategory.value !== 'mail') return; mailBulkMode.style.display = mailBulkToggle.checked ? 'block' : 'none'; mailManualMode.style.display = mailBulkToggle.checked ? 'none' : 'block'; }
        processMailBtn.addEventListener('click', function() { const text = bulkMailText.value; if(!text.trim()) return; mailRowsContainer.innerHTML = ''; const lines = text.split(/\r?\n/); let currentEmail = null; lines.forEach(line => { let cleanLine = line.trim(); if(!cleanLine) return; const match = cleanLine.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/); if (match) { const email = match[0]; let rawPass = cleanLine.substring(cleanLine.indexOf(email) + email.length).trim(); rawPass = rawPass.replace(/^[\s:\-|=>]+|^(password|pass|pwd|pword|pin)\s*[:=]?\s*/i, '').replace(/^[\s:\-|=>]+/, ''); if (rawPass.length > 0) { renderMailRow(email, rawPass); currentEmail = null; } else { currentEmail = email; } } else if (currentEmail) { let pass = cleanLine.trim().replace(/^[\s:\-|=>]+|^(password|pass|pwd|pword|pin)\s*[:=]?\s*/i, '').replace(/^[\s:\-|=>]+/, ''); if(pass) { renderMailRow(currentEmail, pass); currentEmail = null; } } }); mailRowsContainer.insertAdjacentHTML('beforeend', `<div class="mail-input-group"><input type="email" class="mail-email" placeholder="Email"><input type="text" class="mail-password" placeholder="Pass"><button type="button" class="add-mail-btn btn">+</button></div>`); mailBulkToggle.checked = false; triggerMailMode(); });

   // --- ADD INFO FORM LOGIC (RE-FIXED & CLEAN) ---
        addInfoForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const user = auth.currentUser; 
            const cat = infoCategory.value; 
            const titleInput = document.getElementById('info-title').value.trim();
            const fileInput = document.getElementById('info-file-input');
            const submitBtn = addInfoForm.querySelector('button[type="submit"]');

            // ১. ভ্যালিডেশন: তথ্য না দিলে সেভ হবে না
            if (!titleInput) { alert("Title is required! ❌"); return; }

            if (cat === 'text') {
                const textContent = document.getElementById('info-content').value.trim();
                if (!textContent) { alert("Please enter text content! ❌"); return; }
            } 
            else if (cat === 'link') {
                const linkContent = document.getElementById('info-link').value.trim();
                if (!linkContent) { alert("Please enter a link! ❌"); return; }
            } 
            else if (cat === 'mail') {
                let hasMailData = false;
                document.querySelectorAll('.mail-input-group').forEach(row => {
                    if (row.querySelector('.mail-email').value.trim() !== "" || row.querySelector('.mail-password').value.trim() !== "") hasMailData = true;
                });
                if (!hasMailData) { alert("Please enter at least one Email or Password! ❌"); return; }
            }
            else if (['photo', 'video', 'audio', 'file'].includes(cat)) {
                if (!editingDocId && fileInput.files.length === 0) { alert("Please select a file! ❌"); return; }
            }

            // ২. ফাইল সাইজ চেক (২০ এমবি)
            if (fileInput.files.length > 0) {
                if (fileInput.files[0].size > 20 * 1024 * 1024) { 
                    alert("Error: The file is larger than 20 MB! ❌");
                    return; 
                }
            }

            // ৩. প্রসেসিং শুরু
            submitBtn.disabled = true; 
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...'; 

            try { 
                if (['photo', 'video', 'audio', 'file'].includes(cat)) {
                    const file = fileInput.files[0]; 
                    let contentToSave = ""; 
                    if (file) {
                        document.getElementById('upload-status').innerText = "Uploading to TG Cloud..."; 
                        const formData = new FormData(); 
                        formData.append('chat_id', TG_CHAT_ID); 
                        formData.append('caption', titleInput); 
                        const apiMethod = (cat === 'photo') ? 'sendPhoto' : 'sendDocument'; 
                        const keyName = (cat === 'photo') ? 'photo' : 'document'; 
                        formData.append(keyName, file); 
                        const res = await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/${apiMethod}`, { method: 'POST', body: formData }); 
                        const data = await res.json(); 
                        if (!data.ok) throw new Error("TG API Error: " + data.description); 
                        
                        let fileId; 
                        if (cat === 'photo') fileId = data.result.photo[data.result.photo.length - 1].file_id; 
                        else if (cat === 'video') fileId = data.result.video.file_id; 
                        else if (cat === 'audio') fileId = data.result.audio.file_id; 
                        else fileId = data.result.document.file_id; 
                        contentToSave = fileId; 
                    } else if (editingDocId) { 
                        const oldDoc = await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('informations').doc(editingDocId).get(); 
                        contentToSave = oldDoc.data().fullContent; 
                    }
                    await saveInfoToDb(user, cat, titleInput, contentToSave); 
                    alert('Saved Successfully! ✅'); 
                } else if (cat === 'mail') { 
                    let finalEntries = []; 
                    document.querySelectorAll('.mail-input-group').forEach(row => { 
                        const mEmail = row.querySelector('.mail-email').value; 
                        const mPass = row.querySelector('.mail-password').value; 
                        if (mEmail || mPass) finalEntries.push(`Email: ${mEmail} | Password: ${mPass}`); 
                    }); 
                    await saveInfoToDb(user, 'mail', titleInput, finalEntries.join('|||')); 
                    alert('Mail List Added! ✅'); 
                } else { 
                    let content = (cat === 'text') ? document.getElementById('info-content').value : document.getElementById('info-link').value; 
                    await saveInfoToDb(user, cat, titleInput, content); 
                    alert('Info Saved! ✅'); 
                } 
                resetAddInfoForm(); 
                fetchDataFromFirestore(); 
            } catch(error) { 
                alert("Error: " + error.message); 
            } finally { 
                submitBtn.disabled = false; 
                submitBtn.innerHTML = 'Add Information'; 
                document.getElementById('upload-status').innerText = ""; 
            } 
        });
        
        
async function saveInfoToDb(user, cat, title, content, onlyTitle = false) { const infoData = { title: title, category: cat, date: new Date().toLocaleDateString() }; if(!onlyTitle) infoData.fullContent = content; if (editingDocId && cat !== 'mail') { await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('informations').doc(editingDocId).update(infoData); } else { if(onlyTitle) return; const newId = await getNextId('infoCounter'); infoData.createdAt = firebase.firestore.FieldValue.serverTimestamp(); await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('informations').doc(String(newId)).set(infoData); } }

        const addContactForm = document.getElementById('add-contact-form'); const contactBulkToggle = document.getElementById('contact-bulk-toggle'); 
contactBulkToggle.addEventListener('change', function() {
    const singleMode = document.getElementById('single-contact-mode');
    const bulkMode = document.getElementById('bulk-contact-mode');
    const submitBtn = document.getElementById('contact-submit-btn');

    if (this.checked) {
        singleMode.style.display = 'none';
        bulkMode.style.display = 'block'; // এখানে ব্লক হওয়ার সাথে সাথে বাটনটিও দেখা যাবে
        submitBtn.innerHTML = 'Import All Contacts <i class="fas fa-file-import"></i>';
    } else {
        singleMode.style.display = 'block';
        bulkMode.style.display = 'none'; // এখানে মোড অফ হলে বাটনটিও গায়েব হয়ে যাবে
        submitBtn.innerHTML = 'Add Contact';
    }
});

        const contactSubmitBtn = document.getElementById('contact-submit-btn');
        // --- ADD CONTACT FORM LOGIC (WITH DUPLICATE CHECK FROM DATABASE) ---
addContactForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const isBulk = contactBulkToggle.checked;

    if (isBulk) {
        // --- বাল্ক ইম্পোর্ট (Bulk Import) লজিক ---
        const rows = document.querySelectorAll('.bulk-contact-row');
        if (rows.length === 0) return alert('First, press the Direct Now button to process the data!');
        
        contactSubmitBtn.innerText = "Checking & Importing...";
        contactSubmitBtn.disabled = true;

        // এই সেশনের জন্য সাময়িক লিস্ট (যাতে একই ইম্পোর্টে দুইবার একই নম্বর না আসে)
        let sessionPhoneList = []; 
        let duplicateCount = 0;
        let importedCount = 0;

        try {
            for (const row of rows) {
                const bName = row.querySelector('.bulk-name').value.trim();
                
                // ১. সব ফোন ইনপুট নেওয়া
                const phoneInputs = row.querySelectorAll('.bulk-phone');
                let bPhones = Array.from(phoneInputs)
                                   .map(input => input.value.trim())
                                   .filter(num => num !== "");

                // ২. ডুপ্লিকেট ফিল্টার লজিক (সবচেয়ে গুরুত্বপূর্ণ অংশ)
                let uniquePhones = [];
                
                for (let phone of bPhones) {
                    // চেক ১: ডাটাবেসে এই নম্বর আগে থেকে আছে কিনা?
                    const existsInDB = allContacts.some(c => c.phone && c.phone.includes(phone));
                    
                    // চেক ২: এইমাত্র প্রসেস করা লিস্টে আছে কিনা?
                    const existsInSession = sessionPhoneList.includes(phone);

                    if (existsInDB || existsInSession) {
                        console.log(`Duplicate skipped: ${phone}`);
                        duplicateCount++;
                    } else {
                        // যদি নতুন হয়, তবেই লিস্টে যোগ করো
                        uniquePhones.push(phone);
                        sessionPhoneList.push(phone); // সেশন লিস্টে যোগ রাখা
                    }
                }

                // ৩. যদি নাম থাকে এবং অন্তত একটি নতুন ইউনিক নম্বর থাকে তবেই সেভ হবে
                if(bName && uniquePhones.length > 0) {
                    const newId = await getNextId('contactCounter');
                    await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('contacts').doc(String(newId)).set({
                        name: bName,
                        phone: uniquePhones, // শুধু নতুন নম্বরগুলো সেভ হবে
                        email: "",
                        address: row.querySelector('.bulk-address').value.trim(),
                        socialLinks: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    importedCount++;
                }
            }

            // ৪. রেজাল্ট মেসেজ
            let msg = `Successfully saved ${importedCount} contacts! ✅`;
            if(duplicateCount > 0) {
                msg += `\n(Skipped ${duplicateCount} duplicate numbers)`;
            }
            alert(msg);
            
            resetAddContactForm();
            fetchDataFromFirestore();

        } catch (error) { 
            console.error(error);
            alert("Error during bulk import!"); 
        } 
        finally { 
            contactSubmitBtn.innerHTML = "Import All Contacts <i class=\"fas fa-file-import\"></i>"; 
            contactSubmitBtn.disabled = false; 
        }

    } else {
        // --- সিঙ্গেল কন্টাক্ট সেভ লজিক (আগের মতোই থাকবে) ---
        const name = document.getElementById('contact-name').value.trim();
        const phoneArray = Array.from(document.querySelectorAll('.contact-phone')).map(i=>i.value.trim()).filter(Boolean);

        if (!name) {
            alert("Error: Contact name is required! ❌");
            return;
        }
        
        if (phoneArray.length === 0) {
            alert("Incorrect: At least one phone number is required!❌");
            return;
        }

        // সিঙ্গেল মোডে ডুপ্লিকেট চেক
        const exists = allContacts.some(c => c.phone.some(p => phoneArray.includes(p)));
        if (exists && !editingDocId) { // এডিটিং এর সময় বাদে চেক করবে
            alert("This number is already on your list!❌");
            return;
        }

        contactSubmitBtn.disabled = true;
        contactSubmitBtn.innerText = "Saving...";

        try {
            const saveId = editingDocId ? editingDocId : String(await getNextId('contactCounter'));
            
            const contactData = { 
                name, 
                phone: phoneArray, 
                email: document.getElementById('contact-email').value.trim(), 
                address: document.getElementById('contact-address').value.trim(), 
                socialLinks: Array.from(document.querySelectorAll('.contact-social')).map(i=>i.value).filter(Boolean),
                createdAt: firebase.firestore.FieldValue.serverTimestamp() 
            };
            
            if(editingDocId) {
                await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('contacts').doc(saveId).update(contactData);
                alert('Contact Updated successfully! ✅');
            } else {
                await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('contacts').doc(saveId).set(contactData);
                alert('Contact saved successfully! ✅');
            }
            
            resetAddContactForm();
            fetchDataFromFirestore();
        } catch(e) {
            console.error(e);
            alert("There was a problem saving!");
        } finally {
            contactSubmitBtn.disabled = false;
            contactSubmitBtn.innerText = "Add Contact";
        }
    }
});
    
    
        function renderMailRow(email, pass) { mailRowsContainer.insertAdjacentHTML('beforeend', `<div class="mail-input-group"><input type="email" class="mail-email" value="${email}"><input type="text" class="mail-password" value="${pass}"><button type="button" class="remove-btn btn">-</button></div>`); }
        
// --- ULTIMATE SMART BULK IMPORT LOGIC (FINAL NAME FIX) ---
document.getElementById('process-contact-btn').addEventListener('click', function() {
    const text = document.getElementById('bulk-contact-text').value;
    if(!text.trim()) return alert("Paste the data first!");

    const previewArea = document.getElementById('bulk-contact-preview');
    previewArea.innerHTML = ''; 
    
    // লাইনগুলোকে আলাদা করা
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
    
    let buffer = { name: "", phone: [], address: "" };
    let foundCount = 0;

    const saveAndReset = () => {
        if (buffer.phone.length > 0 || buffer.name !== "") {
            let finalName = buffer.name || "Unknown Name";
            // সেভ করার আগে শেষবারের মতো ক্লিন করা (যদি কিছু থেকে যায়)
            finalName = finalName.replace(/^\d+[\.\)\-]?\s*/, "") // নম্বর মুছবে
                                 .replace(/^(Name|Nam|Nama|Namer)\s*[:\-]\s*/i, "") // Name: মুছবে
                                 .trim();

            let finalPhoneList = buffer.phone.length > 0 ? buffer.phone : [''];
            renderBulkRow(finalName, finalPhoneList, buffer.address);
            foundCount++;
        }
        buffer = { name: "", phone: [], address: "" };
    };

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // ১. লাইন থেকে মোবাইল নম্বর খোঁজা
        let phoneMatches = line.match(/(?:\+88|88)?(01[3-9]\d{8})/g);

        // ২. নতুন কন্টাক্ট শুরুর লজিক
        // লাইনের শুরুতে যদি নম্বর বা "Name:" থাকে, তাহলে নতুন কন্টাক্ট হিসেবে ধরবে
        let cleanStart = line.replace(/^\d+[\.\)\-]?\s*/, ""); // ক্রমিক নম্বর বাদ দিয়ে চেক
        let isNewNameLabel = /^(Name|Nam|Nama|Namer)\s*[:\-]/i.test(cleanStart);
        
        if ((!phoneMatches && buffer.phone.length > 0) || isNewNameLabel) {
            let isAddressLabel = /^(Address|Add|Thikana|Loc|Location)\s*[:\-]/i.test(cleanStart);
            if (!isAddressLabel) {
                if(buffer.name !== "" || buffer.phone.length > 0) {
                    saveAndReset();
                }
            }
        }

        if (phoneMatches) {
            phoneMatches.forEach(p => buffer.phone.push(p));

            // একই লাইনে নাম থাকলে বের করা (যেমন: 16. Name: Babu 017...)
            let remainingText = line;
            phoneMatches.forEach(p => { remainingText = remainingText.replace(p, "").replace(/[,;]/g, ""); });
            
            // ক্রমিক নম্বর এবং Name: লেবেল সব মুছে ফেলা
            remainingText = remainingText.replace(/^\d+[\.\)\-]?\s*/, "")
                                         .replace(/^(Name|Nam|Nama|Namer)\s*[:\-]\s*/i, "")
                                         .replace(/[:\-]/g, "")
                                         .trim();
            
            if (remainingText.length > 1 && !buffer.name) {
                 buffer.name = remainingText;
            }
        } 
        else {
            // নম্বর নেই, মানে এটি নাম অথবা ঠিকানা
            
            // প্রথমে লাইনের শুরু থেকে ক্রমিক নম্বর (16. ) মুছে ফেলা হচ্ছে
            let textWithoutSerial = line.replace(/^\d+[\.\)\-]?\s*/, "");

            // নাম ডিটেকশন
            if (/^(Name|Nam|Nama|Namer)\s*[:\-]/i.test(textWithoutSerial)) {
                // "Name:" মুছে শুধু নাম রাখা
                buffer.name = textWithoutSerial.replace(/^(Name|Nam|Nama|Namer)\s*[:\-]\s*/i, "").trim();
            }
            // ঠিকানা ডিটেকশন
            else if (/^(Address|Add|Thikana|Loc|Location)\s*[:\-]/i.test(textWithoutSerial)) {
                buffer.address = textWithoutSerial.replace(/^(Address|Add|Thikana|Loc|Location)\s*[:\-]\s*/i, "").trim();
            }
            // সাধারণ টেক্সট (Raw Name)
            else {
                if (!buffer.name) {
                    buffer.name = textWithoutSerial; // এটিই নাম (যেমন: Babu)
                } else {
                    if(buffer.address) buffer.address += ", " + textWithoutSerial;
                    else buffer.address = textWithoutSerial;
                }
            }
        }
    }

    saveAndReset();
    
    if(foundCount === 0) {
        alert("No valid contacts found! Please check format.");
    }
});
// --- DYNAMIC MULTI-INPUT ROW RENDERER (LAYOUT FIXED FOR VISIBILITY) ---
window.renderBulkRow = function(name, phones, address) {
    const container = document.getElementById('bulk-contact-preview');
    
    // ফোন ডাটা ঠিক করা
    let phoneArray = [];
    if (phones && Array.isArray(phones)) {
        phoneArray = phones;
    } else if (phones) {
        phoneArray = [phones];
    } else {
        phoneArray = ['']; 
    }
    
    // ফোনের ইনপুট বক্স তৈরি
    let phoneInputsHtml = '';
    phoneArray.forEach(num => {
        phoneInputsHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <input type="tel" class="bulk-phone" value="${num}" placeholder="Phone Number" 
                       style="height: 40px !important; flex: 1; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 0 12px; border-radius: 8px; margin-bottom: 0 !important; font-size: 1rem;">
                
                <!-- রিমুভ বাটন (-) -->
                <button type="button" class="btn" onclick="this.parentElement.remove()" 
                        style="height: 40px; width: 40px; min-width: 40px; background: rgba(239, 68, 68, 0.2); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        `;
    });

    const rowHtml = `
        <div class="bulk-contact-row" style="display: flex; gap: 10px; align-items: flex-start; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);">
            
            <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                <!-- নাম -->
                <input type="text" class="bulk-name" value="${name || ''}" placeholder="Enter Name" 
                       style="margin-bottom: 0 !important; height: 40px !important; font-weight:bold; color:var(--primary); background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 0 12px; border-radius: 8px;">
                
                <!-- ঠিকানা (নামের নিচে নিয়ে আসা হয়েছে যাতে জায়গা বাড়ে) -->
                <input type="text" class="bulk-address" value="${address || ''}" placeholder="Address / Location" 
                       style="margin-bottom: 0 !important; height: 40px !important; width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: #ddd; padding: 0 12px; border-radius: 8px; font-size: 0.9rem;">

                <!-- ফোনের তালিকা -->
                <div style="display: flex; flex-direction: column; margin-top: 5px;">
                    <small style="color: #aaa; margin-bottom: 5px; display: block;">Phone Numbers:</small>
                    ${phoneInputsHtml}
                </div>
            </div>

            <!-- পুরো কন্টাক্ট ডিলিট করার বাটন (Trash) -->
            <button type="button" class="remove-btn btn" onclick="this.closest('.bulk-contact-row').remove()" 
                    style="height: 40px; width: 40px; margin-top: 0px; display: flex; align-items: center; justify-content: center; background: #ff4d4d; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', rowHtml);
}
        document.body.addEventListener('click', function(e) { if (e.target.classList.contains('add-phone-btn')) document.getElementById('phone-numbers-container').insertAdjacentHTML('beforeend', `<div class="phone-input-group"><input type="tel" class="contact-phone"><button type="button" class="remove-btn btn">-</button></div>`); if (e.target.classList.contains('add-social-btn')) document.getElementById('social-links-container').insertAdjacentHTML('beforeend', `<div class="social-input-group"><input type="url" class="contact-social"><button type="button" class="remove-btn btn">-</button></div>`); if (e.target.classList.contains('add-mail-btn')) mailRowsContainer.insertAdjacentHTML('beforeend', `<div class="mail-input-group"><input type="email" class="mail-email"><input type="text" class="mail-password"><button type="button" class="remove-btn btn">-</button></div>`); if (e.target.classList.contains('remove-btn') && !e.target.parentElement.classList.contains('bulk-contact-row')) e.target.parentElement.remove(); });
        
        // --- সংশোধিত ফিল্টার এবং মোডাল লজিক (Card Design এর জন্য) ---
const filterBtns = document.querySelectorAll('.filter-btn'); 
const searchButton = document.getElementById('search-button'); 
const searchKeyword = document.getElementById('search-keyword'); 
const infoModal = document.getElementById('info-modal'); 
const closeInfoModalBtn = document.getElementById('close-info-modal'); 
const infoModalHeader = document.getElementById('info-modal-header'); 
const infoModalBody = document.getElementById('info-modal-body'); 
const infoModalFooter = document.getElementById('info-modal-footer');

// ১. ক্যাটাগরি ফিল্টার লজিক (কার্ডের জন্য আপডেট করা হয়েছে)
filterBtns.forEach(btn => { 
    btn.addEventListener('click', function() { 
        // সব বাটন থেকে active ক্লাস সরানো
        filterBtns.forEach(b => b.classList.remove('active')); 
        // ক্লিক করা বাটনে active ক্লাস যোগ করা
        this.classList.add('active'); 
        
        const cat = this.dataset.category; 
        
        // এটি এখন টেবিল রো এর বদলে কার্ড (.info-card) ফিল্টার করবে
        document.querySelectorAll('.info-card').forEach(card => { 
            if (cat === 'all' || card.dataset.category === cat) {
                card.style.display = 'block'; 
            } else {
                card.style.display = 'none'; 
            }
        }); 
    }); 
});

// ২. সার্চ বাটন লজিক
if(searchButton) {
    searchButton.addEventListener('click', performSearch);
}

// ৩. কিবোর্ডের Enter চাপলে সার্চ হবে
if(searchKeyword) {
    searchKeyword.addEventListener('keyup', e => e.key === 'Enter' && performSearch());
}

// ৪. মোডাল বন্ধ করার লজিক
if(closeInfoModalBtn) {
    closeInfoModalBtn.addEventListener('click', () => infoModal.style.display = 'none');
}

// ৫. মোডালের বাইরে ক্লিক করলে সেটি বন্ধ হবে
window.addEventListener('click', e => { 
    if (e.target === infoModal) infoModal.style.display = 'none'; 
});
     function performSearch() {
    const cat = document.getElementById('search-category').value; 
    const key = document.getElementById('search-keyword').value.toLowerCase().trim(); 
    const resultsContainer = document.getElementById('search-results');
    
    // আগের টেবিল ফরমেট বাদ দিয়ে আমরা সরাসরি কন্টেইনার ক্লিয়ার করব
    resultsContainer.innerHTML = ''; 
    const safeStr = (str) => (str ? String(str).toLowerCase() : ""); 
    let res = [];

    // ১. ডাটা ফিল্টারিং (আগের মতোই)
    if (cat === 'all' || ['text','link','mail','photo','video','audio','file'].includes(cat)) { 
        res.push(...allInformation.filter(i => 
            (cat === 'all' || i.category === cat) && 
            (safeStr(i.title).includes(key) || safeStr(i.fullContent).includes(key) || safeStr(i.id).includes(key))
        ).map(i => ({...i, type: 'info'}))); 
    }
    if (cat === 'all' || cat === 'contacts') { 
        res.push(...allContacts.filter(c => 
            safeStr(c.name).includes(key) || 
            safeStr(c.email).includes(key) || 
            safeStr(c.address).includes(key) || 
            (c.phone && c.phone.some(p => safeStr(p).includes(key)))
        ).map(c => ({...c, type: 'contact'}))); 
    }
    if (cat === 'all' || cat === 'hisab') {
        res.push(...dailyData.filter(t => safeStr(t.cat).includes(key) || safeStr(t.note).includes(key) || safeStr(t.amount).includes(key)).map(t => ({...t, type: 'h_daily'})));
        res.push(...bankData.filter(b => safeStr(b.name).includes(key) || safeStr(b.num).includes(key)).map(b => ({...b, type: 'h_bank'})));
        res.push(...goalData.filter(g => safeStr(g.name).includes(key) || safeStr(g.target).includes(key)).map(g => ({...g, type: 'h_goal'})));
        res.push(...dpsData.filter(d => safeStr(d.bank).includes(key) || safeStr(d.monthly).includes(key)).map(d => ({...d, type: 'h_dps'})));
    }

    // ২. রেজাল্ট রেন্ডারিং (আধুনিক কার্ড ফরমেটে)
    if(res.length > 0) { 
        res.forEach(i => { 
            let title, category, idText, subText, tab, collection;

            if (i.type === 'contact') {
                title = i.name; category = 'Contact'; idText = "ID: " + i.id;
                subText = `<i class="fa-solid fa-phone"></i> ${i.phone?.[0] || 'No Phone'}`;
            } else if (i.type === 'h_daily') {
                title = i.cat; category = 'Daily Hisab'; idText = i.date;
                subText = `৳ ${i.amount} [${i.note || ''}]`; tab = 'daily'; collection = 'daily_transactions';
            } else if (i.type === 'h_bank') {
                title = i.name; category = 'Bank A/C'; idText = 'Bank';
                subText = `Balance: ৳ ${i.balance}`; tab = 'bank'; collection = 'bank_accounts';
            } else if (i.type === 'h_goal') {
                title = i.name; category = 'Savings Goal'; idText = 'Goal';
                subText = `Saved: ৳ ${i.balance} / ${i.target}`; tab = 'goal'; collection = 'savings_goals';
            } else if (i.type === 'h_dps') {
                title = i.bank; category = 'DPS Scheme'; idText = 'DPS';
                subText = `Total Paid: ৳ ${i.paid}`; tab = 'dps'; collection = 'dps_schemes';
            } else {
                title = i.title; category = getCategoryName(i.category); idText = "ID: " + i.id;
                subText = i.date;
            }

            // কার্ড এইচটিএমএল (আপনার কন্টাক্ট এবং ইনফো লিস্টের মতো ডিজাইন)
            resultsContainer.innerHTML += `
                <div class="info-card" style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div class="card-main-info">
                            <div class="info-title-cell">${title}</div>
                            <div class="info-meta-row">
                                <span class="id-text"><i class="fa-solid fa-id-badge"></i> ${idText}</span>
                                <span class="badge-cat">${category}</span>
                            </div>
                            <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">${subText}</div>
                        </div>
                        
                        <!-- বাটন গ্রুপ (আইকন ভিত্তিক) -->
                        <div class="premium-action-group">
                            ${!i.type.startsWith('h_') ? `
                                <div class="icon-btn-premium btn-share-pr" onclick="shareInformation('${i.id}', ${i.type === 'contact'})"><i class="fa-solid fa-share-nodes"></i></div>
                                <div class="icon-btn-premium btn-edit-pr" onclick="${i.type === 'contact' ? 'editContact' : 'editInfo'}('${i.id}')"><i class="fa-solid fa-pen-to-square"></i></div>
                                <div class="icon-btn-premium btn-delete-pr" onclick="${i.type === 'contact' ? 'deleteContact' : 'deleteInfo'}('${i.id}')"><i class="fa-solid fa-trash-can"></i></div>
                            ` : `
                                <div class="icon-btn-premium btn-delete-pr" onclick="deleteHisabItem('${collection}', '${i.id}')"><i class="fa-solid fa-trash-can"></i></div>
                            `}
                        </div>
                    </div>
                    
                    <button class="view-btn-full" onclick="${i.type.startsWith('h_') ? `switchPage('hisab'); switchHisabTab('${tab}')` : (i.type === 'contact' ? `openContactInfo` : `openInfoModal`)+'(\''+i.id+'\')'}">
                        ${i.type.startsWith('h_') ? 'GO TO FINANCE' : 'VIEW DETAILS'}
                    </button>
                </div>`;
        }); 
    } else { 
        resultsContainer.innerHTML = '<p style="text-align:center; color:#aaa; padding:20px;">No results found.</p>'; 
    }
}

        function updateDashboard() { 
    // --- 1. Recent Information Table Update ---
    const rInfo = document.getElementById('recent-info-table'); 
    if(rInfo) { 
        rInfo.innerHTML = ''; 
        
        // প্রথম ৫টি তথ্য লুপ করা হচ্ছে
        allInformation.slice(0, 5).forEach(i => { 
            
            // ক্যাটাগরি অনুযায়ী কালার সেট করা
            let badgeColor = '#94a3b8'; // ডিফল্ট (ধূসর)
            let badgeBg = 'rgba(148, 163, 184, 0.1)';
            
            if(i.category === 'text') { badgeColor = '#21D4FD'; badgeBg = 'rgba(33, 212, 253, 0.1)'; }
            else if(i.category === 'link') { badgeColor = '#B721FF'; badgeBg = 'rgba(183, 33, 255, 0.1)'; }
            else if(i.category === 'mail') { badgeColor = '#EA580C'; badgeBg = 'rgba(234, 88, 12, 0.1)'; }
            else if(['photo', 'video', 'audio', 'file'].includes(i.category)) { badgeColor = '#10B981'; badgeBg = 'rgba(16, 185, 129, 0.1)'; }

            // সুন্দর নাম পাওয়ার জন্য আপনার helper function ব্যবহার করা হলো
            let catName = getCategoryName(i.category).toUpperCase();

            // টেবিলে রো যুক্ত করা (টাইটেলের নিচে ট্যাগ বসানো হয়েছে)
            rInfo.innerHTML += `
            <tr>
                <td style="vertical-align: middle; color: #94a3b8; font-weight: bold;">${i.id}</td>
                <td style="padding: 10px 5px;">
                    <div style="font-size: 0.9rem; font-weight: 500; color: #fff; margin-bottom: 4px;">${i.title}</div>
                    <span style="font-size: 0.65rem; background: ${badgeBg}; color: ${badgeColor}; padding: 2px 8px; border-radius: 4px; border: 1px solid ${badgeColor}; font-weight: 600; letter-spacing: 0.5px;">
                        ${catName}
                    </span>
                </td>
                <td class="action-buttons" style="vertical-align: middle; text-align: right;">
                    <button class="open-btn" onclick="openInfoModal('${i.id}')" style="background: rgba(33, 212, 253, 0.1); border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 6px; font-size: 0.75rem;">View</button>
                </td>
            </tr>`; 
        }); 
    } 

    // --- 2. Recent Contacts Table Update (যেমন আছে তেমনই থাকবে) ---
    const rCont = document.getElementById('recent-contacts-table'); 
    if(rCont) { 
        rCont.innerHTML = ''; 
        allContacts.slice(0, 5).forEach(c => {
            rCont.innerHTML += `
            <tr>
                <td>${c.id}</td>
                <td>${c.name}</td>
                <td>${c.phone?.[0] || 'N/A'}</td>
                <td class="action-buttons">
                    <button class="open-btn" onclick="openContactInfo('${c.id}')">View</button>
                </td>
            </tr>`; 
        }); 
    } 
}
       function renderAllInfoPage() {
    const container = document.getElementById('all-info-list-container');
    if(!container) return;
    container.innerHTML = ''; 

    if (allInformation.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#aaa; padding:20px;">No info found.</p>';
        return;
    }

    allInformation.forEach(i => {
        const card = document.createElement('div');
        card.className = 'info-card';
        card.dataset.category = i.category;
        
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div class="card-main-info">
                    <div class="info-title-cell">${i.title}</div>
                    <div class="info-meta-row">
                        <span class="id-text"><i class="fa-solid fa-id-badge"></i> ID: ${i.id}</span>
                        <span class="badge-cat">${getCategoryName(i.category)}</span>
                    </div>
                </div>
                
                <!-- বড় ও গ্যাপযুক্ত প্রিমিয়াম বাটন -->
                <div class="premium-action-group">
                     <div class="icon-btn-premium btn-share-pr" onclick="shareInformation('${i.id}')" title="Share">
                        <i class="fa-solid fa-share-nodes"></i>
                     </div>
                     <div class="icon-btn-premium btn-edit-pr" onclick="editInfo('${i.id}')" title="Edit">
                        <i class="fa-solid fa-pen-to-square"></i>
                     </div>
                     <div class="icon-btn-premium btn-delete-pr" onclick="deleteInfo('${i.id}')" title="Delete">
                        <i class="fa-solid fa-trash-can"></i>
                     </div>
                </div>
            </div>
            
            <button class="view-btn-full" onclick="openInfoModal('${i.id}')">View Details</button>
        `;
        container.appendChild(card);
    });
}
function renderAllContactsPage() { 
    const container = document.getElementById('contacts-list-container'); 
    container.innerHTML = ''; 
    
    if (allContacts.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#aaa; margin-top:20px;">No contacts found.</p>';
        return;
    }

    allContacts.forEach(c => {
        const card = document.createElement('div');
        card.className = 'info-card'; // আগে তৈরি করা প্রিমিয়াম কার্ড ক্লাস

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <div style="flex: 1; padding-right: 10px;">
                    <h3 class="info-title-cell" style="margin:0;">${c.name}</h3>
                    <!-- ছবির মতো ID এবং কন্টাক্ট ট্যাগ -->
                    <div class="info-meta-row">
                        <span class="id-text">
                            <i class="fa-solid fa-id-badge"></i> ID: ${c.id}
                        </span>
                        <span class="badge-cat">CONTACT</span>
                    </div>
                         <p style="color: #aaa; font-size: 0.85rem; margin-top: 5px;">
                        <i class="fa-solid fa-location-dot" style="color:var(--primary); font-size: 0.75rem;"></i> ${c.address || 'N/A'}
                    </p>
                </div>
                
                <!-- কন্টাক্ট পেজের জন্য বড় ও প্রিমিয়াম আইকন গ্রুপ -->
                <div class="premium-action-group">
                     <div class="icon-btn-premium btn-share-pr" onclick="shareInformation('${c.id}', true)" title="Share">
                        <i class="fa-solid fa-share-nodes"></i>
                     </div>
                     <div class="icon-btn-premium btn-edit-pr" onclick="editContact('${c.id}')" title="Edit">
                        <i class="fa-solid fa-pen-to-square"></i>
                     </div>
                     <div class="icon-btn-premium btn-delete-pr" onclick="deleteContact('${c.id}')" title="Delete">
                        <i class="fa-solid fa-trash-can"></i>
                     </div>
                </div>
            </div>

            <!-- নিচে কল এবং ডিটেইলস বাটন (CONTACTS স্পেশাল) -->
            <div style="display: flex; gap: 12px; margin-top: 10px;">
                <button class="view-btn-full" onclick="openContactInfo('${c.id}')" style="flex: 1; margin-top:0;">Details</button>
                <a href="tel:${c.phone?.[0] || ''}" style="flex: 1; text-decoration: none;">
                    <button class="view-btn-full" style="width: 100%; margin-top:0; background: rgba(16, 185, 129, 0.1); border-color: #10B981; color: #10B981;">
                        <i class="fa-solid fa-phone"></i> Call
                    </button>
                </a>
            </div>`;
        container.appendChild(card);
    }); 
}
   function getCategoryName(v) { 
    // নামগুলো ছোট করে দেওয়া হলো যাতে এক লাইনে আটে
    const shortNames = {
        'text': 'Text',
        'link': 'Link',
        'mail': 'Mail',
        'photo': 'Photo',
        'video': 'Video',
        'audio': 'Audio',
        'file': 'File'
    };
    return shortNames[v] || v; 
}
        function updateCounts() { const dashTotal = document.getElementById('dash-total-info'); if(dashTotal) dashTotal.textContent = allInformation.length; document.getElementById('count-photo').textContent = allInformation.filter(i => i.category === 'photo').length; document.getElementById('count-video').textContent = allInformation.filter(i => i.category === 'video').length; document.getElementById('count-audio').textContent = allInformation.filter(i => i.category === 'audio').length; document.getElementById('count-file').textContent = allInformation.filter(i => i.category === 'file').length; document.getElementById('count-text').textContent = allInformation.filter(i => i.category === 'text').length; document.getElementById('count-link').textContent = allInformation.filter(i => i.category === 'link').length; document.getElementById('count-mail').textContent = allInformation.filter(i => i.category === 'mail').length; document.getElementById('count-contacts').textContent = allContacts.length; }
        // ফিক্সড: টেলিগ্রাম লিংক চেকার ফাংশন
        async function getTelegramLink(fileId) { 
            if (!fileId) return null;
            try { 
                // TG_BOT_TOKEN অবশ্যই উপরে ডিফাইন করা থাকতে হবে
                const res = await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/getFile?file_id=${fileId}`); 
                const data = await res.json(); 
                
                if (data.ok) { 
                    return `https://api.telegram.org/file/bot${TG_BOT_TOKEN}/${data.result.file_path}`; 
                } else {
                    console.error("Telegram API says file gone:", data.description);
                    return null; 
                }
            } catch (e) { 
                console.error("Network Error in getTelegramLink:", e); 
                return null;
            } 
        }

        // ফিক্সড: ইনফো মোডাল ওপেনার ফাংশন (MODIFIED FOR PRO MUSIC PLAYER)
window.openInfoModal = async function(id) { 
    const i = allInformation.find(x => x.id === id); 
    if (!i) {
        alert("Error: Information not found!");
        return; 
    }
    
    infoModal.style.display = 'flex'; 
    infoModalHeader.innerHTML = `<h2>${i.title}</h2>`; 
    infoModalBody.innerHTML = ''; 
    infoModalFooter.innerHTML = ''; 

    try {
        // --- TEXT CATEGORY ---
        if (i.category === 'text') {
            infoModalBody.style.whiteSpace = 'pre-wrap'; 
            infoModalBody.style.textAlign = 'left';
            infoModalBody.innerText = i.fullContent; 
            infoModalFooter.innerHTML = `
                <button class="btn" style="background: var(--success); color: black; font-weight: bold; width: 100%;" 
                    onclick="navigator.clipboard.writeText(\`${i.fullContent.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`); alert('Text Copied! ✅')">
                    <i class="fas fa-copy"></i> COPY TEXT
                </button>
            `;
        }
        // --- LINK CATEGORY ---
        else if (i.category === 'link') {
            infoModalBody.innerHTML = `
                <div style="padding:10px; text-align:center;">
                    <button class="btn" onclick="openExternalLink('${i.fullContent}')" style="background:var(--secondary); margin-bottom:10px; display:block; width:100%; font-weight:bold;">
                        OPEN LINK <i class="fas fa-external-link-alt"></i>
                    </button>
                    <button class="btn" onclick="navigator.clipboard.writeText('${i.fullContent}'); alert('Link Copied! ✅');" style="background:var(--success); color:white; margin-bottom:10px; display:block; width:100%;">
                        COPY LINK <i class="fas fa-copy"></i>
                    </button>
                    <p style="margin-top:15px; word-break:break-all; font-size:0.85rem; color:#ccc; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                        ${i.fullContent}
                    </p>
                </div>`;
        }
        // --- MAIL CATEGORY ---
        else if (i.category === 'mail') { 
            let mailHtml = `<div style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.8rem; color:#aaa;">Select & Share:</span>
                <button class="btn" onclick="shareSelectedMails('${i.id}')" style="width:auto; padding:5px 15px; font-size:0.8rem; background:var(--success); color:black; font-weight:bold;">Share Selected <i class="fas fa-layer-group"></i></button>
            </div>`;

            i.fullContent.split('|||').forEach((acc, idx) => { 
                const [e, p] = acc.split(' | Password: ').map(s => s.replace('Email: ', '')); 
                mailHtml += `
                <div class="mail-entry-box" style="display:flex; gap:12px; align-items:flex-start;">
                    <input type="checkbox" class="mail-select-checkbox" data-idx="${idx}" style="width:18px; height:18px; margin-top:5px; cursor:pointer;">
                    <div style="flex:1;">
                        <h4 style="margin-bottom:8px; font-size:0.9rem; color:var(--primary); display:flex; justify-content:space-between; align-items:center;">
                            Account ${idx+1}
                            <button onclick="shareInformation('${i.id}', false, ${idx})" style="background:none; border:none; color:var(--success); cursor:pointer; font-size:1rem;" title="Share this account only">
                                <i class="fas fa-share-nodes"></i>
                            </button>
                        </h4>
                        <div class="mail-row-compact"><div>${e}</div><button class="copy-btn-small" onclick="navigator.clipboard.writeText('${e}')"><i class="fas fa-copy"></i></button></div>
                        <div class="mail-row-compact"><div>${p||''}</div><button class="copy-btn-small" onclick="navigator.clipboard.writeText('${p||''}')"><i class="fas fa-copy"></i></button></div>
                    </div>
                </div>`; 
            }); 
            infoModalBody.innerHTML = mailHtml;
            infoModalFooter.innerHTML = `<button class="btn" style="background:var(--secondary); color:white;" onclick="downloadMailPDF('${i.id}')"><i class="fas fa-file-pdf"></i> Download PDF</button>`; 
        }
        // --- MEDIA CATEGORIES (Photo, Video, Audio, File) ---
        else if (['photo', 'video', 'audio', 'file'].includes(i.category)) { 
            
            // সার্ভার চেক করা হচ্ছে
            const url = await getTelegramLink(i.fullContent); 
            
            // যদি টেলিগ্রামে ফাইল না পাওয়া যায়
            if (!url) { 
                infoModalBody.innerHTML = `
                    <div style="text-align:center; padding:20px;">
                        <i class="fas fa-trash-alt" style="font-size:3rem; color:var(--danger); margin-bottom:15px;"></i>
                        <h3 style="color:var(--danger);">File Deleted!</h3>
                        <p style="color:#ccc; font-size:0.9rem;">This file has been removed from the server.</p>
                    </div>`; 
                return; 
            } 

            // ফাইল পাওয়া গেলে ক্যাটাগরি অনুযায়ী শো করা
            if (i.category === 'photo') { 
                infoModalBody.innerHTML = `<img src="${url}" style="max-width:100%; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.5);">`; 
                infoModalFooter.innerHTML = `<a href="${url}" target="_blank" class="btn" download>Download Image</a>`; 
            } 
            else if (i.category === 'video') { 
                infoModalBody.innerHTML = `<video controls autoplay style="width:100%; border-radius:10px;"><source src="${url}" type="video/mp4"></video>`; 
                infoModalFooter.innerHTML = `<a href="${url}" target="_blank" class="btn">Download Video</a>`; 
            } 
            // *** AUDIO (Updated for Professional Player) ***
            else if (i.category === 'audio') { 
                infoModalBody.innerHTML = `
                <div style="padding:30px 20px; text-align:center;">
                    <div style="width: 100px; height: 100px; background: rgba(33, 212, 253, 0.1); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary); box-shadow: 0 0 25px rgba(33,212,253,0.2);">
                        <i class="fas fa-music" style="font-size:3.5rem; color:var(--primary);"></i>
                    </div>
                    <h2 style="margin-bottom: 10px; color:white; font-size:1.5rem;">${i.title}</h2>
                    <p style="color:#aaa; font-size:0.9rem; margin-bottom:30px;">Music Track</p>
                    
                    <button onclick="openProPlayer('${i.id}')" class="open-player-btn" style="width:100%; background: linear-gradient(90deg, #21D4FD, #B721FF); color:white; font-size:1.1rem; padding:15px; border-radius:50px; font-weight:bold; box-shadow: 0 10px 30px rgba(183,33,255,0.4);">
                        <i class="fas fa-play" style="margin-right:10px;"></i> PLAY NOW
                    </button>
                </div>`; 
                
                infoModalFooter.innerHTML = `<a href="${url}" target="_blank" class="btn" style="background:rgba(255,255,255,0.1); border:none; width:100%; margin-top:10px;">Download Audio File</a>`; 
            } 
            else if (i.category === 'file') { 
                infoModalBody.innerHTML = `<div style="text-align:center; padding:20px;"><i class="fas fa-file-alt" style="font-size:4rem; color:var(--primary);"></i><p style="margin-top:15px;">Document Ready</p></div>`; 
                infoModalFooter.innerHTML = `<a href="${url}" target="_blank" class="btn">Open / Download File</a>`; 
            } 
        } 
    } catch (err) {
        console.error(err);
        infoModalBody.innerHTML = `<p style="color:red; text-align:center;">Something went wrong!<br><small>${err.message}</small></p>`;
    }
}
        
        
        
        // --- PROFESSIONAL MUSIC PLAYER LOGIC (SINGLE SOURCE) ---

let currentPlaylist = [];
let currentIndex = -1;
const audioPlayer = document.getElementById('global-audio-player');

// ১. Info Modal এ অডিও প্লেয়ার রিমুভ করে শুধু বাটন রাখা
// (আপনাকে আপনার openInfoModal এর অডিও পার্টটুকু এই কোড দিয়ে রিপ্লেস করতে হবে)
/* 
   else if (i.category === 'audio') { 
       infoModalBody.innerHTML = `
       <div style="padding:30px 20px; text-align:center;">
           <div style="width: 80px; height: 80px; background: rgba(33, 212, 253, 0.1); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--primary);">
               <i class="fas fa-music" style="font-size:2.5rem; color:var(--primary);"></i>
           </div>
           <h3 style="margin-bottom: 5px; color:white;">${i.title}</h3>
           <p style="color:#aaa; font-size:0.8rem; margin-bottom:25px;">Audio File</p>
           
           <button onclick="openProPlayer('${i.id}')" class="open-player-btn" style="background: var(--primary); color:black; font-size:1rem; padding:15px; box-shadow: 0 0 20px rgba(33,212,253,0.3);">
               <i class="fas fa-play"></i> PLAY NOW
           </button>
       </div>`; 
       infoModalFooter.innerHTML = `<a href="${url}" target="_blank" class="btn" style="width:100%">Download File</a>`; 
   } 
*/

// ২. প্লেয়ার ওপেন করার মেইন ফাংশন (স্মার্ট আপডেট)
window.openProPlayer = function(targetId) {
    // আগের ইনফো মোডাল বন্ধ করা
    document.getElementById('info-modal').style.display = 'none';
    document.getElementById('global-music-modal').style.display = 'flex';

    // ১. প্লেলিস্ট তৈরি করা (ডাটাবেস থেকে)
    currentPlaylist = allInformation.filter(item => item.category === 'audio');
    
    // ২. লজিক চেক:
    // ক) যদি কোনো নির্দিষ্ট গানে (Play Now) ক্লিক করা হয় (targetId আছে)
    if (targetId) {
        const targetIndex = currentPlaylist.findIndex(s => s.id === targetId);
        // যদি গানটি ভিন্ন হয় বা প্লেয়ার পজ থাকে, তবেই প্লে হবে
        if (currentIndex !== targetIndex || audioPlayer.paused) {
            loadAndPlayTrack(targetIndex);
        }
        renderProPlaylist(targetId); // লিস্টে গানটি মার্ক করা হবে
    } 
    // খ) যদি ফ্লোটিং মিউজিক বাটনে ক্লিক করা হয় (targetId নেই / null)
    else {
        // যদি বর্তমানে কোনো গান লোড করা থাকে
        if (currentIndex !== -1 && currentPlaylist[currentIndex]) {
            const currentSong = currentPlaylist[currentIndex];
            
            // টাইটেল এবং বাটন আপডেট করা (যাতে আগের অবস্থা ঠিক থাকে)
            document.getElementById('pro-track-title').innerText = currentSong.title;
            updatePlayIcon(!audioPlayer.paused);
            
            // লিস্ট রেন্ডার করা এবং বর্তমান গানটি মার্ক করা
            renderProPlaylist(currentSong.id);
        } else {
            // যদি কোনো গান লোড না থাকে (প্রথমবার ওপেন)
            renderProPlaylist(null);
            document.getElementById('pro-track-title').innerText = "Select a Song";
        }
    }
}

// ৩. গান লোড এবং প্লে করা (টাইম ফিক্স - আপডেটেড)
async function loadAndPlayTrack(index) {
    if (index < 0 || index >= currentPlaylist.length) return;
    
    currentIndex = index;
    const song = currentPlaylist[index];
    
    // টাইটেল আপডেট
    document.getElementById('pro-track-title').innerText = song.title;
    updatePlayIcon(false); 
    
    // টাইম রিসেট
    document.getElementById('pro-curr-time').innerText = "0:00";
    document.getElementById('pro-dur-time').innerText = "--:--"; // ডিফল্ট ভ্যালু

    // লিংক আনা
    const url = await getTelegramLink(song.fullContent);
    
    if(url) {
        audioPlayer.src = url;
        audioPlayer.load(); // ফোর্স লোড

        // গান লোড হলে অটোমেটিক প্লে এবং টাইম সেট হবে
        audioPlayer.oncanplay = () => {
            audioPlayer.play();
            updatePlayIcon(true);
            // এখানে মোট সময় সেট হবে
            if (audioPlayer.duration) {
                document.getElementById('pro-dur-time').innerText = formatTime(audioPlayer.duration);
            }
        };

        renderProPlaylist(song.id); 
    } else {
        document.getElementById('pro-track-title').innerText = "Error Loading File";
    }
}
// ৪. টাইম এবং প্রোগ্রেস বার আপডেট লজিক (ফিক্সড)
audioPlayer.addEventListener('timeupdate', () => {
    const currentTime = audioPlayer.currentTime;
    const duration = audioPlayer.duration;

    // ১. বর্তমান সময় আপডেট
    const currTimeText = formatTime(currentTime);
    document.getElementById('pro-curr-time').innerText = currTimeText;

    // ২. মোট সময় এবং বার আপডেট (যদি গান লোড হয়ে থাকে)
    if (!isNaN(duration) && duration > 0) {
        // টোটাল টাইম সেট
        document.getElementById('pro-dur-time').innerText = formatTime(duration);
        
        // প্রোগ্রেস বার আপডেট (যদি ইউজার টেনে না ধরে থাকে)
        if (!isDraggingBar) {
            const progressPercent = (currentTime / duration) * 100;
            document.getElementById('pro-progress-fill').style.width = `${progressPercent}%`;
        }
    }
});

// সময় ফরম্যাট করার ফাংশন (যদি না থাকে তবে এটি নিচে বসিয়ে দিন)
function formatTime(seconds) {
    if (isNaN(seconds)) return "0:00";
    const min = Math.floor(seconds / 60);
    const sec = Math.floor(seconds % 60);
    return `${min}:${sec < 10 ? '0' : ''}${sec}`;
}

// 5. প্লেলিস্ট রেন্ডার
function renderProPlaylist(activeId) {
    const container = document.getElementById('music-playlist-container');
    container.innerHTML = '';
    
    currentPlaylist.forEach((song, idx) => {
        const div = document.createElement('div');
        div.className = `music-item ${song.id === activeId ? 'active' : ''}`;
        div.onclick = () => loadAndPlayTrack(idx);
        
        div.innerHTML = `
            <div style="display:flex; align-items:center;">
                <div class="music-icon" style="width:35px; height:35px; font-size:0.9rem;">${idx + 1}</div>
                <div class="music-info">
                    <div class="music-title" style="font-size:0.85rem;">${song.title}</div>
                </div>
                ${song.id === activeId ? '<i class="fas fa-volume-up" style="color:var(--primary);"></i>' : ''}
            </div>
        `;
        container.appendChild(div);
    });
}

// 6. কন্ট্রোলস (Play/Pause, Next, Prev)
window.togglePlayPause = function() {
    if (audioPlayer.paused) {
        audioPlayer.play();
        updatePlayIcon(true);
    } else {
        audioPlayer.pause();
        updatePlayIcon(false);
    }
}

window.nextTrack = function() {
    let nextIdx = currentIndex + 1;
    if (nextIdx >= currentPlaylist.length) nextIdx = 0; // লুপ
    loadAndPlayTrack(nextIdx);
}

window.prevTrack = function() {
    let prevIdx = currentIndex - 1;
    if (prevIdx < 0) prevIdx = currentPlaylist.length - 1; // লুপ
    loadAndPlayTrack(prevIdx);
}

function updatePlayIcon(isPlaying) {
    const icon = document.getElementById('pro-play-icon');
    if (isPlaying) {
        icon.className = 'fas fa-pause';
    } else {
        icon.className = 'fas fa-play';
    }
}



// ৩. প্রোগ্রেস বার ড্র্যাগিং (চেপে ধরে টানা) লজিক
const progressArea = document.getElementById('pro-progress-area');
const progressBarFill = document.getElementById('pro-progress-fill');
let isDraggingBar = false;

// টাচ শুরু (মোবাইল) বা মাউস ক্লিক (পিসি)
function startDrag(e) {
    isDraggingBar = true;
    updateBarOnDrag(e);
}

// টাচ মুভ বা মাউস মুভ
function moveDrag(e) {
    if (isDraggingBar) {
        updateBarOnDrag(e);
    }
}

// টাচ শেষ বা মাউস ছেড়ে দেওয়া
function endDrag(e) {
    if (isDraggingBar) {
        isDraggingBar = false;
        const player = document.getElementById('global-audio-player');
        
        // ফাইনাল পজিশন অনুযায়ী গান সেট করা
        const width = progressArea.clientWidth;
        let clientX = e.clientX || e.changedTouches[0].clientX;
        // মোডালের পজিশন এডজাস্ট করা
        const rect = progressArea.getBoundingClientRect();
        clientX = clientX - rect.left;
        
        const duration = player.duration;
        player.currentTime = (clientX / width) * duration;
    }
}

function updateBarOnDrag(e) {
    const width = progressArea.clientWidth;
    const rect = progressArea.getBoundingClientRect();
    let clientX = (e.clientX || e.touches[0].clientX) - rect.left;
    
    // সীমানার বাইরে যাতে না যায়
    if(clientX < 0) clientX = 0;
    if(clientX > width) clientX = width;

    const percent = (clientX / width) * 100;
    progressBarFill.style.width = `${percent}%`;
    
    // টাইম আপডেট করা (ড্র্যাগ করার সময়)
    const player = document.getElementById('global-audio-player');
    if(player.duration) {
        const tempTime = (clientX / width) * player.duration;
        document.getElementById('pro-curr-time').innerText = formatTime(tempTime);
    }
}

// ইভেন্ট লিসেনার যুক্ত করা
progressArea.addEventListener('mousedown', startDrag);
progressArea.addEventListener('touchstart', startDrag, {passive: false});

document.addEventListener('mousemove', moveDrag);
document.addEventListener('touchmove', moveDrag, {passive: false});

document.addEventListener('mouseup', endDrag);
document.addEventListener('touchend', endDrag);

// ৪. অডিও টাইম আপডেট লজিক (ড্র্যাগ না করলে অটো চলবে)
audioPlayer.addEventListener('timeupdate', () => {
    if (!isDraggingBar) { // যদি ইউজার টেনে না ধরে থাকে, তবেই অটো আপডেট হবে
        const { currentTime, duration } = audioPlayer;
        if (isNaN(duration)) return;

        const percent = (currentTime / duration) * 100;
        document.getElementById('pro-progress-fill').style.width = `${percent}%`;
        document.getElementById('pro-curr-time').innerText = formatTime(currentTime);
        document.getElementById('pro-dur-time').innerText = formatTime(duration);
    }
});
// --- EQUALIZER ANIMATION LOGIC ---

const musicBtnTrigger = document.getElementById('music-button-trigger');
const globalPlayer = document.getElementById('global-audio-player');

// ১. গান প্লে হলে এনিমেশন চালু
globalPlayer.addEventListener('play', () => {
    if(musicBtnTrigger) {
        musicBtnTrigger.classList.add('playing');
    }
});

// ২. গান পজ বা শেষ হলে এনিমেশন বন্ধ
globalPlayer.addEventListener('pause', () => {
    if(musicBtnTrigger) {
        musicBtnTrigger.classList.remove('playing');
    }
});
globalPlayer.addEventListener('ended', () => {
    if(musicBtnTrigger) {
        musicBtnTrigger.classList.remove('playing');
    }
});





        window.downloadMailPDF = function(id) { const i = allInformation.find(x => x.id === id); if (!i) return; const doc = new jsPDF(); doc.text(i.title, 10, 10); doc.setFontSize(11); let y = 20; i.fullContent.split('|||').forEach((acc, idx) => { if (y > 270) { doc.addPage(); y = 10; } const [e, p] = acc.split(' | Password: ').map(s => s.replace('Email: ', '')); doc.text(`${idx+1}. Email: ${e}`, 10, y); doc.text(`   Password: ${p || 'N/A'}`, 10, y+5); y += 15; }); doc.save(`${i.title}.pdf`); }
        window.openContactInfo = function(id) {
    const c = allContacts.find(x => x.id === id);
    if (!c) return;

    // মোডাল হেডার ঠিক করা
    infoModalHeader.innerHTML = `
        <div style="text-align:left; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
            <h2 style="color:var(--primary); margin:0; font-size:1.4rem;">${c.name}</h2>
            <small style="color:#aaa;">Full Contact Details</small>
        </div>`;

    let html = '';

    // ১. নাম কপি করার রো
    html += createDetailRow("Full Name", c.name);

    // ২. ফোন নম্বরগুলো সিরিয়াল অনুযায়ী সাজানো
    if(c.phone && c.phone.length > 0) {
        c.phone.forEach((p, idx) => {
            html += createDetailRow(`Phone Number ${idx + 1}`, p);
        });
    }

    // ৩. ইমেইল কপি করার রো
    if(c.email) {
        html += createDetailRow("Email Address", c.email);
    }

    // ৪. ঠিকানা কপি করার রো
    if(c.address) {
        html += createDetailRow("Physical Address", c.address);
    }

    // ৫. সোশ্যাল লিঙ্ক কপি করার রো (যদি থাকে)
    if(c.socialLinks && c.socialLinks.length > 0) {
        c.socialLinks.forEach((link, idx) => {
            html += createDetailRow(`Social Link ${idx + 1}`, link);
        });
    }

    infoModalBody.innerHTML = `<div style="margin-top: 15px;">${html}</div>`;
    infoModalFooter.innerHTML = ''; // নিচের ফাকা অংশ ক্লিয়ার রাখা
    infoModal.style.display = 'flex';
};

// কপিযোগ্য রো তৈরি করার হেল্পার ফাংশন
function createDetailRow(label, value) {
    if(!value) return '';
    const cleanValue = value.replace(/'/g, "\\'"); // কোটেশন থাকলে ফিক্স করা
    return `
        <div class="modal-info-row">
            <div style="flex: 1; padding-right: 10px;">
                <span class="modal-info-label">${label}</span>
                <span class="modal-info-text">${value}</span>
            </div>
            <button class="copy-btn-action" title="Copy ${label}" onclick="navigator.clipboard.writeText('${cleanValue}'); alert('${label} Copied!')">
                <i class="fa-regular fa-copy"></i>
            </button>
        </div>
    `;
}
// Hisab এর যেকোনো এন্ট্রি ডিলিট করার ফাংশন
window.deleteHisabItem = function(collectionName, id) {
    window.confirmDelete("Are you sure you want to delete this?", function() {
        // ফায়ারবেস থেকে ডাটা ডিলিট করার লজিক
        db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection(collectionName).doc(id).delete().then(() => {
            // ডিলিট হওয়ার পর ডাটা রিফ্রেশ করা
            fetchDataFromFirestore(); 
            alert("Deleted successfully! ✅");
        }).catch(err => {
            alert("There was a problem deleting: " + err.message);
        });
    });
};
// এটি আপনার স্ক্রিপ্টের শেষে বা অন্য ফাংশনের বাইরে বসান
window.viewBankHistory = async function(bankId, bankName) {
    console.log("History clicked for:", bankName); // চেক করার জন্য
    
    const infoModal = document.getElementById('info-modal');
    const header = document.getElementById('info-modal-header');
    const body = document.getElementById('info-modal-body');
    const footer = document.getElementById('info-modal-footer');

    if (!infoModal) {
        alert("Modal error: info-modal not found!");
        return;
    }

    // মোডাল ওপেন করা
    infoModal.style.display = 'flex';
    header.innerHTML = `<h2>${bankName} - History</h2>`;
    body.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
    footer.innerHTML = '';

    try {
        // সহজ কুয়েরি (ইডেক্স সমস্যা এড়াতে orderBy পরে যোগ করা যাবে)
        const snap = await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1")
            .collection('bank_transactions')
            .where('bankId', '==', bankId)
            .get();

        if (snap.empty) {
            body.innerHTML = '<p style="text-align:center; color:#aaa; padding:20px;">No history found for this bank.</p>';
            return;
        }

        let transactions = [];
        snap.forEach(doc => transactions.push(doc.data()));

        // জাভাস্ক্রিপ্ট দিয়ে সর্টিং (নতুন লেনদেন উপরে দেখাবে)
        transactions.sort((a, b) => b.createdAt - a.createdAt);

        let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
        transactions.forEach(t => {
            const isDep = t.type === 'dep';
            html += `
                <div class="hisab-card" style="border-left: 4px solid ${isDep ? '#10B981' : '#EF4444'}; margin-bottom:0; background:rgba(255,255,255,0.03); padding:12px; border-radius:12px;">
                    <div class="row-between" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b style="color:${isDep ? '#10B981' : '#EF4444'}; font-size:0.8rem; text-transform:uppercase;">${isDep ? 'Deposit' : 'Withdraw'}</b><br>
                            <small style="color:#aaa; font-size:0.75rem;">${t.date || ''} | ${t.time || ''}</small>
                        </div>
                        <div style="text-align:right;">
                            <b style="font-size:1.1rem; color:#fff;">${isDep ? '+' : '-'} ৳${t.amount}</b>
                        </div>
                    </div>
                </div>`;
        });
        html += '</div>';
        body.innerHTML = html;
        
    } catch (e) {
        console.error("History Error:", e);
        body.innerHTML = `<p style="color:red; text-align:center; padding:10px;">Error: ${e.message}</p>`;
    }
}
window.viewGoalHistory = async function(goalId, goalName) {
    const infoModal = document.getElementById('info-modal');
    const header = document.getElementById('info-modal-header');
    const body = document.getElementById('info-modal-body');
    const footer = document.getElementById('info-modal-footer');

    infoModal.style.display = 'flex';
    header.innerHTML = `<h2>${goalName} - History</h2>`;
    body.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Loading Goal Records...</div>';
    footer.innerHTML = '';

    try {
        const snap = await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1")
            .collection('goal_transactions')
            .where('goalId', '==', goalId)
            .get();

        if (snap.empty) {
            body.innerHTML = '<p style="text-align:center; color:#aaa; padding:20px;">No transaction history found for this goal.</p>';
            return;
        }

        let transactions = [];
        snap.forEach(doc => transactions.push(doc.data()));
        transactions.sort((a, b) => b.createdAt - a.createdAt);

        let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
        transactions.forEach(t => {
            const isAdd = t.type === 'add';
            html += `
                <div class="hisab-card" style="border-left: 4px solid ${isAdd ? '#EA580C' : '#EF4444'}; margin-bottom:0; background:rgba(255,255,255,0.03); padding:12px; border-radius:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b style="color:${isAdd ? '#EA580C' : '#EF4444'}; font-size:0.8rem;">${isAdd ? 'SAVED' : 'WITHDRAW'}</b><br>
                            <small style="color:#aaa;">${t.date} | ${t.time}</small>
                        </div>
                        <b style="font-size:1.1rem; color:#fff;">${isAdd ? '+' : '-'} ৳${t.amount}</b>
                    </div>
                </div>`;
        });
        html += '</div>';
        body.innerHTML = html;
    } catch (e) {
        body.innerHTML = `<p style="color:red; text-align:center;">Error: ${e.message}</p>`;
    }
}
window.viewDpsHistory = async function(dpsId, bankName) {
    const infoModal = document.getElementById('info-modal');
    const header = document.getElementById('info-modal-header');
    const body = document.getElementById('info-modal-body');

    const dps = dpsData.find(d => d.id === dpsId);
    if (!dps) return;

    infoModal.style.display = 'flex';
    header.innerHTML = `<h2>${bankName} - History</h2>`;
    body.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';
    document.getElementById('info-modal-footer').innerHTML = '';

    try {
        const snap = await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1")
            .collection('dps_transactions').where('dpsId', '==', dpsId).get();

        let transactions = [];
        snap.forEach(doc => transactions.push(doc.data()));
        transactions.sort((a, b) => b.createdAt - a.createdAt);

        // --- মিসিং লিস্ট তৈরি ---
        let missedHtml = '';
        let nextDateObj = new Date(dps.nextDate);
        const today = new Date();
        
        // গত মাসের শেষ দিন পর্যন্ত চেক করব (কারণ চলতি মাস মেইন বাটনে আছে)
        const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0); 

        // লুপ: বকেয়া মাসগুলো বের করা
        while (nextDateObj <= lastMonthEnd) {
            const monthName = nextDateObj.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            missedHtml += `
            <div class="hisab-card" style="border-left: 4px solid #EF4444; background:rgba(239, 68, 68, 0.15); padding:10px; margin-bottom:10px; border-radius:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div><b style="color:#EF4444;">MISSED: ${monthName}</b></div>
                    <button onclick="payMissedDps('${dpsId}', '${monthName}')" style="background:#EF4444; color:white; border:none; padding:6px 12px; border-radius:50px; cursor:pointer;">PAY NOW</button>
                </div>
            </div>`;
            nextDateObj.setMonth(nextDateObj.getMonth() + 1);
        }

        if(!missedHtml) missedHtml = `<div style="text-align:center; color:#10B981; padding:10px; margin-bottom:10px; background:rgba(16,185,129,0.1); border-radius:8px;">No Previous Dues!</div>`;

        // --- হিস্ট্রি লিস্ট ---
        let historyHtml = '<h4 style="color:#aaa; border-bottom:1px solid #333; margin-top:15px;">Transactions</h4>';
        transactions.forEach(t => {
            historyHtml += `
            <div class="hisab-card" style="border-left:4px solid var(--success); background:rgba(255,255,255,0.03); padding:8px; margin-bottom:8px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between;">
                    <div><b style="color:var(--success); font-size:0.8rem;">${t.note || 'Paid'}</b><br><small style="color:#aaa;">${t.date}</small></div>
                    <b>৳${t.amount}</b>
                </div>
            </div>`;
        });

        body.innerHTML = `<div style="max-height:60vh; overflow-y:auto;">${missedHtml}${historyHtml}</div>`;

    } catch (e) { body.innerHTML = "Error loading history."; }
}

// মিসিং পেমেন্ট ফাংশন (শুধু nextDate আপডেট করবে)
window.payMissedDps = async function(id, monthName) {
    const d = dpsData.find(x => x.id === id);
    if(!d) return;

    window.confirmDelete(`Pay MISSED installment for ${monthName}?`, async function() {
        // nextDate ১ মাস বাড়ানো
        let nextDateObj = new Date(d.nextDate);
        nextDateObj.setMonth(nextDateObj.getMonth() + 1);
        
        await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('dps_schemes').doc(id).update({
            paid: parseFloat(d.paid) + parseFloat(d.monthly),
            nextDate: nextDateObj.toISOString().split('T')[0]
        });

        // হিস্ট্রি সেভ
        await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('dps_transactions').add({
            dpsId: id, bankName: d.bank, amount: parseFloat(d.monthly),
            date: new Date().toISOString().split('T')[0],
            note: `Missed: ${monthName}`,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('info-modal').style.display = 'none';
        await fetchDataFromFirestore();
        alert("Missed Payment Cleared! ✅");
    });
}
// বকেয়া কিস্তি পেমেন্ট করার স্পেশাল ফাংশন (কোনো তারিখ চেক ছাড়া)
window.payMissedDps = async function(id, monthName) {
    const d = dpsData.find(x => x.id === id);
    if(!d) return;

    window.confirmDelete(`Pay missed installment for ${monthName}? Amount: ৳${d.monthly}`, async function() {
        try {
            // ১. পরবর্তী ডেট আপডেট করা (বর্তমান nextDate এর সাথে ১ মাস যোগ হবে)
            let currentDate = new Date(d.nextDate);
            currentDate.setMonth(currentDate.getMonth() + 1);
            let nextDateString = currentDate.toISOString().split('T')[0];
            
            // ২. ব্যালেন্স এবং ডেট আপডেট
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('dps_schemes').doc(id).update({
                paid: parseFloat(d.paid || 0) + parseFloat(d.monthly || 0),
                nextDate: nextDateString
            });

            // ৩. ট্রানজেকশন হিস্ট্রি সেভ করা (Missed Payment হিসেবে নোট থাকবে)
            const now = new Date();
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('dps_transactions').add({
                dpsId: id,
                bankName: d.bank,
                amount: parseFloat(d.monthly),
                date: now.toISOString().split('T')[0],
                time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                note: `Missed Payment for ${monthName}`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // ৪. রিফ্রেশ
            // মোডাল বন্ধ করে ডাটা রিফ্রেশ করা
            document.getElementById('info-modal').style.display = 'none';
            await fetchDataFromFirestore();
            alert(`Payment successful for ${monthName}! ✅`);
            
            // চাইলে আবার হিস্ট্রি ওপেন করে দেখাতে পারেন
            // viewDpsHistory(id, d.bank); 

        } catch(e) {
            alert("Error processing payment! ❌ " + e.message);
        }
    });
}



        window.deleteInfo = function(id) { 
    window.confirmDelete('Want to delete it?', function() {
        db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('informations').doc(id).delete().then(() => {
            fetchDataFromFirestore();
            alert("Deleted!");
        });
    });
}
        window.deleteContact = function(id) { 
    window.confirmDelete('Delete the contact?', function() {
        db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('contacts').doc(id).delete().then(() => {
            fetchDataFromFirestore();
            alert("Contact Deleted!");
        });
    });
}
        window.editInfo = function(id) { 
    const i = allInformation.find(x => x.id === id); 
    if (!i) return; 
    
    // পেজ পরিবর্তন
    window.switchPage('add-info');
    editingDocId = id; 
    
    // ফর্মের লেখা পরিবর্তন
    document.getElementById('info-form-title').innerText = "Update Information";
    document.getElementById('info-submit-btn').innerText = "Update Now";

    // ডাটা বসানো
    document.getElementById('info-title').value = i.title; 
    infoCategory.value = i.category; 
    infoCategory.dispatchEvent(new Event('change')); 

    if(i.category === 'text') {
        document.getElementById('info-content').value = i.fullContent; 
    } else if(i.category === 'link') {
        document.getElementById('info-link').value = i.fullContent; 
    } else if(i.category === 'mail') {
        // মেইল এবং পাসওয়ার্ডের ঘরগুলো তৈরি করা
        const mailRowsContainer = document.getElementById('mail-rows-container');
        mailRowsContainer.innerHTML = ''; // আগের খালি ঘর মুছে ফেলা
        
        const entries = i.fullContent.split('|||');
        entries.forEach(entry => {
            const [ePart, pPart] = entry.split(' | Password: ');
            const email = ePart.replace('Email: ', '');
            const pass = pPart || '';
            renderMailRow(email, pass); // মেইল এবং পাসওয়ার্ড এর ঘর তৈরি
        });
        
        // সবশেষে একটি নতুন প্লাস বাটনওয়ালা ঘর যোগ করা (যদি নতুন কিছু যোগ করতে চান)
        mailRowsContainer.insertAdjacentHTML('beforeend', `<div class="mail-input-group"><input type="email" class="mail-email" placeholder="Email"><input type="text" class="mail-password" placeholder="Pass"><button type="button" class="add-mail-btn btn">+</button></div>`);
    }
}
        window.editContact = function(id) { 
    const c = allContacts.find(x => x.id === id); 
    if (!c) return; 
    
    openAddContactPage(); 
    switchPage('add-contact');
    editingDocId = id; 
    
    // ১. টাইটেল এবং বাটনের লেখা পরিবর্তন
    document.querySelector('#add-contact-page h2').innerText = "Update Contact";
    document.getElementById('contact-submit-btn').innerText = "Update Now";
    
    // ২. এডিট করার সময় বাল্ক ইম্পোর্ট অপশনটি হাইড করা
    document.querySelector('#add-contact-page .toggle-label').style.display = 'none';
    contactBulkToggle.checked = false; 
    document.getElementById('single-contact-mode').style.display = 'block';
    document.getElementById('bulk-contact-mode').style.display = 'none';
    
    // ৩. ডাটা বসানো
    document.getElementById('contact-name').value = c.name; 
    document.getElementById('contact-email').value = c.email; 
    document.getElementById('contact-address').value = c.address; 

    // ফোন নম্বরগুলোর ঘর তৈরি করা
    const phoneCont = document.getElementById('phone-numbers-container');
    phoneCont.innerHTML = ''; 
    if (c.phone && c.phone.length > 0) {
        c.phone.forEach((p, idx) => {
            const btnClass = idx === 0 ? 'add-phone-btn' : 'remove-btn';
            const btnChar = idx === 0 ? '+' : '-';
            phoneCont.insertAdjacentHTML('beforeend', `
                <div class="phone-input-group">
                    <input type="tel" class="contact-phone" value="${p}" placeholder="Phone">
                    <button type="button" class="${btnClass} btn">${btnChar}</button>
                </div>`);
        });
    }

    // সোশ্যাল লিঙ্কের ঘর তৈরি করা
    const socialCont = document.getElementById('social-links-container');
    socialCont.innerHTML = ''; 
    if (c.socialLinks && c.socialLinks.length > 0) {
        c.socialLinks.forEach((l, idx) => {
            const btnClass = idx === 0 ? 'add-social-btn' : 'remove-btn';
            const btnChar = idx === 0 ? '+' : '-';
            socialCont.insertAdjacentHTML('beforeend', `
                <div class="social-input-group">
                    <input type="url" class="contact-social" value="${l}" placeholder="Link">
                    <button type="button" class="${btnClass} btn">${btnChar}</button>
                </div>`);
        });
    } else {
        socialCont.innerHTML = `<div class="social-input-group"><input type="url" class="contact-social" placeholder="Link"><button type="button" class="add-social-btn btn">+</button></div>`;
    }
}
        function resetAddInfoForm() { 
    editingDocId = null; 
    addInfoForm.reset(); 
    
    // লেখাগুলো আবার আগের মতো করে দেওয়া
    document.getElementById('info-form-title').innerText = "Add New Information";
    document.getElementById('info-submit-btn').innerText = "Add Information";
    
    infoCategory.dispatchEvent(new Event('change')); 
}
        function resetAddContactForm() { 
    editingDocId = null; 
    addContactForm.reset(); 
    
    // টাইটেল, বাটন এবং বাল্ক অপশন আবার আগের মতো করা
    document.querySelector('#add-contact-page h2').innerText = "Add New Contact";
    document.getElementById('contact-submit-btn').innerText = "Add Contact";
    document.querySelector('#add-contact-page .toggle-label').style.display = 'flex';
    
    document.getElementById('bulk-contact-preview').innerHTML = ''; 
    
    // ফোন এবং সোশ্যাল এরিয়া রিসেট করা
    document.getElementById('phone-numbers-container').innerHTML = `<div class="phone-input-group"><input type="tel" class="contact-phone" placeholder="Phone"><button type="button" class="add-phone-btn btn">+</button></div>`;
    document.getElementById('social-links-container').innerHTML = `<div class="social-input-group"><input type="url" class="contact-social" placeholder="Link"><button type="button" class="add-social-btn btn">+</button></div>`;
}
        window.switchHisabTab = function(tab) { document.querySelectorAll('.hisab-view').forEach(v => v.classList.remove('active')); document.getElementById(`hisab-view-${tab}`).classList.add('active'); document.querySelectorAll('.hisab-tab').forEach(t => t.classList.remove('active')); event.currentTarget.classList.add('active'); }
        window.refreshHisabAll = function() {
    // ডাটা ক্যালকুলেশন
    let cash = dailyData.reduce((acc, t) => t.type === 'inc' ? acc + parseFloat(t.amount || 0) : acc - parseFloat(t.amount || 0), 0);
    let bank = bankData.reduce((acc, b) => acc + parseFloat(b.balance || 0), 0);
    let goal = goalData.reduce((acc, g) => acc + parseFloat(g.balance || 0), 0);
    let dps = dpsData.reduce((acc, d) => acc + parseFloat(d.paid || 0), 0);
    
    let total = cash + bank + goal + dps;
    if (total < 0) total = 0; // মাইনাস ব্যালেন্স হ্যান্ডেলিং

    // টেক্সট ভ্যালু আপডেট
    document.getElementById('hisab-net-worth-text').innerText = '৳ ' + total.toLocaleString();
    document.getElementById('dashboard-net-worth').innerText = '৳ ' + total.toLocaleString(); // ড্যাশবোর্ডের জন্য
    
    document.getElementById('h-cash-val').innerText = '৳ ' + cash.toLocaleString();
    document.getElementById('h-bank-val').innerText = '৳ ' + bank.toLocaleString();
    document.getElementById('h-goal-val').innerText = '৳ ' + goal.toLocaleString();
    document.getElementById('h-dps-val').innerText = '৳ ' + dps.toLocaleString();

    // পার্সেন্টেজ ক্যালকুলেশন
    let pCash = total > 0 ? ((cash / total) * 100).toFixed(1) : 0;
    let pBank = total > 0 ? ((bank / total) * 100).toFixed(1) : 0;
    let pGoal = total > 0 ? ((goal / total) * 100).toFixed(1) : 0;
    let pDps = total > 0 ? ((dps / total) * 100).toFixed(1) : 0;

    document.getElementById('h-cash-perc').innerText = pCash + '%';
    document.getElementById('h-bank-perc').innerText = pBank + '%';
    document.getElementById('h-goal-perc').innerText = pGoal + '%';
    document.getElementById('h-dps-perc').innerText = pDps + '%';

    // ডোনাট চার্টের এনিমেশন বা কালার আপডেট
    let s1 = parseFloat(pCash);
    let s2 = s1 + parseFloat(pBank);
    let s3 = s2 + parseFloat(pGoal);
    let s4 = s3 + parseFloat(pDps);

    const chart = document.getElementById('hisab-donut-chart');
    if(total > 0) {
        chart.style.background = `conic-gradient(
            #21D4FD 0% ${s1}%, 
            #B721FF ${s1}% ${s2}%, 
            #EA580C ${s2}% ${s3}%, 
            #10B981 ${s3}% ${s4}%, 
            rgba(255,255,255,0.1) ${s4}% 100%
        )`;
    } else {
        chart.style.background = `rgba(255,255,255,0.1)`;
    }

    // ড্যাশবোর্ড স্ট্যাটস আপডেট (Dashboard Page এর জন্য)
    if(document.getElementById('dash-cash')) document.getElementById('dash-cash').innerText = '৳ ' + cash.toLocaleString();
    if(document.getElementById('dash-bank')) document.getElementById('dash-bank').innerText = '৳ ' + bank.toLocaleString();
    if(document.getElementById('dash-savings')) document.getElementById('dash-savings').innerText = '৳ ' + (goal + dps).toLocaleString();

// এই অংশটুকু refreshHisabAll ফাংশনের একদম শেষে বসান
const now = new Date();
const currentMonth = now.getMonth();
const currentYear = now.getFullYear();

// এই মাসের আয়ের হিসাব
let monthIncome = dailyData
    .filter(t => t.type === 'inc' && new Date(t.date).getMonth() === currentMonth && new Date(t.date).getFullYear() === currentYear)
    .reduce((acc, t) => acc + parseFloat(t.amount || 0), 0);

// এই মাসের খরচের হিসাব
let monthExpense = dailyData
    .filter(t => t.type === 'exp' && new Date(t.date).getMonth() === currentMonth && new Date(t.date).getFullYear() === currentYear)
    .reduce((acc, t) => acc + parseFloat(t.amount || 0), 0);

document.getElementById('month-income-val').innerText = '৳ ' + monthIncome.toLocaleString();
document.getElementById('month-expense-val').innerText = '৳ ' + monthExpense.toLocaleString();

// Ratio Calculation
let totalFlow = monthIncome + monthExpense;
if (totalFlow > 0) {
    let incPerc = (monthIncome / totalFlow) * 100;
    let expPerc = (monthExpense / totalFlow) * 100;
    document.getElementById('income-ratio-bar').style.width = incPerc + '%';
    document.getElementById('expense-ratio-bar').style.width = expPerc + '%';
}

// Budget Status Logic
const statusTag = document.getElementById('budget-status-tag');
if (monthExpense > monthIncome) {
    statusTag.innerText = "CRITICAL";
    statusTag.style.background = "rgba(230, 57, 70, 0.2)";
    statusTag.style.color = "#e63946";
} else {
    statusTag.innerText = "HEALTHY";
    statusTag.style.background = "rgba(16, 185, 129, 0.2)";
    statusTag.style.color = "#10B981";
}

// Net Worth Count-up Animation Call
animateValue("hisab-net-worth-text", 0, total, 1000);
//  সাম্প্রতিক ৩টি লেনদেন লিস্ট রেন্ডার (Sorting Fix)
    const recentList = document.getElementById('quick-recent-list');
    recentList.innerHTML = '';

    // ডাটাগুলোকে তারিখ অনুযায়ী সাজিয়ে (Newest First) সেরা ৩টি নেওয়া হচ্ছে
    const top3 = [...dailyData]
        .sort((a, b) => new Date(b.date) - new Date(a.date)) 
        .slice(0, 3);

    if (top3.length === 0) {
        recentList.innerHTML = '<p style="text-align:center; font-size:0.8rem; color:#666; padding: 20px;">No recent transactions</p>';
    } else {
        top3.forEach(t => {
            recentList.innerHTML += `
                <div class="hisab-card row-between" style="padding: 12px 15px; margin-bottom:0; border-radius:15px; background: rgba(255,255,255,0.02); border-left: 3px solid ${t.type==='inc'?'#10B981':'#EF4444'}">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:38px; height:38px; border-radius:12px; background:rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center;">
                            <i class="fas ${t.type==='inc'?'fa-plus t-success':'fa-minus t-danger'}" style="font-size:0.8rem; color:${t.type==='inc'?'#10B981':'#EF4444'};"></i>
                        </div>
                        <div>
                            <b style="font-size:0.85rem; color:#fff;">${t.cat}</b><br>
                            <small style="color:#666; font-size:0.7rem;">${t.date}</small>
                        </div>
                    </div>
                    <b style="color:${t.type==='inc'?'#10B981':'#EF4444'}; font-size:0.9rem;">
                        ${t.type==='inc'?'+':'-'} ৳${parseFloat(t.amount).toLocaleString()}
                    </b>
                </div>`;
        });
    }

// --- FEATURE 5: TOP GOAL PREVIEW LOGIC ---
if(goalData.length > 0) {
    document.getElementById('top-goal-preview').style.display = 'block';
    const topGoal = goalData[0]; // প্রথম গোলটি দেখাচ্ছে
    const remaining = topGoal.target - topGoal.balance;
    const percent = Math.min((topGoal.balance / topGoal.target) * 100, 100).toFixed(0);
    
    document.getElementById('top-goal-name').innerText = topGoal.name;
    document.getElementById('top-goal-remaining').innerText = `Remaining: ৳ ${remaining.toLocaleString()}`;
    document.getElementById('top-goal-percent').innerText = percent + '%';
    document.getElementById('top-goal-bar').style.width = percent + '%';
} else {
    document.getElementById('top-goal-preview').style.display = 'none';
}
    // লিস্টগুলো রেন্ডার করা
    renderHisabDaily(); renderHisabBank(); renderHisabGoal(); renderHisabDPS();
}
        window.renderHisabDaily = function() {
    const list = document.getElementById('daily-list');
    list.innerHTML = '';
    
    // ডাটাগুলোকে সময়ের ক্রমানুসারে সাজানো (নতুনটি সবার উপরে)
    const sortedDaily = [...dailyData].sort((a, b) => b.createdAt - a.createdAt);

    sortedDaily.forEach(t => {
        list.innerHTML += `
            <div class="hisab-card row-between" style="border-left:5px solid ${t.type==='inc'?'#10B981':'#EF4444'}">
                <div>
                    <b style="font-size:1.1rem;">${t.cat}</b>
                    ${t.note ? `<br><small style="color:#ccc; font-size:0.75rem;">${t.note}</small>` : ''}
                    <br>
                    <small style="color:#aaa">
                        <i class="far fa-calendar-alt"></i> ${t.date} 
                        <i class="far fa-clock" style="margin-left:8px;"></i> ${t.time || ''}
                    </small>
                </div>
                <div style="display:flex;align-items:center; gap:10px;">
                    <b style="color:${t.type==='inc'?'#10B981':'#EF4444'}; font-size:1.2rem;">
                        ${t.type==='inc'?'+':'-'} ${t.amount}
                    </b>
                    <button class="list-delete-btn" onclick="deleteHisabItem('daily_transactions', '${t.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
    });
}
       function renderHisabBank() {
    const list = document.getElementById('bank-list');
    list.innerHTML = '';
    bankData.forEach(b => list.innerHTML += `
        <div class="hisab-card bank row-between">
            <div>
                <h3 style="color:var(--primary);">${b.name}</h3>
                <h2 style="margin:5px 0;">৳ ${b.balance}</h2>
                <p style="font-size:0.8rem;color:gray">Ac: ${b.num || 'N/A'}</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px; align-items: flex-end;">
                <!-- এখানে ${b.id} যোগ করা হয়েছে যাতে ক্লিক করলে ওই ব্যাংকই সিলেক্ট হয় -->
                <button class="pay-btn" onclick="openHisabModal('bank_tran', '${b.id}')" style="background:var(--bank-color); color:white; padding: 8px 15px;">Transact</button>
                <button class="pay-btn" onclick="viewBankHistory('${b.id}', '${b.name}')" style="background:var(--secondary); color:white; padding: 6px 12px; width:85px;">History</button>
                <button class="list-delete-btn" onclick="deleteHisabItem('bank_accounts', '${b.id}')" style="background:rgba(230, 57, 70, 0.1); padding:8px;"><i class="fas fa-trash"></i></button>
            </div>
        </div>`);
}
        function renderHisabGoal() {
    const list = document.getElementById('daily-list'); // আপনার ফাইলে আইডিটি daily-list ই আছে হয়তো, খেয়াল করবেন
    const goalList = document.getElementById('goal-list');
    const targetList = goalList || list;
    targetList.innerHTML = '';
    
    goalData.forEach(g => {
        const target = parseFloat(g.target) || 1;
        let percent = Math.min((parseFloat(g.balance) / target) * 100, 100).toFixed(0);
        
        targetList.innerHTML += `
            <div class="hisab-card goal">
                <div class="row-between">
                    <div>
                        <b style="font-size:1.1rem; color:var(--text-light);">${g.name}</b>
                        <h2 style="margin:2px 0; color:var(--goal-color);">৳ ${g.balance}</h2>
                        <small style="color:gray;">Target: ৳ ${g.target}</small>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                        <button class="pay-btn" onclick="openHisabModal('goal_tran', '${g.id}')" style="background:var(--goal-color); color:white; padding: 6px 12px; width:85px;">Add Save</button>
                        <!-- Goal History বাটন -->
                        <button class="pay-btn" onclick="viewGoalHistory('${g.id}', '${g.name}')" style="background:var(--secondary); color:white; padding: 6px 12px; width:85px;">History</button>
                        <button class="list-delete-btn" onclick="deleteHisabItem('savings_goals', '${g.id}')" style="background:rgba(230, 57, 70, 0.1); padding:6px;"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="goal-progress-wrapper">
                    <span class="percent-text">${percent}% Completed</span>
                    <div class="progress-bg">
                        <div class="progress-fill" style="width: ${percent}%;"></div>
                    </div>
                </div>
            </div>`;
    });
}
     // DPS লিস্ট দেখানোর আপডেট ফাংশন (Monthly Amount Included)
function renderHisabDPS() {
    const list = document.getElementById('dps-list');
    list.innerHTML = '';
    
    const today = new Date();
    // চলতি মাসের নাম
    const currentMonthStr = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    const startOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);

    dpsData.forEach(d => {
        const target = parseFloat(d.target) || 1;
        let percent = Math.min((parseFloat(d.paid) / target) * 100, 100).toFixed(0);

        // --- ১. নোটিশ লজিক (Missed Check) ---
        let warningBadge = '';
        const nextDateObj = new Date(d.nextDate);
        const nextMonthStart = new Date(nextDateObj.getFullYear(), nextDateObj.getMonth(), 1);

        if (nextMonthStart < startOfCurrentMonth) {
            warningBadge = `
            <div style="background: rgba(239, 68, 68, 0.15); color: #EF4444; font-size: 0.75rem; font-weight: bold; padding: 4px 8px; border-radius: 6px; display: inline-block; margin-bottom: 6px; border: 1px solid rgba(239, 68, 68, 0.4); animation: pulse 2s infinite;">
                <i class="fas fa-exclamation-triangle"></i> Missed / Due Found!
            </div><br>`;
        }

        // --- ২. বাটন লজিক (Running Month) ---
        let actionButtonHtml = '';
        const isRunningPaid = d.lastPaidMonth === currentMonthStr;

        if (isRunningPaid) {
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            const diffTime = Math.abs(nextMonth - today);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            actionButtonHtml = `
                <button class="pay-btn" style="background:#334155; color:#94a3b8; cursor: default; width:auto; padding: 6px 10px; border:1px solid #475569;">
                    <i class="fas fa-check"></i> Paid (Wait ${diffDays}d)
                </button>`;
        } else {
            actionButtonHtml = `
                <button class="pay-btn" onclick="payHisabDPS('${d.id}', 'running')" style="background:var(--primary); color:#000; padding: 6px 12px; font-weight:bold; width:85px;">
                    Pay Now
                </button>`;
        }

        // --- ৩. কার্ড রেন্ডারিং ---
        list.innerHTML += `
            <div class="hisab-card dps row-between" style="border-left: 4px solid var(--dps-color);">
                <div style="flex: 1;">
                    <b style="font-size:1.1rem; color:#fff; display:block; margin-bottom:4px;">${d.bank}</b>
                    ${warningBadge}
                    
                    <!-- NEW: মাসিক কিস্তির পরিমাণ এখানে দেখানো হচ্ছে -->
                    <div style="font-size: 0.9rem; color: #e2e8f0; margin-bottom: 5px;">
                        Monthly: <span style="color: #fff; font-weight: bold;">৳ ${d.monthly}</span>
                    </div>

                    <p style="font-size: 0.85rem; color: #aaa;">
                        Saved: <span style="color:var(--success); font-weight:bold;">৳ ${d.paid}</span> 
                        / ৳ ${d.target}
                    </p>
                    <small style="color:gray; display:block; margin-top:3px;">Next Cycle: ${d.nextDate}</small>
                    
                    <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 10px; overflow: hidden;">
                        <div style="width: ${percent}%; height: 100%; background: var(--dps-color); transition: width 0.5s;"></div>
                    </div>
                    <small style="color:var(--dps-color); font-size: 0.7rem; font-weight: bold;">${percent}% Completed</small>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end; margin-left: 10px;">
                    ${actionButtonHtml}
                    <button class="pay-btn" onclick="viewDpsHistory('${d.id}', '${d.bank}')" style="background:var(--secondary); color:white; padding: 6px 12px; width:85px;">History</button>
                    <button class="list-delete-btn" onclick="deleteHisabItem('dps_schemes', '${d.id}')" style="background:rgba(230, 57, 70, 0.1); padding:6px; color:var(--danger);">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
    });
}
        window.openHisabModal = function(context, selectedId = null) { document.getElementById('hisab-modal').style.display = 'flex'; document.getElementById('hisab-modal-context').value = context; const div = document.getElementById('hisab-modal-inputs'); div.innerHTML = ''; const di = `<input type="date" id="hinp-date" value="${new Date().toISOString().split('T')[0]}">`, ai = `<input type="number" id="hinp-amt" placeholder="Amount (Tk)">`; if(context === 'daily_entry') div.innerHTML = `<select id="hinp-type"><option value="inc">Income</option><option value="exp">Expense</option></select><input type="text" id="hinp-cat" placeholder="Category"> <input type="text" id="hinp-note" placeholder="Short Note/Details (Optional)"> ${ai} ${di}`; else if(context === 'new_bank') div.innerHTML = `<input type="text" id="hinp-name" placeholder="Bank Name"><input type="text" id="hinp-desc" placeholder="Acc Number"> ${ai}`; else if(context === 'bank_tran') div.innerHTML = `<select id="hinp-idx">${bankData.map(b=>`<option value="${b.id}" ${b.id === selectedId ? 'selected' : ''}>${b.name}</option>`).join('')}</select><select id="hinp-action"><option value="dep">Deposit</option><option value="with">Withdraw</option></select> ${ai} ${di}`; else if(context === 'new_goal') div.innerHTML = `<input type="text" id="hinp-name" placeholder="Goal Name"> ${ai}`; // এটি খুঁজে বের করুন এবং নিচের কোড দিয়ে পরিবর্তন করুন
else if(context === 'goal_tran') {
    div.innerHTML = `
        <select id="hinp-idx">
            ${goalData.map(g => `<option value="${g.id}" ${g.id === selectedId ? 'selected' : ''}>${g.name}</option>`).join('')}
        </select>
        <select id="hinp-action">
            <option value="add">Add (+)</option>
            <option value="remove">Remove (-)</option>
        </select> 
        ${ai}`;
}
 else if(context === 'new_dps') div.innerHTML = `<input type="text" id="hinp-name" placeholder="Bank Name"><input type="number" id="hinp-amt" placeholder="Monthly Installment"><input type="number" id="hinp-desc" placeholder="Total Target"> ${di}`; }
        window.submitHisabData = async function() {
    const user = auth.currentUser;
    const ctx = document.getElementById('hisab-modal-context').value;
    
    // সব ইনপুট থেকে ডাটা নেওয়া
    const amtInput = document.getElementById('hinp-amt');
    const amtValue = amtInput ? amtInput.value.trim() : "";
    const amt = parseFloat(amtValue);

    const nameInput = document.getElementById('hinp-name');
    const name = nameInput ? nameInput.value.trim() : "";

    const descInput = document.getElementById('hinp-desc'); // এটা দিয়ে ব্যাংক একাউন্ট বা টার্গেট ধরা হয়
    const desc = descInput ? descInput.value.trim() : "";

    try {
        // --- ১. Daily Entry (আপনার দেওয়া সময়সহ লজিক) ---
        if (ctx === 'daily_entry') {
            const cat = document.getElementById('hinp-cat').value.trim();
            if (!amtValue || isNaN(amt) || amt <= 0 || !cat) {
                alert("Incorrect: Enter the category and the correct amount! ❌");
                return;
            }
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('daily_transactions').add({ 
                type: document.getElementById('hinp-type').value, 
                amount: amt, 
                cat: cat,
                note: document.getElementById('hinp-note').value || '',
                date: document.getElementById('hinp-date').value,
                time: timeString, 
                createdAt: Date.now() 
            });
        }
        
        // --- ২. New Bank Account Validation ---
        else if(ctx === 'new_bank') {
            if(!name) { alert("Wrong: Enter the name of the bank! ❌"); return; }
            if(!desc) { alert("Error: Enter account number! ❌"); return; }
            if(!amtValue || isNaN(amt) || amt < 0) { alert("Error: Enter initial balance (can be 0)! ❌"); return; }
            
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bank_accounts').add({ 
                name: name, num: desc, balance: amt 
            });
        }

        // --- ৩. Bank Transaction (Deposit/Withdraw) ---
else if(ctx === 'bank_tran') {
    if(!amtValue || isNaN(amt) || amt <= 0) { alert("Incorrect: Enter the correct amount! ❌"); return; }
    const id = document.getElementById('hinp-idx').value;
    const act = document.getElementById('hinp-action').value;
    const dateVal = document.getElementById('hinp-date').value;
    const b = bankData.find(x => x.id === id);
    
    const now = new Date();
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    // ব্যালেন্স আপডেট
    await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bank_accounts').doc(id).update({ 
        balance: act === 'dep' ? parseFloat(b.balance || 0) + amt : parseFloat(b.balance || 0) - amt 
    });

    // লেনদেনের ইতিহাস সেভ করা (নতুন অংশ)
    await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bank_transactions').add({
        bankId: id,
        type: act, // 'dep' or 'with'
        amount: amt,
        date: dateVal,
        time: timeString,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
}

        // --- ৪. New Savings Goal Validation ---
        else if(ctx === 'new_goal') {
            if(!name) { alert("Wrong: Name the goal (eg: Buy Phone)! ❌"); return; }
            if(!amtValue || isNaN(amt) || amt <= 0) { alert("Wrong: Enter the target amount! ❌"); return; }
            
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('savings_goals').add({ 
                name: name, target: amt, balance: 0 
            });
        }

        // --- ৫. Goal Transaction (Add Save / Remove) ---
        else if(ctx === 'goal_tran') {
            if(!amtValue || isNaN(amt) || amt <= 0) { alert("Incorrect: Enter the correct amount! ❌"); return; }
            const id = document.getElementById('hinp-idx').value;
            const act = document.getElementById('hinp-action').value;
            const g = goalData.find(x => x.id === id);
            if(!g) return;
            
            const currentGoalBal = parseFloat(g.balance || 0);
            
            // ব্যালেন্স আপডেট
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('savings_goals').doc(id).update({ 
                balance: act === 'add' ? currentGoalBal + amt : currentGoalBal - amt 
            });

            // গোল লেনদেনের ইতিহাস সেভ করা
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('goal_transactions').add({
                goalId: id,
                type: act, // 'add' or 'remove'
                amount: amt,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

       // --- ৬. New DPS Validation (সংশোধিত) ---
else if(ctx === 'new_dps') {
    const targetAmt = parseFloat(desc);
    if(!name) { alert("Wrong: Enter the name of the bank! ❌"); return; }
    if(!amtValue || isNaN(amt) || amt <= 0) { alert("Wrong: Enter the monthly installment amount! ❌"); return; }
    if(isNaN(targetAmt) || targetAmt <= 0) { alert("Incorrect: Enter the total target amount! ❌"); return; }
    
    const start = document.getElementById('hinp-date').value;
    
    // ফিক্স: শুরুর তারিখেই প্রথম কিস্তি বাকি থাকে, তাই ১ মাস যোগ করা যাবে না
    let nextDateObj = new Date(start); 
    
    // টাইমজোন ইস্যু এড়ানোর জন্য তারিখ স্ট্রিং সরাসরি সেভ করাই ভালো
    let nextDateString = start; 

    await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('dps_schemes').add({ 
        bank: name, 
        monthly: amt, 
        target: targetAmt, 
        paid: 0, 
        // nextDate হবে শুরুর তারিখটিই (Start Date)
        nextDate: nextDateString 
    });
}

        // সবশেষে মোডাল বন্ধ এবং ডাটা রিফ্রেশ
        document.getElementById('hisab-modal').style.display = 'none'; 
        // ডাটা রিফ্রেশ হওয়া পর্যন্ত অপেক্ষা করা (Await)
        await fetchDataFromFirestore(); 
        alert("Saved successfully! ✅"); 

    } catch(e) { 
        console.error(e); 
        alert("There was a problem saving! ❌"); 
    }
}
// DPS পেমেন্ট ফাংশন (Backlog Priority Logic)
window.payHisabDPS = async function(id, type) {
    const d = dpsData.find(x => x.id === id);
    if(!d) return;

    const today = new Date();
    // চলতি মাসের নাম (যেমন: January 2026)
    const currentMonthStr = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    // কনফার্মেশন
    window.confirmDelete(`Pay RUNNING month (${currentMonthStr})?\nAmount: ৳${d.monthly}`, async function() {
        try {
            // আপডেট করার ডাটা
            let updateData = {
                paid: parseFloat(d.paid || 0) + parseFloat(d.monthly || 0),
                lastPaidMonth: currentMonthStr // এই মাসের নাম সেভ হচ্ছে, যাতে বাটন টাইমার হয়ে যায়
            };

            // যদি nextDate এবং চলতি মাস একই হয়, তবেই nextDate আপডেট হবে।
            // যদি nextDate অতীতে (বকেয়া) থাকে, তবে সেটা চেঞ্জ হবে না (হিস্ট্রিতে থাকবে)।
            const nextDateObj = new Date(d.nextDate);
            const startOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // nextDate এর মাস এবং চলতি মাস যদি সমান হয়
            if (nextDateObj.getMonth() === today.getMonth() && nextDateObj.getFullYear() === today.getFullYear()) {
                let newNext = new Date(d.nextDate);
                newNext.setMonth(newNext.getMonth() + 1);
                updateData.nextDate = newNext.toISOString().split('T')[0];
            }

            // ডাটাবেস আপডেট
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('dps_schemes').doc(id).update(updateData);

            // ট্রানজেকশন সেভ
            await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('dps_transactions').add({
                dpsId: id,
                bankName: d.bank,
                amount: parseFloat(d.monthly),
                date: today.toISOString().split('T')[0],
                time: today.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                note: `Regular: ${currentMonthStr}`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await fetchDataFromFirestore();
            alert(`Payment for ${currentMonthStr} Successful! ✅`);

        } catch(e) {
            alert("Error: " + e.message);
        }
    });
};
        // --- BOT LOGIC (ULTIMATE FIX) ---
        const chatbotTrigger = document.getElementById('chatbot-trigger'); const chatbotContainer = document.getElementById('chatbot-container'); const closeChatBtn = document.getElementById('close-chat'); const chatInput = document.getElementById('chat-input'); const chatSendBtn = document.getElementById('chat-send-btn'); const chatMessages = document.getElementById('chat-messages'); const chatImgBtn = document.getElementById('chat-img-btn'); const chatFileInput = document.getElementById('chat-file-input');
        chatbotTrigger.addEventListener('click', () => chatbotContainer.style.display = 'flex'); closeChatBtn.addEventListener('click', () => chatbotContainer.style.display = 'none');
        function addMessage(sender, text) {
    const div = document.createElement('div');
    div.className = `message ${sender}`;
    div.innerHTML = text.replace(/\n/g, '<br>');
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // --- সোয়াইপ লজিক (ইউজার বামে, বট ডানে) ---
    let touchStartX = 0;
    let touchEndX = 0;

    div.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    div.addEventListener('touchmove', (e) => {
        let currentX = e.changedTouches[0].screenX;
        let diff = currentX - touchStartX;

        // ইউজার মেসেজ হলে শুধু বাম দিকে (Negative diff) সরবে
        if (sender === 'user' && diff < 0) {
            div.style.transform = `translateX(${diff}px)`;
        }
        // বটের মেসেজ হলে শুধু ডান দিকে (Positive diff) সরবে
        if (sender === 'bot' && diff > 0) {
            div.style.transform = `translateX(${diff}px)`;
        }
    }, { passive: true });

    div.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        const swipeDistance = touchEndX - touchStartX;
        const threshold = 100; // ১০০ পিক্সেল টানলে ডিলিট হবে

        // শর্ত ১: ইউজার মেসেজ এবং বাম দিকে সোয়াইপ
        if (sender === 'user' && swipeDistance < -threshold) {
            deleteWithEffect(div);
        } 
        // শর্ত ২: বট মেসেজ এবং ডান দিকে সোয়াইপ
        else if (sender === 'bot' && swipeDistance > threshold) {
            deleteWithEffect(div);
        } 
        else {
            // ভুল করে অল্প টানলে আবার আগের জায়গায় ফিরে আসবে
            div.style.transform = 'translateX(0)';
        }
    }, { passive: true });

    // ডিলিট করার ফাংশন (ভাইব্রেশন সহ)
    function deleteWithEffect(element) {
        if (window.AppInventor) {
            window.AppInventor.setWebViewString("VIBRATE"); 
        }
        element.classList.add('deleting');
        setTimeout(() => {
            element.remove();
        }, 300);
    }

    return div;
}
        chatSendBtn.addEventListener('click', () => processUserMessage()); chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') processUserMessage(); }); 
        
async function processUserMessage() { 
            const text = chatInput.value.trim(); if(!text) return; 
            const lowerText = text.toLowerCase(); chatInput.value = '';
            
           // এই ব্লকের ভেতর যে কমান্ডগুলো থাকবে, সেগুলো চ্যাট বাবল হিসেবে দেখা যাবে না
if(lowerText === 'tools') {
    document.getElementById('moana-tools-modal').style.display = 'flex';
    return; // এখানেই শেষ, চ্যাটে মেসেজ দেখাবে না
}

if(lowerText === 'api setting') {
    document.getElementById('api-settings-modal').style.display = 'flex';
    document.getElementById('api-view-mode').style.display = 'block';
    document.getElementById('api-edit-mode').style.display = 'none';
    fetchApiSettings(); 
    return; // মেসেজ হাইড হয়ে যাবে
}

if(lowerText === 'train on') { 
    document.getElementById('training-modal').style.display = 'flex'; 
    switchTrainView('form'); 
    return; 
}

if(lowerText === 'setting') { 
    // সেটিংস ওপেন হওয়ার সময় সিকিউরিটি প্যানেল লক অবস্থায় থাকবে
    document.getElementById('protected-security-panel').style.display = 'none';
    document.getElementById('security-unlock-section').style.display = 'block';
    
    document.getElementById('settings-modal').style.display = 'flex'; 
    return; 
}

// উপরের কোনো কমান্ডের সাথে না মিললে তবেই লেখাটি চ্যাটে দেখাবে
addMessage('user', text);
            const command = identifyCommand(text); 
            if (!command) { handleGeneralQuery(text); return; }
            try { 
                const args = command.args; 
                switch(command.logicId) {
                    // FINANCE
                    case 'ADD_INCOME': await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('daily_transactions').add({ type: 'inc', amount: parseFloat(args[0]), cat: args.slice(1).join(' ') || 'Chat Added', date: new Date().toISOString().split('T')[0] }); addMessage('bot', `Income Added: ${args[0]}`); refreshHisabAll(); break;
                    case 'ADD_EXPENSE': await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('daily_transactions').add({ type: 'exp', amount: parseFloat(args[0]), cat: args.slice(1).join(' ') || 'Chat Added', date: new Date().toISOString().split('T')[0] }); addMessage('bot', `Expense Added: ${args[0]}`); refreshHisabAll(); break;
                    case 'VIEW_BALANCE': let t = dailyData.reduce((a,x)=>x.type==='inc'?a+x.amount:a-x.amount,0) + bankData.reduce((a,x)=>a+x.balance,0); addMessage('bot', `Net Worth: ৳ ${t}`); break;
                    case 'VIEW_HISTORY': let h = dailyData.slice(-5).reverse().map(t => `${t.date}: ${t.cat} (${t.type==='inc'?'+':'-'}${t.amount})`).join('<br>'); addMessage('bot', `Last 5:<br>${h}`); break;
                    
                    // BANK
                    case 'NEW_BANK': await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bank_accounts').add({ name: args[0], num: args[1]||'', balance: parseFloat(args[2]||0), history: [] }); addMessage('bot', `Bank Added: ${args[0]}`); refreshHisabAll(); break;
                    case 'BANK_LIST': addMessage('bot', bankData.map(b => `${b.name}: ৳ ${b.balance}`).join('<br>')); break;
                    
                    // GOAL & DPS
                    case 'NEW_GOAL': await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('savings_goals').add({ name: args[0], target: parseFloat(args[1]||0), balance: 0 }); addMessage('bot', `Goal Set: ${args[0]}`); refreshHisabAll(); break;
                    case 'GOAL_LIST': addMessage('bot', goalData.map(g => `${g.name}: ৳ ${g.balance} / ${g.target}`).join('<br>')); break;
                    case 'DPS_LIST': addMessage('bot', dpsData.map(d => `${d.bank}: Paid ৳ ${d.paid}`).join('<br>')); break;
                    
                    // CONTACTS
                    case 'ADD_CONTACT': const newId = await getNextId('contactCounter'); await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('contacts').doc(String(newId)).set({ name: args[0], phone: [args[1] || ''], email: "", address: "Chat", socialLinks: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() }); addMessage('bot', `Contact Saved: ${args[0]}`); break;
                    case 'SEARCH_CONTACT': const fc = allContacts.filter(c => c.name.toLowerCase().includes(args.join(' ').toLowerCase())); addMessage('bot', fc.length ? fc.map(c => `${c.name}: ${c.phone}`).join('<br>') : 'Not found'); break;
                    case 'SEARCH_ALL': handleGeneralQuery(args.join(' ')); break;
                    
                    // MEDIA UPLOAD
                    case 'ADD_PHOTO': window.switchPage('add-info'); document.getElementById('info-category').value='photo'; document.getElementById('info-category').dispatchEvent(new Event('change')); chatbotContainer.style.display='none'; break;
                    case 'ADD_VIDEO': window.switchPage('add-info'); document.getElementById('info-category').value='video'; document.getElementById('info-category').dispatchEvent(new Event('change')); chatbotContainer.style.display='none'; break;
                    case 'ADD_AUDIO': window.switchPage('add-info'); document.getElementById('info-category').value='audio'; document.getElementById('info-category').dispatchEvent(new Event('change')); chatbotContainer.style.display='none'; break;
                    case 'ADD_FILE': window.switchPage('add-info'); document.getElementById('info-category').value='file'; document.getElementById('info-category').dispatchEvent(new Event('change')); chatbotContainer.style.display='none'; break;
                    case 'ADD_LINK': window.switchPage('add-info'); document.getElementById('info-category').value='link'; document.getElementById('info-category').dispatchEvent(new Event('change')); chatbotContainer.style.display='none'; break;
                    case 'ADD_INFO': window.switchPage('add-info'); document.getElementById('info-category').value='text'; document.getElementById('info-category').dispatchEvent(new Event('change')); chatbotContainer.style.display='none'; break;

                    // TOOLS
                    case 'GEN_IMAGE': const loadImgMsg = addMessage('bot', 'Painting...'); const seed = Math.floor(Math.random()*10000); const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(args[0])}?seed=${seed}&width=512&height=512&nologo=true`; const imgObj = new Image(); imgObj.src = imgUrl; imgObj.onload = () => { loadImgMsg.remove(); addMessage('bot', `<img src="${imgUrl}" style="width:200px; border-radius:10px;"><br><a href="${imgUrl}" download class="btn" style="display:inline-block; margin-top:5px; padding:5px 10px; font-size:0.8rem;">Download HD</a>`); }; break;
                    case 'QR_OPTIONS': addMessage('bot', `Select option:<br><button class="chat-opt-btn" onclick="window.triggerQrFile()">Upload QR</button>`); break;
                    case 'GEN_QR': const qrText = args.join(' '); if(!qrText) { addMessage('bot', "Please provide text."); break; } const loadingMsg = addMessage('bot', "Generating..."); setTimeout(() => { loadingMsg.remove(); const qrId = "qr-" + Date.now(); const div = document.createElement('div'); div.className = 'message bot'; div.innerHTML = ` <div style="background:white; padding:10px; margin-top:5px; border-radius:8px; display:inline-block;"> <div id="${qrId}"></div> </div> <div style="font-size:0.7rem; color:#ccc; margin-top:5px; word-break:break-all;">${qrText}</div> <button class="chat-opt-btn" onclick="window.downloadQRCode('${qrId}')" style="margin-top:10px; width:100%; background:var(--success); color:black; font-weight:bold;"> <i class="fas fa-download"></i> Download QR </button> `; chatMessages.appendChild(div); new QRCode(document.getElementById(qrId), { text: qrText, width: 150, height: 150 }); chatMessages.scrollTop = chatMessages.scrollHeight; }, 300); break;
                    case 'DROPBOX_CONVERT': let link = args[0].replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('dropbox.com', 'dl.dropboxusercontent.com'); addMessage('bot', `🚀 <b>Direct Link:</b><br><a href="${link}" target="_blank" style="color:#00ff88; word-break:break-all;">${link}</a><br><button onclick="navigator.clipboard.writeText('${link}');alert('Copied!')" class="chat-opt-btn" style="margin-top:5px;">Copy</button>`); break;
                    
                    case 'TRAIN_ON': document.getElementById('training-modal').style.display = 'flex'; switchTrainView('form'); break;
                    case 'OPEN_SETTINGS': document.getElementById('settings-modal').style.display = 'flex'; break;
                    
                    default: addMessage('bot', `Processing ${command.logicId}...`);
            } } catch(e) { addMessage('bot', "Error executing command."); console.log(e); }
        }
        
        function identifyCommand(text) { 
            const lower = text.toLowerCase(); 
            const customMatch = customSettings.find(s => lower.startsWith(s.command.toLowerCase())); 
            if(customMatch) {
                // Fix for arg splitting based on custom command length
                const cmdParts = customMatch.command.split(' ').length;
                return { logicId: customMatch.logicId, args: text.split(' ').slice(cmdParts) };
            }
            if (lower.startsWith('draw ') || lower.startsWith('imagine ') || lower.startsWith('chobi ')) return { logicId: 'GEN_IMAGE', args: [text.replace(/^(draw|imagine|chobi)\s+/i, '').trim()] };
            if(lower.startsWith('add income')) return { logicId: 'ADD_INCOME', args: text.split(' ').slice(2) };
            if(lower.startsWith('add expense')) return { logicId: 'ADD_EXPENSE', args: text.split(' ').slice(2) };
            if(lower.includes('balance')) return { logicId: 'VIEW_BALANCE', args: [] };
            if(lower.includes('history')) return { logicId: 'VIEW_HISTORY', args: [] };
            if(lower.startsWith('add contact')) return { logicId: 'ADD_CONTACT', args: text.split(' ').slice(2) };
            if(lower.includes('upload photo') || lower.includes('add photo')) return { logicId: 'ADD_PHOTO', args: [] };
            if(lower.includes('upload video') || lower.includes('add video')) return { logicId: 'ADD_VIDEO', args: [] };
            if(lower.includes('upload audio') || lower.includes('add music')) return { logicId: 'ADD_AUDIO', args: [] };
            if(lower.includes('upload file') || lower.includes('add file')) return { logicId: 'ADD_FILE', args: [] };
            if (lower.includes('qr scan') || lower.includes('scan qr')) return { logicId: 'QR_OPTIONS', args: [] };
            if (lower.startsWith('make qr ') || lower.startsWith('gen qr ')) return { logicId: 'GEN_QR', args: [text.replace(/^(make|gen)\s+qr\s+/i, '').trim()] };
            if (lower.includes('dropbox.com')) return { logicId: 'DROPBOX_CONVERT', args: [text.replace(/^dropbox\s+/i, '').trim()] };
            return null;
        }
        
        function handleGeneralQuery(text) { const typingDiv = document.createElement('div'); typingDiv.className = 'message bot'; typingDiv.innerHTML = '...'; chatMessages.appendChild(typingDiv); setTimeout(() => { chatMessages.removeChild(typingDiv); const customMatch = customBotData.find(data => text.toLowerCase().includes(data.keyword)); if(customMatch) addMessage('bot', customMatch.reply); else { const m = allInformation.filter(i => i.title.toLowerCase().includes(text.toLowerCase())); if(m.length) addMessage('bot', m.map(i=>i.title).join('<br>')); else addMessage('bot', "No info found."); } }, 500); }
        window.saveCommandSetting = async function() { const logic = document.getElementById('setting-logic-select').value; const cmd = document.getElementById('setting-custom-cmd').value.trim(); if(!logic || !cmd) return alert("Select logic and type command."); const existing = customSettings.find(s => s.logicId === logic); if(existing) { await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bot_settings').doc(existing.id).update({ command: cmd }); } else { await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bot_settings').add({ logicId: logic, command: cmd }); } alert("Command Set!"); document.getElementById('setting-custom-cmd').value = ''; }
        // Line 766 এর আশেপাশে খুঁজুন
window.deleteCommandSetting = async function(id) {
    window.confirmDelete("Remove this command?", function() {
        db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('bot_settings').doc(id).delete();
    });
}
        window.editCommandSetting = function(id) { const s = customSettings.find(x => x.id === id); if(!s) return; document.getElementById('setting-logic-select').value = s.logicId; document.getElementById('setting-custom-cmd').value = s.command; document.getElementById('setting-custom-cmd').focus(); }
        // --- সেটিংসের আইকন আপডেট করার জন্য ফ্রেশ কোড ---
function renderSettingsList() { 
    const container = document.getElementById('settings-list-container'); 
    if(!container) return;
    container.innerHTML = ''; 
    
    customSettings.forEach(s => { 
        container.innerHTML += `
            <div class="setting-row" style="display:flex; justify-content:space-between; align-items:center; padding:15px; background: rgba(255,255,255,0.04); border-radius:18px; margin-bottom:12px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <div style="flex:1;">
                    <span style="font-size:0.65rem; color:var(--primary); font-weight:800; text-transform:uppercase; letter-spacing:1.5px; opacity:0.8;">${s.logicId}</span><br>
                    <b style="font-size:1.05rem; color:white; display:block; margin-top:3px;">"${s.command}"</b>
                </div>
                
                <!-- প্রিমিয়াম অ্যাকশন বাটন গ্রুপ -->
                <div style="display: flex; gap: 12px;">
                    <div class="icon-btn-premium" style="width:38px; height:38px; background:rgba(33, 212, 253, 0.1); border:1px solid rgba(33, 212, 253, 0.3); color:#21D4FD; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.3s;" onclick="editCommandSetting('${s.id}')" title="Edit">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </div>
                    <div class="icon-btn-premium" style="width:38px; height:38px; background:rgba(239, 68, 68, 0.1); border:1px solid rgba(239, 68, 68, 0.3); color:#EF4444; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.3s;" onclick="deleteCommandSetting('${s.id}')" title="Delete">
                        <i class="fa-solid fa-trash-can"></i>
                    </div>
                </div>
            </div>`; 
    }); 
}

        // --- IMAGE HANDLER ---
        let pendingImage = null; chatImgBtn.addEventListener('click', () => chatFileInput.click()); chatFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; pendingImage = file; const url = URL.createObjectURL(file); const tempImg = new Image();
            tempImg.src = url;
            tempImg.onload = () => URL.revokeObjectURL(url); addMessage('user', `<img src="${url}" style="width:100px;border-radius:5px;">`); addMessage('bot', `<div style="display:flex;gap:5px;"><button class="chat-opt-btn" onclick="window.processScanText()">Scan Text</button><button class="chat-opt-btn" onclick="window.processGetLink()">Get Link</button></div>`); chatFileInput.value = ''; });
        window.processScanText = async function() { if (!pendingImage) return; const loadingMsg = addMessage('bot', 'Scanning...'); try { const processedImage = await preprocessImage(pendingImage); const { data: { text } } = await Tesseract.recognize(processedImage, 'eng'); loadingMsg.remove(); addMessage('bot', text ? `<div style="background:rgba(255,255,255,0.1);padding:5px;">${text}</div><button onclick="navigator.clipboard.writeText('${text.replace(/'/g, "\\'")}')" class="btn-mini">Copy</button>` : "No text."); } catch(e) { loadingMsg.remove(); addMessage('bot', "Scan Error"); } pendingImage = null; }
        window.processGetLink = async function() { if (!pendingImage) return; const loadingMsg = addMessage('bot', 'Uploading...'); const fd = new FormData(); fd.append("image", pendingImage); try { const res = await fetch(`https://api.imgbb.com/1/upload?key=d685822691566e39accb630d6ef7a6d9`, { method: "POST", body: fd }); const d = await res.json(); loadingMsg.remove(); if (d.success) addMessage('bot', `Link: ${d.data.url}<br><button onclick="navigator.clipboard.writeText('${d.data.url}')" class="btn-mini">Copy</button>`); else addMessage('bot', "Failed."); } catch(e) { loadingMsg.remove(); addMessage('bot', "Error."); } pendingImage = null; }
        function preprocessImage(file) { return new Promise((resolve) => { const img = new Image(); img.src = URL.createObjectURL(file); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); resolve(canvas.toDataURL()); }; }); }

        // --- THEME STORE (FIXED: HTML/Script Injection) ---
        window.addEventListener('load', () => { const activeThemeId = localStorage.getItem('activeThemeId'); if (activeThemeId) { applyThemeById(activeThemeId, false); } loadThemeStoreUI(); });
        document.getElementById('theme-upload-input').addEventListener('change', function(e) { const file = e.target.files[0]; if (!file) return; const name = prompt("Theme Name:", file.name.replace('.html','')); if(!name) return; const reader = new FileReader(); reader.onload = function(e) { saveNewTheme(name, e.target.result); }; reader.readAsText(file); e.target.value=''; });
        function saveNewTheme(name, content) { let store = JSON.parse(localStorage.getItem('myThemeStore') || '[]'); const newId = Date.now().toString(); store.push({ id: newId, name: name, content: content, date: new Date().toLocaleDateString() }); localStorage.setItem('myThemeStore', JSON.stringify(store)); loadThemeStoreUI(); applyThemeById(newId); }
        function loadThemeStoreUI() { const list = document.getElementById('theme-store-list'); const store = JSON.parse(localStorage.getItem('myThemeStore') || '[]'); const activeId = localStorage.getItem('activeThemeId'); list.innerHTML = ''; if (store.length === 0) { list.innerHTML = '<div style="text-align: center; color: #666; font-size: 0.8rem; padding: 10px;">No themes saved yet. Import one!</div>'; return; } store.forEach(t => { const isActive = t.id === activeId; let statusHtml = isActive ? `<div class="badge-active"><i class="fas fa-check-circle"></i> Active</div>` : `<button class="btn-mini btn-apply" onclick="applyThemeById('${t.id}')">Apply</button>`; list.innerHTML += `<div class="theme-item" style="${isActive ? 'border-color: var(--success); box-shadow: 0 0 10px rgba(16,185,129,0.1);' : ''}"><div class="theme-name">${t.name}</div><div class="theme-actions"><button class="btn-mini btn-download" onclick="downloadTheme('${t.id}')"><i class="fas fa-download"></i></button>${statusHtml}<button class="btn-mini btn-delete" onclick="deleteTheme('${t.id}')"><i class="fas fa-trash"></i></button></div></div>`; }); }
        window.downloadTheme = function(id) { const store = JSON.parse(localStorage.getItem('myThemeStore') || '[]'); const theme = store.find(t => t.id === id); if (!theme) return; const blob = new Blob([theme.content], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${theme.name}.html`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        
        // ** CRITICAL FIX: Proper Theme Injection **
        function injectThemeCSS(htmlContent) {
            const bgLayer = document.getElementById('theme-bg-layer'); const styleTag = document.getElementById('theme-custom-style');
            // CSS Injection
            const styleMatch = htmlContent.match(/<style[^>]*>([\s\S]*?)<\/style>/i);
            if (styleMatch && styleMatch[1]) { let css = styleMatch[1].replace(/body\s*{/g, '#theme-bg-layer {').replace(/html\s*{/g, ''); styleTag.innerHTML = css; }
            // Body Content Injection
            const bodyMatch = htmlContent.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
            if (bodyMatch && bodyMatch[1]) { let bodyHtml = bodyMatch[1].replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim, ""); bgLayer.innerHTML = bodyHtml; }
            // Script Injection
            const scriptMatch = htmlContent.matchAll(/<script\b[^>]*>([\s\S]*?)<\/script>/gim);
            for (const match of scriptMatch) { if (match[1]) { const newScript = document.createElement("script"); newScript.textContent = match[1]; document.body.appendChild(newScript); } }
        }

 // --- THEME FUNCTIONS (FIXED) ---
window.applyThemeById = function(id, alertUser=true) { 
    const store = JSON.parse(localStorage.getItem('myThemeStore') || '[]'); 
    const t = store.find(x => x.id === id); 
    if(t) { 
        injectThemeCSS(t.content); 
        localStorage.setItem('activeThemeId', id); 
        loadThemeStoreUI(); 
        if(alertUser) alert("Theme Applied! ✅"); 
    } 
}

window.deleteTheme = function(id) {
    window.confirmDelete('Do you want to delete this theme?', function() {
        let store = JSON.parse(localStorage.getItem('myThemeStore') || '[]'); 
        store = store.filter(t => t.id !== id); 
        localStorage.setItem('myThemeStore', JSON.stringify(store)); 
        if(localStorage.getItem('activeThemeId') === id) {
            resetToDefaultTheme(); 
        } else {
            loadThemeStoreUI();
        }
        alert("Theme Deleted!");
    });
}

window.resetToDefaultTheme = function() { 
    localStorage.removeItem('activeThemeId'); 
    document.getElementById('theme-custom-style').innerHTML = ''; 
    document.getElementById('theme-bg-layer').innerHTML = ''; 
    location.reload(); 
}

// ABOUT MODAL
const aboutBtn = document.getElementById('about-btn'); 
const aboutModal = document.getElementById('about-modal');
if(aboutBtn) { 
    aboutBtn.addEventListener('click', function() { 
        const user = auth.currentUser; 
   
        aboutModal.style.display = 'flex'; 
    }); 
}
window.addEventListener('click', function(e) { 
    if (e.target === aboutModal) { 
        aboutModal.style.display = 'none'; 
    } 
});

    // QR LOGIC (ONLY UPLOAD - NO CAMERA)
    window.triggerQrFile = function() {
        document.getElementById('qr-file-input').click();
    }

    const qrInput = document.getElementById('qr-file-input');
    if(qrInput) {
        qrInput.addEventListener('change', async e => {
            const file = e.target.files[0];
            if (!file) return;

            if(typeof addMessage === "function") addMessage('bot', 'Scanning image...');

            try {
                // স্ক্যানার ইনিশিয়ালাইজ (reader div লুকানো থাকবে)
                const fileScanner = new Html5Qrcode("reader");
                const decodedText = await fileScanner.scanFile(file, true);
                
                // ফলাফল দেখানো
                if(typeof addMessage === "function") {
                    addMessage('bot', `✅ <b>QR Found:</b><br><span style="color:#00ff88; word-break:break-all;">${decodedText}</span><br><button onclick="navigator.clipboard.writeText('${decodedText}');alert('Copied!')" class="btn-mini" style="margin-top:5px;">Copy</button> <a href="${decodedText}" target="_blank" class="btn-mini">Open</a>`);
                } else {
                    alert("QR Found: " + decodedText);
                }
                fileScanner.clear(); // মেমোরি ক্লিয়ার
            } catch (err) {
                console.log(err);
                if(typeof addMessage === "function") {
                    addMessage('bot', "❌ QR Code not found. Try a clear image.");
                } else {
                    alert("QR Code not found!");
                }
            }
            e.target.value = ''; // রিসেট
        });
    }

    // ৪. ফলাফল দেখানোর ফাংশন
    window.handleQrResult = function(text) {
        window.stopQrScanner();
        if(typeof addMessage === "function") {
            addMessage('bot', `✅ <b>QR Found:</b><br><span style="color:#00ff88; word-break:break-all;">${text}</span><br><button onclick="navigator.clipboard.writeText('${text}');alert('Copied!')" class="btn-mini" style="margin-top:5px;">Copy</button> <a href="${text}" target="_blank" class="btn-mini">Open</a>`);
        } else {
            alert("QR Found: " + text);
        }
    }

    // ৫. স্ক্যানার বন্ধ করা
    window.stopQrScanner = function() {
        document.getElementById('qr-modal').style.display = 'none';
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
            }).catch(err => console.log("Stop failed", err));
        }
    }
    });
// --- সব ফিঙ্গারপ্রিন্ট লজিক এখন একটি ফাংশনে (সংশোধিত) ---
function onFingerprintSuccess() {
    const lockScreen = document.getElementById('app-lock-screen');
    const apiModal = document.getElementById('api-settings-modal');
    
    // ১. লক স্ক্রিন সাথে সাথে বন্ধ করা
    if (lockScreen && lockScreen.style.display === 'flex') {
        lockScreen.style.display = 'none'; // ডিসপ্লে বন্ধ
        document.getElementById('app-pin-input').value = '';
        return;
    } 
    
    // ২. এপিআই সেটিংস লজিক
    if (apiModal && apiModal.style.display === 'flex') {
        openApiEdit(); 
        return; 
    }
    
    // ৩. লগইন পেজ লজিক
    const savedEmail = localStorage.getItem('savedEmail');
    const savedPass = localStorage.getItem('savedPass');
    if (savedEmail && savedPass) {
        document.getElementById('login-error').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
        auth.signInWithEmailAndPassword(savedEmail, savedPass).catch(() => {
            document.getElementById('login-error').textContent = 'Login Failed.';
        });
    }

}
function onFingerprintError(errorMessage) {
    // ফিঙ্গারপ্রিন্ট না মিললে বা ইউজার ক্যানসেল করলে এটি কাজ করবে
    console.log("Biometric Failed: " + errorMessage);
    document.getElementById('login-error').textContent = 'Fingerprint mismatch.';
}
// --- GLOBAL KEYBOARD & INPUT FOCUS FIX ---
document.querySelectorAll('input, textarea').forEach(element => {
    element.addEventListener('focus', function() {
        // ১. যে কোনো বক্সে ক্লিক করলে সেটি স্ক্রিনের মাঝখানে চলে আসবে (কিবোর্ড ঢাকা দেবে না)
        setTimeout(() => {
            this.scrollIntoView({ behavior: "smooth", block: "center" });
        }, 300);

        // ২. যদি এটি চ্যাটবক্সের ইনপুট হয়, তবে চ্যাট কন্টেইনার উপরে তুলবে
        if (this.id === 'chat-input' && window.innerWidth < 800) {
            const chatCont = document.getElementById('chatbot-container');
            if(chatCont) {
                chatCont.style.transition = "bottom 0.3s ease";
                chatCont.style.bottom = "380px"; 
            }
        }
    });

    element.addEventListener('blur', function() {
        // চ্যাটবক্স থেকে ফোকাস চলে গেলে সেটি আবার নিচে নামিয়ে দেবে
        if (this.id === 'chat-input' && window.innerWidth < 800) {
            const chatCont = document.getElementById('chatbot-container');
            if(chatCont) chatCont.style.bottom = "100px";
        }
    });
});
   // --- CUSTOM ALERT SYSTEM (Removes localhost text) ---
    // 1. Create Styling dynamically
    const alertStyle = document.createElement('style');
    alertStyle.innerHTML = `
        #custom-alert {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(23, 28, 44, 0.95), rgba(10, 10, 20, 0.98));
            border: 1px solid var(--primary, #21D4FD);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 15px;
            z-index: 100000;
            text-align: center;
            min-width: 280px;
            backdrop-filter: blur(10px);
        }
        #custom-alert p {
            color: #fff; margin-bottom: 20px; font-size: 1rem;
        }
        #custom-alert button {
            background: var(--primary, #21D4FD);
            color: #000; border: none;
            padding: 8px 25px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
        }
        #alert-overlay {
            display: none;
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 99999;
        }
    `;
    document.head.appendChild(alertStyle);

    // 2. Create HTML Elements
    const overlay = document.createElement('div');
    overlay.id = 'alert-overlay';
    document.body.appendChild(overlay);

    const alertBox = document.createElement('div');
    alertBox.id = 'custom-alert';
    alertBox.innerHTML = `<p id="alert-msg"></p><button onclick="closeCustomAlert()">OK</button>`;
    document.body.appendChild(alertBox);

    // 3. Override Default Alert
    window.alert = function(message) {
        document.getElementById('alert-msg').innerText = message;
        document.getElementById('alert-overlay').style.display = 'block';
        document.getElementById('custom-alert').style.display = 'block';
    };

    window.closeCustomAlert = function() {
        document.getElementById('alert-overlay').style.display = 'none';
        document.getElementById('custom-alert').style.display = 'none';
    };
    
    // --- MOANA TOOLS LOGIC ---

// চ্যাটবট দিয়ে ওপেন করার জন্য কমান্ড
function checkMoanaCommand(text) {
    if(text.toLowerCase() === 'tools') {
        document.getElementById('moana-tools-modal').style.display = 'flex';
        addMessage('bot', "Moana Tools The window is opened.");
        return true;
    }
    return false;
}

// Tab Switching
function switchMoanaTab(type) {
    const wordSec = document.getElementById('moana-word-sec');
    const emailSec = document.getElementById('moana-email-sec');
    const tab1 = document.getElementById('moana-tab-1');
    const tab2 = document.getElementById('moana-tab-2');

    if(type === 'word') {
        wordSec.style.display = 'block';
        emailSec.style.display = 'none';
        tab1.style.background = '#0077be'; tab1.style.color = 'white';
        tab2.style.background = 'none'; tab2.style.color = '#005662';
    } else {
        wordSec.style.display = 'none';
        emailSec.style.display = 'block';
        tab2.style.background = '#0077be'; tab2.style.color = 'white';
        tab1.style.background = 'none'; tab1.style.color = '#005662';
    }
}

// Word Counter
document.getElementById('moana-text-input').addEventListener('input', function() {
    const text = this.value.trim();
    document.getElementById('m-char-count').innerText = this.value.length;
    document.getElementById('m-word-count').innerText = text === "" ? 0 : text.split(/\s+/).length;
});

function clearMoanaText() {
    document.getElementById('moana-text-input').value = "";
    document.getElementById('m-char-count').innerText = "0";
    document.getElementById('m-word-count').innerText = "0";
}

// AI Image Scanner
async function moanaScanImage() {
    const file = document.getElementById('moana-img-input').files[0];
    if (!file) return;
    alert("Starting AI scan... Please wait.");
    try {
        const { data: { text } } = await Tesseract.recognize(file, 'eng');
        const emails = text.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi);
        if (emails) {
            document.getElementById('moana-email-list').value = [...new Set(emails)].join('\n');
            alert("Success! Emails extracted.");
        } else {
            alert("No emails found in the image.");
        }
    } catch (e) {
        alert("Scan Error!");
    }
}

// Generate Email Format
function moanaGenerate() {
    const emails = document.getElementById('moana-email-list').value.split('\n');
    const pass = document.getElementById('moana-pass-input').value;
    if(!emails[0] || !pass) return alert("Please enter both emails and password!");
    
    let res = emails.map(e => e.trim() ? `Email: ${e.trim()}\nPassword: ${pass}` : '').filter(x => x).join('\n\n');
    document.getElementById('moana-output').value = res;
}

// Copy to Clipboard
function moanaCopy() {
    const out = document.getElementById('moana-output');
    if(!out.value) return;
    out.select();
    document.execCommand('copy');
    alert("Result copied successfully! ✅");
}
    let appLockData = null; // ফায়ারবেস থেকে আসা লক ডাটা থাকবে এখানে

function updateLockPlaceholder() {
    const type = document.getElementById('lock-type-select').value;
    const input = document.getElementById('new-app-lock');
    
    // ১. এই লাইনটি মোড পরিবর্তনের সময় ভুল ডাটা মুছে দেয় (খুবই দরকারি)
    input.value = '';

    if(type === 'pin') {
        input.type = "tel"; 
        input.inputMode = "numeric"; 
        input.style.webkitTextSecurity = "disc"; // পিন ডট হিসেবে দেখাবে
        input.placeholder = "Enter PIN (Digits only)";
    } else {
        input.type = "password"; 
        input.inputMode = "text"; 
        input.style.webkitTextSecurity = "none"; // সাধারণ পাসওয়ার্ড স্টাইল
        input.placeholder = "Enter Password (6-11 Chars)";
    }
}

// এটি হচ্ছে আপনার ২ নম্বর অপশন (সেভ করার লজিক)
async function saveAppLockSettings() {
    const user = auth.currentUser;
    if(!user) return;
    
    // ইউজার কি সিলেক্ট করলো (পিন না পাসওয়ার্ড) সেটা চেক করা
    const lockType = document.getElementById('lock-type-select').value; 
    const lockVal = document.getElementById('new-app-lock').value.trim();
    
    if(lockType === 'pin') {
        // এই লাইনটি চেক করে লেখাটি কি শুধু "সংখ্যা" কি না
        const isNumeric = /^\d+$/.test(lockVal);
        if(!isNumeric || lockVal.length < 4 || lockVal.length > 11) {
            alert("Wrong: PIN must be between 4 and 11 digits!");
            return; // ভুল হলে এখানেই কাজ থেমে যাবে
        }
    } else {
        // পাসওয়ার্ডের জন্য নিয়ম চেক
        if(lockVal.length < 6 || lockVal.length > 11) {
            alert("Incorrect: Password must be at least 6 characters long.!");
            return;
        }
    }

    // সব ঠিক থাকলে Firebase-এ সেভ হবে
    try {
        await db.collection('users').doc(user.uid).collection('security').doc('app_lock').set({
            lockValue: lockVal,
            lockType: lockType, // এখানে পিন না পাসওয়ার্ড সেটা সেভ হচ্ছে
            fingerprintEnabled: (appLockData && appLockData.fingerprintEnabled) ? true : false
        });
        alert("Settings Saved Successfully! ✅");
        document.getElementById('new-app-lock').value = '';
        fetchAppLockSettings(); 
    } catch(e) { alert("Error!"); }
}

// ১. ফায়ারবেস থেকে লক সেটিংস চেক করা
async function fetchAppLockSettings() {
    const user = auth.currentUser;
    if(!user) return;
    
    // হার্ড কোড স্টাইলে ডাটা আনা হচ্ছে
    const doc = await db.collection('users').doc(user.uid).collection('security').doc('app_lock').get();
    
    if(doc.exists) {
        appLockData = doc.data();
        
        // --- লজিক চেক ---
        const isAutoLockOn = appLockData.autoLockEnabled !== false; // ডিফল্ট ON
        appLockData.autoLockEnabled = isAutoLockOn; 

        // আইকন সেট করা
        const icon = document.getElementById('auto-lock-icon');
        if(icon) {
            if (isAutoLockOn) {
                icon.className = "fas fa-toggle-on";
                icon.style.color = "var(--success)";
            } else {
                icon.className = "fas fa-toggle-off";
                icon.style.color = "#666";
            }
        }
        
        showLockScreen(); 
        updateSecurityUI();
    }
}

 // ২. অ্যাপ খোলার সময় কিবোর্ড কন্ট্রোল ও পিন গোপন করার উন্নত লজিক
function showLockScreen() {
    const lockScreen = document.getElementById('app-lock-screen');
    const pinInput = document.getElementById('app-pin-input');
    
    // --- নতুন ফিক্স: API পিন বক্স খোলা থাকলে মেইন লক আসবে না ---
    const apiAuthModal = document.getElementById('api-auth-modal');
    if (apiAuthModal && apiAuthModal.style.display === 'flex') {
        return; // এখানেই থেমে যাবে, লক স্ক্রিন আসবে না
    }
    // -------------------------------------------------------

    // চেক করা হচ্ছে লক স্ক্রিন অলরেডি ওপেন আছে কি না
    if (lockScreen.style.display === 'flex') {
        return; 
    }
    
    // লক স্ক্রিন শো করা
    lockScreen.style.display = 'flex';
    
    if(!appLockData) {
        pinInput.value = '';
        pinInput.placeholder = "Loading Security...";
        return;
    }

    if(appLockData.fingerprintEnabled && window.AppInventor) {
        setTimeout(() => {
            // এপিআই বক্স খোলা থাকলে কমান্ড পাঠাবে না
            if(document.getElementById('api-auth-modal').style.display !== 'flex') {
                window.AppInventor.setWebViewString("SCAN_FINGERPRINT_LOCK"); 
            }
        }, 300);
    }

    // পিন বা পাসওয়ার্ড মোড সেট করা
    if (appLockData.lockType === 'pin') {
        pinInput.type = "tel"; 
        pinInput.inputMode = "numeric"; 
        pinInput.style.webkitTextSecurity = "disc"; 
        pinInput.classList.add('pin-hidden'); 
        pinInput.placeholder = "Enter PIN"; 
    } else {
        pinInput.type = "password"; 
        pinInput.inputMode = "text"; 
        pinInput.style.webkitTextSecurity = "none"; 
        pinInput.classList.remove('pin-hidden');
        pinInput.placeholder = "Enter Password"; 
    }

    if(appLockData.fingerprintEnabled) {
        const fingerSection = document.getElementById('fingerprint-lock-section');
        if(fingerSection) fingerSection.style.display = 'block';
    }
}

// আনলক লজিক
function unlockApp() {
    const pinInput = document.getElementById('app-pin-input');
    const inputVal = pinInput.value;
    
    if(!appLockData) {
        document.getElementById('app-lock-screen').style.display = 'none';
        return;
    }

    if(inputVal === appLockData.lockValue) {
        document.getElementById('app-lock-screen').style.display = 'none';
        pinInput.value = '';
        // একবার আনলক হলে সেশন সেভ রাখা (ঐচ্ছিক)
        sessionStorage.setItem('appUnlocked', 'true');
    } else {
        alert("Wrong PIN/Password! Enter the correct PIN or use 'Forgot PIN'.");
        pinInput.value = '';
    }
}

// ফিঙ্গারপ্রিন্ট লজিক (Kodular এর জন্য)
function triggerLockFingerprint() {
    if (window.AppInventor) {
        window.AppInventor.setWebViewString("SCAN_FINGERPRINT_LOCK");
    } else {
        alert("Biometric not available in browser.");
    }
}

// বায়োমেট্রিক অন-অফ টগল
async function toggleBiometric() {
    const user = auth.currentUser;
    if(!appLockData) return alert("Set PIN first!");
    const newState = !appLockData.fingerprintEnabled;
    await db.collection('users').doc(user.uid).collection('security').doc('app_lock').update({
        fingerprintEnabled: newState
    });
    appLockData.fingerprintEnabled = newState;
    updateSecurityUI();
}

function updateSecurityUI() {
    const btn = document.getElementById('toggle-biometric-btn');
    if(appLockData.fingerprintEnabled) {
        btn.innerText = "Fingerprint: ON";
        btn.style.background = "var(--primary)";
    } else {
        btn.innerText = "Fingerprint: OFF";
        btn.style.background = "#444";
    }
}
// অ্যাপ মিনিমাইজ হলে লক হবে কি না (সরাসরি ভেরিয়েবল চেক)
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        // যদি ডাটা থাকে এবং অটো লক ON (true) করা থাকে
        if (appLockData && appLockData.autoLockEnabled === true) {
            showLockScreen();
        }
    }
});




// ১. এডিট বাটনে ক্লিক করলে এটি রান হবে
function requestAuthForApi() {
    // ১. প্রথমেই পিন দেওয়ার মোডালটি শো করবে
    document.getElementById('api-auth-modal').style.display = 'flex';
    document.getElementById('api-auth-input').value = ''; 
    document.getElementById('api-auth-input').focus();

    // ২. এরপর চেক করবে অ্যাপে ফিঙ্গারপ্রিন্ট আছে কি না, থাকলে স্ক্যানার চালু করবে
    if (window.AppInventor && appLockData && appLockData.fingerprintEnabled) {
        window.AppInventor.setWebViewString("SCAN_FINGERPRINT_FOR_API");
    }
}

// ২. মডার্ন মোডাল থেকে পিন ভেরিফাই করার জন্য নতুন এই ফাংশনটি যোগ করুন
function verifyApiAuth() {
    const enteredPin = document.getElementById('api-auth-input').value;
    
    // appLockData থেকে সেভ করা পিন/পাসওয়ার্ড চেক করা হচ্ছে
    if (appLockData && enteredPin === appLockData.lockValue) {
        // পিন সঠিক হলে
        document.getElementById('api-auth-modal').style.display = 'none'; // পিন বক্স বন্ধ হবে
        openApiEdit(); // এডিট অপশন চালু হবে
    } else {
        // পিন ভুল হলে
        alert("Wrong PIN/Password! ❌");
        document.getElementById('api-auth-input').value = '';
    }
} 

// ২. এডিট করার উইন্ডো ওপেন করা
function openApiEdit() {
    document.getElementById('api-view-mode').style.display = 'none';
    document.getElementById('api-edit-mode').style.display = 'block';
    document.getElementById('new-bot-token').value = TG_BOT_TOKEN;
    document.getElementById('new-chat-id').value = TG_CHAT_ID;
}

// ৩. ডাটাবেজে নতুন এপিআই সেভ করা
async function saveApiSettings() {
    const newToken = document.getElementById('new-bot-token').value.trim();
    const newId = document.getElementById('new-chat-id').value.trim();
    
    if(!newToken || !newId) return alert("Fill in all the boxes!");

    try {
        await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('config').doc('telegram_api').set({
            token: newToken,
            chatId: newId
        });
        
        alert("API Settings updated! The app is automatically reloading...");
        location.reload(); 
    } catch(e) {
        alert("There was a problem saving: " + e.message);
    }
}



function closeApiEdit() {
    document.getElementById('api-view-mode').style.display = 'block';
    document.getElementById('api-edit-mode').style.display = 'none';
}



// এটি আপনার HTML এর স্ক্রিপ্ট সেকশনে যোগ করুন
window.showApiPinModal = function() {
    // API পিন দেওয়ার মোডালটি দেখাবে
    const apiModal = document.getElementById('api-auth-modal');
    if (apiModal) {
        apiModal.style.display = 'flex';
        document.getElementById('api-auth-input').value = '';
        document.getElementById('api-auth-input').focus();
    }
};
let confirmCallback = null;

// ডিফল্ট কনফার্ম বক্সের পরিবর্তে এটি কাজ করবে
window.confirmDelete = function(message, callback) {
    document.getElementById('confirm-msg').innerText = message;
    document.getElementById('custom-confirm-overlay').style.display = 'block';
    confirmCallback = callback;
}

window.closeConfirm = function(result) {
    document.getElementById('custom-confirm-overlay').style.display = 'none';
    if(result && confirmCallback) {
        confirmCallback();
    }
}
// ১. শেয়ার বাটন ক্লিক করলে মোডাল ওপেন হবে

let tempShareData = {}; 

// ৩ নম্বর ধাপের সম্পূর্ণ কোড (এটি আপনার ফাইলের আগের এই নামের ফাংশনগুলোকে রিপ্লেস করবে)

// ১. শেয়ার বাটন ক্লিক করলে মোডাল ওপেন করার ফাংশন
window.shareInformation = function(id, isContact = false, mailIdx = null) {
    const modal = document.getElementById('share-pass-modal');
    const input = document.getElementById('set-share-password');
    const confirmBtn = document.getElementById('final-share-btn');
    
    // mailIdx ডাটাটি এখানে সেভ করা হচ্ছে
    tempShareData = { id, isContact, mailIdx };
    input.value = ""; 
    modal.style.display = 'flex';
    input.focus();

    confirmBtn.onclick = () => executeFinalShare();
}

// ২. ফাইনাল লিঙ্ক জেনারেট করার ফাংশন (সরাসরি লং লিঙ্ক ব্যবহার করা হয়েছে)
async function executeFinalShare() {
    const pass = document.getElementById('set-share-password').value.trim();
    const btn = document.getElementById('final-share-btn');
    const { id, isContact, mailIdx } = tempShareData; 
    const collectionName = isContact ? 'contacts' : 'informations';

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    btn.disabled = true;

    try {
        // ফায়ারবেসে ডাটা আপডেট (পাসওয়ার্ড এবং এক্সপায়ারি সেট করা)
        const expiryTimestamp = Date.now() + (24 * 60 * 60 * 1000); 
        await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection(collectionName).doc(id).update({
            sharePassword: pass || null,
            expiresAt: expiryTimestamp,
            isShared: true 
        });

        // অরিজিনাল লং লিঙ্ক তৈরি করা হচ্ছে
        let longUrl = `${window.location.origin}${window.location.pathname}?view=${id}&type=${isContact ? 'contact' : 'info'}`;
        
        if (mailIdx !== null) {
            longUrl += `&idx=${mailIdx}`; // নির্দিষ্ট মেইলের ইনডেক্স যোগ করা হলো
        }

        const finalLink = longUrl; // এখানে সরাসরি লং লিঙ্কটি রাখা হলো

        // ক্লিপবোর্ডে কপি করার লজিক
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(finalLink);
        } else {
            const textArea = document.createElement("textarea");
            textArea.value = finalLink;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }

        document.getElementById('share-pass-modal').style.display = 'none';
        alert(`Original Link Copied! 🚀\nURL: ${finalLink}`);

    } catch (err) {
        alert("Error: Link generation failed.");
        console.error(err);
    } finally {
        btn.innerHTML = "GENERATE LINK";
        btn.disabled = false;
    }
}

// ২. পেজ লোড হলে লিঙ্ক চেক করা
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const sharedId = urlParams.get('view');

    if (sharedId) {
        if(document.getElementById('loading-screen')) document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('login-page').style.display = 'none';
        if(document.getElementById('admin-panel')) document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('public-share-view').style.display = 'block';
        loadUniversalData(sharedId);
    }
});

// ৩. ইউনিফাইড লোডার
async function loadUniversalData(id) {
    const area = document.getElementById('share-content-area');
    const expireScreen = document.getElementById('expire-screen');
    const passScreen = document.getElementById('password-screen');
    
    const urlParams = new URLSearchParams(window.location.search);
    const type = urlParams.get('type') || 'info'; 
    const collectionName = type === 'contact' ? 'contacts' : 'informations';

    try {
        const doc = await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection(collectionName).doc(id).get();
        if (!doc.exists) {
            area.style.display = 'block';
            area.innerHTML = "<h2 style='text-align:center; padding:50px;'>Data not found.!</h2>";
            return;
        }

        currentSharedData = { id: doc.id, ...doc.data() };
        const now = Date.now();
        if (currentSharedData.expiresAt && now > currentSharedData.expiresAt) {
            expireScreen.style.display = 'block';
            area.style.display = 'none';
            passScreen.style.display = 'none';
            return; 
        }

        if (currentSharedData.sharePassword) {
            area.style.display = 'none';
            passScreen.style.display = 'block';
        } else {
            area.style.display = 'block';
            renderSharedContent();
        }
    } catch (e) {
        area.style.display = 'block';
        area.innerHTML = "<h2>Loading error!</h2>";
    }
}

function verifySharePassword() {
    const inputPass = document.getElementById('share-pass-input').value;
    if (inputPass === currentSharedData.sharePassword) {
        document.getElementById('password-screen').style.display = 'none';
        document.getElementById('share-content-area').style.display = 'block';
        renderSharedContent();
    } else {
        alert("Wrong password! ");
    }
}

// ৪. রেন্ডারার ফাংশন (সব শেয়ার ভিউ একসাথে আপডেট করা হলো)
async function renderSharedContent() {
    const area = document.getElementById('share-content-area');
    const data = currentSharedData;
    area.innerHTML = '<div style="text-align:center; padding:50px;"><i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary);"></i><p style="margin-top:15px;">Loading Content...</p></div>';
    let html = "";

    try {
        const urlParams = new URLSearchParams(window.location.search);
        
        if (data.phone) {
            // --- কন্টাক্ট শেয়ার ভিউ (Copy Button সহ) ---
            let phoneRows = data.phone.map(p => `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; background:rgba(255,255,255,0.03); padding:8px 12px; border-radius:10px;">
                    <span style="font-size:1.1rem;">${p}</span>
                    <i class="fas fa-copy" style="color:var(--primary); cursor:pointer; font-size:1rem; opacity:0.7;" onclick="navigator.clipboard.writeText('${p}'); alert('Phone Copied!')"></i>
                </div>
            `).join('');

            html = `
                <div style="text-align:center; margin-bottom:20px;">
                    <div style="width:70px; height:70px; background:var(--primary); color:black; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px; font-size:1.8rem;"><i class="fas fa-user"></i></div>
                    <h2 style="margin-bottom:5px;">${data.name}</h2>
                    <p style="color:#aaa; font-size:0.8rem;">Contact Card</p>
                </div>
                <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                    <small style="color:var(--primary); font-weight:bold; display:block; margin-bottom:10px;">Phone number(s):</small>
                    <div style="margin-bottom:20px;">${phoneRows}</div>
                    
                    ${data.email ? `
                        <small style="color:var(--primary); font-weight:bold;">Email:</small>
                        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.03); padding:8px 12px; border-radius:10px; margin-top:5px; margin-bottom:15px;">
                            <span style="font-size:0.95rem; word-break:break-all;">${data.email}</span>
                            <i class="fas fa-copy" style="color:var(--primary); cursor:pointer; opacity:0.7;" onclick="navigator.clipboard.writeText('${data.email}'); alert('Email Copied!')"></i>
                        </div>` : ''}
                    
                    ${data.address ? `
                        <small style="color:var(--primary); font-weight:bold;">Address:</small>
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; background:rgba(255,255,255,0.03); padding:8px 12px; border-radius:10px; margin-top:5px;">
                            <span style="font-size:0.9rem; flex:1; padding-right:10px;">${data.address}</span>
                            <i class="fas fa-copy" style="color:var(--primary); cursor:pointer; opacity:0.7; margin-top:3px;" onclick="navigator.clipboard.writeText('${data.address.replace(/'/g, "\\'")}'); alert('Address Copied!')"></i>
                        </div>` : ''}
                </div>
                <div style="margin-top:25px; text-align:center;">
                    <a href="tel:${data.phone[0]}" class="btn" style="background:var(--success); color:black; font-weight:bold; padding:12px 40px; border-radius:50px; display:inline-block; text-decoration:none; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">Call Now</a>
                </div>`;
        }
        else if (data.category === 'text') {
            // --- টেক্সট ইনফো শেয়ার ভিউ ---
            html = `
                <div style="text-align:center; padding: 10px;">
                    <div style="margin-bottom:20px;"><span style="background:var(--primary); color:black; padding:4px 12px; border-radius:5px; font-size:0.75rem; font-weight:bold; text-transform:uppercase;">${data.category}</span></div>
                    <h2 style="margin-bottom:25px; font-weight:800; color: #fff; font-size: 1.6rem;">${data.title}</h2>
                    <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; text-align:left; color:#eee; line-height:1.6; white-space:pre-wrap; font-size:1rem; border: 1px solid rgba(255,255,255,0.1); margin-bottom:25px; max-height:400px; overflow-y:auto;">${data.fullContent}</div>
                    <button onclick="navigator.clipboard.writeText(\`${data.fullContent.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`); alert('Text Copied! 📋')" style="width:100%; padding:18px; border-radius:40px; border:none; background: #fff; color: #000; font-weight:bold; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow: 0 8px 20px rgba(255,255,255,0.15);">
                        COPY TEXT <i class="fas fa-copy"></i>
                    </button>
                    <button onclick="window.location.href='index.html'" style="margin-top:40px; background:none; border:none; color:#64748b; font-weight:bold; letter-spacing:3px; cursor:pointer; text-transform:uppercase; font-size:0.8rem; opacity: 0.7;">CLOSE</button>
                </div>`;
        }
        else if (data.category === 'link') {
            // --- লিঙ্ক ইনফো শেয়ার ভিউ ---
            html = `
                <div style="text-align:center; padding: 10px;">
                    <div style="margin-bottom:20px;"><span style="background:var(--primary); color:black; padding:4px 12px; border-radius:5px; font-size:0.75rem; font-weight:bold; text-transform:uppercase;">${data.category}</span></div>
                    <h2 style="margin-bottom:45px; font-weight:800; color: #fff; font-size: 1.8rem;">${data.title}</h2>
                    <a href="${data.fullContent}" target="_blank" style="text-decoration:none;">
                        <button style="width:100%; padding:18px; border-radius:40px; border:none; background: #fff; color: #000; font-weight:bold; font-size:1.1rem; margin-bottom:15px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow: 0 8px 20px rgba(255,255,255,0.15);">
                            OPEN LINK <i class="fas fa-external-link-alt"></i>
                        </button>
                    </a>
                    <button onclick="navigator.clipboard.writeText('${data.fullContent}'); alert('Link Copied! 📋')" style="width:100%; padding:18px; border-radius:40px; border:none; background: #1e293b; color: #fff; font-weight:bold; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; border: 1px solid rgba(255,255,255,0.1);">
                        COPY LINK <i class="fas fa-copy"></i>
                    </button>
                    <button onclick="window.location.href='index.html'" style="margin-top:50px; background:none; border:none; color:#64748b; font-weight:bold; letter-spacing:3px; cursor:pointer; text-transform:uppercase; font-size:0.8rem; opacity: 0.7;">CLOSE</button>
                </div>`;
        }
        else if (data.category === 'mail') {
            // --- মেইল ইনফো শেয়ার ভিউ (সিলেক্টিভ শেয়ারিং সাপোর্ট) ---
            const idxParam = urlParams.get('idx');
            const allowedIndices = idxParam ? idxParam.split(',') : null;
            
            html = `<div style="text-align:center; padding: 10px;">
                    <div style="margin-bottom:20px;"><span style="background:var(--primary); color:black; padding:4px 12px; border-radius:5px; font-size:0.75rem; font-weight:bold; text-transform:uppercase;">${data.category}</span></div>
                    <h2 style="margin-bottom:30px; font-weight:800; color: #fff;">${data.title}</h2>`;

            const entries = data.fullContent.split('|||');
            entries.forEach((acc, idx) => {
                if (allowedIndices !== null && !allowedIndices.includes(idx.toString())) return;
                const [e, p] = acc.split(' | Password: ').map(s => s.replace('Email: ', ''));
                html += `
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.1); text-align:left;">
                    <small style="color:var(--primary); font-weight:bold; display:block; margin-bottom:10px;">Account ${idx + 1}</small>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-bottom:10px;">
                        <span style="font-size:0.9rem;">${e}</span>
                        <button onclick="navigator.clipboard.writeText('${e}'); alert('Email Copied!')" style="background:var(--primary); border:none; padding:5px 10px; border-radius:5px; cursor:pointer;"><i class="fas fa-copy"></i></button>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
                        <span style="font-size:0.9rem;">${p || 'N/A'}</span>
                        <button onclick="navigator.clipboard.writeText('${p || ''}'); alert('Password Copied!')" style="background:var(--primary); border:none; padding:5px 10px; border-radius:5px; cursor:pointer;"><i class="fas fa-copy"></i></button>
                    </div>
                </div>`;
            });
            html += `<button onclick="window.location.href='index.html'" style="margin-top:30px; background:none; border:none; color:#64748b; font-weight:bold; letter-spacing:3px; cursor:pointer; text-transform:uppercase; font-size:0.8rem;">CLOSE</button></div>`;
        }
        else if (['photo', 'video', 'audio', 'file'].includes(data.category)) {
            // --- মিডিয়া শেয়ার ভিউ (PREMIUM UNIFIED) ---
            html = `<div style="text-align:center; padding: 10px;">
                    <div style="margin-bottom:20px;"><span style="background:var(--primary); color:black; padding:4px 12px; border-radius:5px; font-size:0.75rem; font-weight:bold; text-transform:uppercase;">${data.category}</span></div>
                    <h2 style="margin-bottom:25px; font-weight:800; color: #fff; font-size: 1.6rem;">${data.title}</h2>`;

            const apiDoc = await db.collection('users').doc("fAd8WCdkBdS8kjvdGfqUKeW2Myr1").collection('config').doc('telegram_api').get();
            const token = apiDoc.data().token;
            const tgRes = await fetch(`https://api.telegram.org/bot${token}/getFile?file_id=${data.fullContent}`);
            const tgData = await tgRes.json();
            
            if(tgData.ok) {
                const fileUrl = `https://api.telegram.org/file/bot${token}/${tgData.result.file_path}`;
                html += `<div style="margin-bottom:25px; background:rgba(255,255,255,0.03); padding:10px; border-radius:20px; border:1px solid rgba(255,255,255,0.1); overflow:hidden;">`;
                
                if (data.category === 'photo') html += `<img src="${fileUrl}" style="width:100%; border-radius:15px; display:block;">`;
                else if (data.category === 'video') html += `<video controls style="width:100%; border-radius:15px; display:block;"><source src="${fileUrl}" type="video/mp4"></video>`;
                else if (data.category === 'audio') html += `<div style="padding:20px;"><i class="fas fa-music fa-3x" style="color:var(--primary); margin-bottom:15px;"></i><audio controls style="width:100%;"><source src="${fileUrl}"></audio></div>`;
                else if (data.category === 'file') html += `<div style="padding:40px;"><i class="fas fa-file-pdf fa-4x" style="color:var(--danger); margin-bottom:20px;"></i><p style="color:#ccc;">Document Ready</p></div>`;
                
                html += `
    <button onclick="downloadFileWithTitle('${fileUrl}', '${data.title}')" 
        style="width:100%; padding:18px; border-radius:40px; border:none; background: #fff; color: #000; font-weight:bold; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow: 0 8px 20px rgba(255,255,255,0.15);">
        DOWNLOAD ${data.category.toUpperCase()} <i class="fas fa-download"></i>
    </button>
`;
            } else {
                html += `<div style="padding:50px; color:var(--danger);"><i class="fas fa-exclamation-triangle fa-2x"></i><p>File Expired or Deleted!</p></div>`;
            }
            html += `<button onclick="window.location.href='index.html'" style="margin-top:40px; background:none; border:none; color:#64748b; font-weight:bold; letter-spacing:3px; cursor:pointer; text-transform:uppercase; font-size:0.8rem; opacity: 0.7;">CLOSE</button></div>`;
        }
        
        area.innerHTML = html;
    } catch (e) {
        area.innerHTML = "<p style='text-align:center; padding:50px;'>Loading error occurred. Please refresh.</p>";
    }
}

// ৫. পিন রিসেট লজিক (মাস্টার পাসওয়ার্ড দিয়ে)
// ১. পিন রিসেট মোডাল ওপেন করা
function forgotPinReset() {
    const modal = document.getElementById('pin-reset-modal');
    const errorDiv = document.getElementById('reset-error-msg');
    const input = document.getElementById('master-pass-input');
    
    errorDiv.innerText = ""; // আগের এরর ক্লিয়ার করা
    input.value = ""; // ইনপুট ক্লিয়ার করা
    modal.style.display = 'flex';
    input.focus();
}

// ২. পাসওয়ার্ড ভেরিফাই এবং পিন ডিলিট করার আসল কাজ
async function executePinReset() {
    const user = auth.currentUser;
    const masterPass = document.getElementById('master-pass-input').value;
    const errorDiv = document.getElementById('reset-error-msg');
    const resetBtn = event.target;

    if (!user) return alert("You must be logged in to reset your password!");
    if (!masterPass) return (errorDiv.innerText = "Enter password.!");

    resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    resetBtn.disabled = true;

    try {
        // মাস্টার পাসওয়ার্ড দিয়ে Firebase-এ আবার সাইন ইন করে চেক করা
        await auth.signInWithEmailAndPassword(user.email, masterPass);
        
        // ভেরিফিকেশন সফল হলে ডাটাবেজ থেকে আপনার সঠিক ইউজার আইডির লক ডিলিট করা
        // হার্ডকোড আইডি বাদে ডাইনামিক user.uid ব্যবহার করা হয়েছে
        await db.collection('users').doc(user.uid).collection('security').doc('app_lock').delete();
        
        resetBtn.innerHTML = "Success!";
        alert("Your PIN lock has been successfully removed! ");
        location.reload(); 
    } catch (e) {
        console.error(e);
        resetBtn.innerHTML = "RESET PIN";
        resetBtn.disabled = false;
        errorDiv.innerText = "Wrong password! Please try again. ";
    }
}
// ১. ট্রেনিং ভিউ পরিবর্তন করা (Form এবং List এর মধ্যে)
window.switchTrainView = function(view) {
    const form = document.getElementById('train-view-form');
    const list = document.getElementById('train-view-list');
    if(view === 'form') {
        form.style.display = 'block';
        list.style.display = 'none';
        document.getElementById('edit-train-id').value = ''; // রিসেট আইডি
    } else {
        form.style.display = 'none';
        list.style.display = 'block';
        renderTrainingList(); // লিস্ট দেখানোর জন্য ফাংশন কল
    }
}

// ২. এআই ট্রেনিং ডাটা সেভ করা (Firebase এ)
window.saveTraining = async function() {
    const q = document.getElementById('train-q').value.trim().toLowerCase();
    const a = document.getElementById('train-a').value.trim();
    const editId = document.getElementById('edit-train-id').value;

    if(!q || !a) return alert("Enter both Keyword and Reply!");

    const saveBtn = document.getElementById('train-save-btn');
    saveBtn.innerText = "Saving...";
    saveBtn.disabled = true;

    try {
        if(editId) {
            // যদি এডিট করা হয়
            await db.collection('global_bot_training').doc(editId).update({
                keyword: q,
                reply: a,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Lesson Updated!");
        } else {
            // নতুন ডাটা যোগ করা
            await db.collection('global_bot_training').add({
                keyword: q,
                reply: a,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Lesson Saved!");
        }
        
        // ইনপুট রিসেট করা
        document.getElementById('train-q').value = '';
        document.getElementById('train-a').value = '';
        switchTrainView('list'); // সেভ হওয়ার পর লিস্টে চলে যাবে
    } catch(e) {
        alert("Error saving: " + e.message);
    } finally {
        saveBtn.innerText = "Save Lesson";
        saveBtn.disabled = false;
    }
}

// ৩. ট্রেনিং লিস্ট রেন্ডার করা (History View)
function renderTrainingList() {
    const container = document.getElementById('training-list-container');
    container.innerHTML = '<p style="text-align:center;">Loading History...</p>';

    db.collection('global_bot_training').orderBy('createdAt', 'desc').onSnapshot(snap => {
        container.innerHTML = '';
        if(snap.empty) {
            container.innerHTML = '<p style="text-align:center; color:#888;">No history found.</p>';
            return;
        }
        snap.forEach(doc => {
            const data = doc.data();
            container.innerHTML += `
                <div class="setting-row" style="background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:8px;">
                    <div style="flex:1;">
                        <small style="color:var(--primary);">Q: ${data.keyword}</small><br>
                        <span style="font-size:0.85rem;">A: ${data.reply}</span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="editTraining('${doc.id}', '${data.keyword}', '${data.reply}')" class="edit-btn"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteTraining('${doc.id}')" class="delete-btn"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
        });
    });
}

// ৪. ট্রেনিং ডিলিট করা
// Line 926 এর আশেপাশে খুঁজুন
window.deleteTraining = function(id) {
    window.confirmDelete("Are you sure you want to delete this lesson?", function() {
        db.collection('global_bot_training').doc(id).delete();
    });
}

// ৫. ট্রেনিং এডিট করা
window.editTraining = function(id, q, a) {
    document.getElementById('edit-train-id').value = id;
    document.getElementById('train-q').value = q;
    document.getElementById('train-a').value = a;
    document.getElementById('train-view-form').style.display = 'block';
    document.getElementById('train-view-list').style.display = 'none';
}

// ৬. লিস্টের ভেতরে সার্চ (Filter) করা
window.filterTraining = function() {
    const term = document.getElementById('train-search').value.toLowerCase();
    const rows = document.querySelectorAll('#training-list-container .setting-row');
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(term) ? 'flex' : 'none';
    });
}

// কিউআর কোড ডাউনলোড করার ফাংশন
window.downloadQRCode = function(id) {
    const container = document.getElementById(id);
    if (!container) return;

    // qrcode.js সাধারণত একটি canvas অথবা img ট্যাগ তৈরি করে
    const img = container.querySelector('img');
    const canvas = container.querySelector('canvas');
    let dataUrl = "";

    if (img && img.src) {
        dataUrl = img.src;
    } else if (canvas) {
        dataUrl = canvas.toDataURL("image/png");
    }

    if (dataUrl) {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = `QR_Code_${Date.now()}.png`; // ফাইল নেম
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        alert("The QR image has not been created yet, please try again later.");
    }
};
// এই ফাংশনটি লিঙ্ক ওপেন করতে সাহায্য করবে
window.openExternalLink = function(url) {
    // যদি আপনি Kodular ব্যবহার করেন, এটি অ্যাপের সিস্টেম ব্রাউজার ট্রিমার করবে
    if (window.AppInventor) {
        // Kodular এর 'WebViewString' এর মাধ্যমে লিঙ্ক পাঠানো (যদি ব্লক সেট করা থাকে)
        window.AppInventor.setWebViewString("OPEN_URL:" + url);
    }
    
    // সাধারণ ব্রাউজার ওপেন করার চেষ্টা
    let win = window.open(url, '_blank');
    if (win) {
        win.focus();
    } else {
        // যদি পপ-আপ ব্লক থাকে তবে সরাসরি লোকেশন চেঞ্জ
        window.location.href = url;
    }
};
window.shareSelectedMails = function(infoId) {
    const selectedBoxes = document.querySelectorAll('.mail-select-checkbox:checked');
    if (selectedBoxes.length === 0) {
        alert("Please select at least one account to share!");
        return;
    }

    // সব সিলেক্টেড ইনডেক্স কমা (,) দিয়ে জয়েন করা হচ্ছে
    const indices = Array.from(selectedBoxes).map(cb => cb.getAttribute('data-idx')).join(',');
    
    // আগের শেয়ার ফাংশন কল করা হচ্ছে (mailIdx এর জায়গায় এখন indices স্ট্রিং যাবে)
    shareInformation(infoId, false, indices);
}
// টাইটেল অনুযায়ী ফাইল ডাউনলোড করার ফাংশন
window.downloadFileWithTitle = async function(url, filename) {
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        const blobUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = blobUrl;
        a.download = filename; // আপনার দেওয়া টাইটেল এখানে সেট হবে
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(blobUrl);
        document.body.removeChild(a);
    } catch (e) {
        // যদি কোনো কারণে ফেল করে, তবে সরাসরি লিঙ্কে ওপেন হবে
        window.open(url, '_blank');
    }
}
// --- প্রফেশনাল এপিআই জেনারেশন লজিক ---
let currentFullKey = "";
let currentFullUrl = "";
let apiState = { key: "hidden", url: "hidden" };
let scrambleIntervals = { key: null, url: null };
const scrambleChars = "!@#$%^&*()_+{}[];:,.<>?0123456789";

// ১. এই ফাংশনটি অ্যাপ ওপেন হওয়ার সাথে সাথে কল হবে এবং ডাটাবেজ থেকে এপিআই নিয়ে আসবে
async function fetchExistingApi() {
    const uid = "fAd8WCdkBdS8kjvdGfqUKeW2Myr1"; // আপনার হার্ডকোড আইডি
    try {
        const doc = await db.collection('users').doc(uid).collection('config').doc('api_access').get();
        if (doc.exists) {
            currentFullKey = doc.data().apiKey;
            currentFullUrl = "https://script.google.com/macros/s/AKfycbxjzT-qKr9zwF5SU3bPmkhEN-vxAS1A0SbMlWUrJ3TmCjWt4Wl-aGFIXwVJwNEyk34L-Q/exec?key=" + currentFullKey;
            console.log("API Loaded from database.");
        }
    } catch (e) {
        console.log("Error loading API:", e);
    }
}

// ২. পোর্টাল ওপেন করার লজিক (Fix)
window.toggleApiPortal = async function() {
    const container = document.getElementById('api-main-container');
    const viewBtn = document.getElementById('pro-view-btn');

    // যদি ভেরিয়েবল খালি থাকে, তবে আরেকবার ডাটাবেজ চেক করবে (নিরাপত্তার জন্য)
    if (currentFullKey === "") {
        viewBtn.innerText = "Checking Cloud...";
        await fetchExistingApi();
    }

    if (currentFullKey === "") {
        alert("No API record found in Cloud. Please generate a new one below.");
        viewBtn.innerText = "SEE API ACCESS";
        return;
    }

    // টগল সিস্টেম
    if (container.style.display === "none" || container.style.display === "") {
        container.style.display = "block";
        viewBtn.innerHTML = '<i class="fas fa-eye-slash"></i> HIDE API PORTAL';
        startJirJir('pro-api-key-text');
        startJirJir('pro-api-url-text');
    } else {
        container.style.display = "none";
        viewBtn.innerHTML = '<i class="fas fa-eye"></i> SEE API ACCESS';
    }
}

// ৩. নতুন এপিআই তৈরি (শুধুমাত্র আপনি চাইলে)
window.generateProfessionalApi = async function() {
    if(currentFullKey !== "" && !confirm("Your current API key will stop working. Are you sure?")) return;

    const uid = "fAd8WCdkBdS8kjvdGfqUKeW2Myr1";
    const newApiKey = "IZ-" + Math.random().toString(36).substr(2, 9).toUpperCase();

    try {
        await db.collection('users').doc(uid).collection('config').doc('api_access').set({
            apiKey: newApiKey,
            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
        });
        currentFullKey = newApiKey;
        currentFullUrl = "https://script.google.com/macros/s/AKfycbxjzT-qKr9zwF5SU3bPmkhEN-vxAS1A0SbMlWUrJ3TmCjWt4Wl-aGFIXwVJwNEyk34L-Q/exec?key=" + currentFullKey;
        
        apiState.key = "hidden"; apiState.url = "hidden";
        startJirJir('pro-api-key-text');
        startJirJir('pro-api-url-text');
        alert("Success! New API saved to Cloud. ✅");
    } catch (e) { alert("Database error!"); }
}

// ৪. ক্লিক লজিক (১ম: শো, ২য়: কপি)
window.handleApiInteraction = function(type) {
    const targetId = type === 'key' ? 'pro-api-key-text' : 'pro-api-url-text';
    const val = type === 'key' ? currentFullKey : currentFullUrl;
    const el = document.getElementById(targetId);

    if (apiState[type] === "hidden") {
        clearInterval(scrambleIntervals[type]);
        el.classList.remove('jir-jir');
        el.innerText = val;
        apiState[type] = "visible";
    } else {
        navigator.clipboard.writeText(val);
        alert("Copied to Clipboard! 📋");
    }
}

// জির-জির অ্যানিমেশন
function startJirJir(targetId) {
    const el = document.getElementById(targetId);
    const type = targetId.includes('key') ? 'key' : 'url';
    el.classList.add('jir-jir');
    if (scrambleIntervals[type]) clearInterval(scrambleIntervals[type]);
    scrambleIntervals[type] = setInterval(() => {
        let randomStr = "";
        let len = type === 'key' ? 12 : 30;
        for(let i=0; i<len; i++) randomStr += scrambleChars.charAt(Math.floor(Math.random() * scrambleChars.length));
        el.innerText = randomStr;
    }, 80);
}

// গুরুত্বপূর্ণ: ফায়ারবেস লগইন চেক হওয়ার পর এটি রান হবে
auth.onAuthStateChanged(user => {
    if (user) {
        fetchExistingApi(); // ইউজার লগইন থাকলেই ডাটাবেজ থেকে পুরনো এপিআই লোড হবে
    }
});
// কাউন্টার অ্যানিমেশন
function animateValue(id, start, end, duration) {
    if (start === end) return;
    const obj = document.getElementById(id);
    const range = end - start;
    let current = start;
    const increment = end > start ? Math.ceil(end / 20) : -10;
    const stepTime = Math.abs(Math.floor(duration / (range / increment)));
    
    const timer = setInterval(function() {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            obj.innerText = '৳ ' + end.toLocaleString();
            clearInterval(timer);
        } else {
            obj.innerText = '৳ ' + current.toLocaleString();
        }
    }, stepTime);
}

// অটো লক টগল করার ফাংশন (সরাসরি ডাটাবেস কল)
async function toggleAutoLockSetting() {
    const user = auth.currentUser;
    // পিন সেট না থাকলে কাজ করবে না
    if (!user || !appLockData) return alert("First set a PIN/Password from security settings!");

    const icon = document.getElementById('auto-lock-icon');
    
    // বর্তমান অবস্থা চেক (ডিফল্ট true ধরা হয়েছে)
    const currentStatus = appLockData.autoLockEnabled !== false; 
    const newStatus = !currentStatus;

    // আইকন আপডেট (তাৎক্ষণিক রেসপন্স)
    if (newStatus) {
        icon.className = "fas fa-toggle-on";
        icon.style.color = "var(--success)";
    } else {
        icon.className = "fas fa-toggle-off";
        icon.style.color = "#666";
    }

    try {
        // সরাসরি ফায়ারবেস আপডেট
        await db.collection('users').doc(user.uid).collection('security').doc('app_lock').update({
            autoLockEnabled: newStatus
        });
        // গ্লোবাল ভেরিয়েবল আপডেট
        appLockData.autoLockEnabled = newStatus;
    } catch (e) {
        alert("Error updating setting!");
        // এরর হলে আইকন আগের অবস্থায় ফেরত
        icon.className = currentStatus ? "fas fa-toggle-on" : "fas fa-toggle-off";
    }
}
// ১. শুধু বর্তমান ডিভাইস লগআউট (Standard)
async function logoutCurrentDeviceOnly() {
    const user = auth.currentUser;
    const myDeviceId = localStorage.getItem('my_device_id');
    
    // ডাটাবেস থেকে এই সেশন মুছে ফেলা
    if(user && myDeviceId) {
        await db.collection('users').doc(user.uid).collection('sessions').doc(myDeviceId).delete();
    }
    
    auth.signOut().then(() => {
        appLockData = null; 
        location.reload(); 
    });
}
 
// ২. অন্য ডিভাইসকে কিক দেওয়া (Kick Out)
async function kickOutDevice(targetDeviceId) {
    const user = auth.currentUser;
    if(confirm("Logout that device remotely?")) {
        await db.collection('users').doc(user.uid).collection('sessions').doc(targetDeviceId).delete();
        // ওই ডিভাইসটি যখন বুঝবে তার সেশন ডিলেট হয়েছে, সে অটো লগআউট হবে (নিচের কোড দেখুন)
    }
}

// ৩. সব ডিভাইস লগআউট করা
async function logoutAllDevices() {
    const user = auth.currentUser;
    if(!confirm("Are you sure? This will logout everyone including you!")) return;

    // সব সেশন ডিলেট করা
    const snapshot = await db.collection('users').doc(user.uid).collection('sessions').get();
    const batch = db.batch();
    
    snapshot.docs.forEach((doc) => {
        batch.delete(doc.ref);
    });
    
    await batch.commit();
    // শেষে নিজেকে লগআউট
    auth.signOut().then(() => location.reload());
}




</script>
<!-- এই কোডটুকু একদম নিচে </body> এর ঠিক উপরে বসান -->
<script>
(function() {
    // ১. আগের সব বাধা দূর করার জন্য একটি ছোট স্টাইল ইনজেকশন
    const style = document.createElement('style');
    style.innerHTML = `
        #chatbot-trigger { 
            position: fixed !important; 
            touch-action: none !important; 
            transition: none !important; 
            z-index: 999999 !important; 
            cursor: move !important;
            display: flex !important;
        }
    `;
    document.head.appendChild(style);

    const el = document.getElementById('chatbot-trigger');
    const container = document.getElementById('chatbot-container');
    if (!el) return;

    let isDragging = false;
    let startX, startY, initialX, initialY;

    // ২. আগের সব ক্লিক ইভেন্ট মুছে ফেলা (Fresh start)
    el.onclick = null;

    el.addEventListener('touchstart', function(e) {
        isDragging = false;
        const touch = e.touches[0];
        const rect = el.getBoundingClientRect();
        
        startX = touch.clientX;
        startY = touch.clientY;
        initialX = rect.left;
        initialY = rect.top;

        // মুভমেন্ট ট্র্যাক করার জন্য
        const moveHandler = function(e) {
            const touchMove = e.touches[0];
            const dx = touchMove.clientX - startX;
            const dy = touchMove.clientY - startY;

            // যদি ৫ পিক্সেলের বেশি নড়ে, তবেই ড্র্যাগ শুরু
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                isDragging = true;
                e.preventDefault();

                let newX = initialX + dx;
                let newY = initialY + dy;

                // স্ক্রিনের সীমানার ভেতরে রাখা
                newX = Math.max(0, Math.min(newX, window.innerWidth - 60));
                newY = Math.max(0, Math.min(newY, window.innerHeight - 60));

                el.style.left = newX + 'px';
                el.style.top = newY + 'px';
                el.style.bottom = 'auto';
                el.style.right = 'auto';
            }
        };

        const endHandler = function() {
            document.removeEventListener('touchmove', moveHandler);
            document.removeEventListener('touchend', endHandler);

            // যদি ড্র্যাগ না করা হয় (অর্থাৎ শুধু ট্যাপ করা হয়), তবেই চ্যাটবক্স খুলবে
            if (!isDragging) {
                container.style.display = (container.style.display === 'flex') ? 'none' : 'flex';
            }
        };

        document.addEventListener('touchmove', moveHandler, { passive: false });
        document.addEventListener('touchend', endHandler);
    }, { passive: false });

})();

</script>
<script>
// ==========================================
// ১. স্মার্ট ব্যাক বাটন হিস্ট্রি লজিক
// ==========================================
let pageHistoryStack = ['dashboard']; 

function trackAppPage(pageId) {
    if (pageHistoryStack[pageHistoryStack.length - 1] !== pageId) {
        pageHistoryStack.push(pageId);
    }
}

// নেভিগেশন লিংকে ক্লিক করলে হিস্ট্রি ট্র্যাক হবে
document.querySelectorAll('.bottom-nav a').forEach(link => {
    link.addEventListener('click', function() {
        trackAppPage(this.dataset.page);
    });
});

function executeBackStep() {
    if (pageHistoryStack.length > 1) {
        // বর্তমান পেজটি হিস্ট্রি থেকে সরিয়ে ফেলা
        pageHistoryStack.pop(); 
        // আগের পেজটি নেওয়া
        let prevPage = pageHistoryStack.pop(); 
        // সেই পেজে ফিরে যাওয়া (switchPage আবার এটিকে পুশ করবে)
        window.switchPage(prevPage);
    } else {
        // যদি হিস্ট্রি না থাকে তবে ড্যাশবোর্ডে নিয়ে যাওয়া
        window.switchPage('dashboard');
    }
}

// ==========================================
// ২. ড্র্যাগিং লজিক (১০০% আলাদা মুভমেন্ট নিশ্চিত)
// ==========================================
function makeButtonDraggable(id, actionOnTap) {
    const target = document.getElementById(id);
    if (!target) return;

    // প্রতিটি বাটনের জন্য নিজস্ব ডাটা স্টোর
    let state = {
        isDragging: false,
        startX: 0, startY: 0,
        initL: 0, initT: 0
    };

    target.addEventListener('touchstart', function(e) {
        state.isDragging = false;
        const touch = e.touches[0];
        const rect = target.getBoundingClientRect();
        
        state.startX = touch.clientX;
        state.startY = touch.clientY;
        state.initL = rect.left;
        state.initT = rect.top;

        const onTouchMove = (ev) => {
            const mTouch = ev.touches[0];
            const dx = mTouch.clientX - state.startX;
            const dy = mTouch.clientY - state.startY;

            // যদি অন্তত ৫ পিক্সেল নড়ে তবেই মুভমেন্ট ধরবে
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                state.isDragging = true;
                if(ev.cancelable) ev.preventDefault();

                let x = state.initL + dx;
                let y = state.initT + dy;

                // বাউন্ডারি চেক (স্ক্রিনের বাইরে যাবে না)
                x = Math.max(0, Math.min(x, window.innerWidth - target.offsetWidth));
                y = Math.max(0, Math.min(y, window.innerHeight - target.offsetHeight));

                target.style.left = x + 'px';
                target.style.top = y + 'px';
                target.style.bottom = 'auto'; 
                target.style.right = 'auto';
            }
        };

        const onTouchEnd = () => {
            document.removeEventListener('touchmove', onTouchMove);
            document.removeEventListener('touchend', onTouchEnd);
            
            // যদি না নাড়ানো হয় তবেই ক্লিক হিসেবে কাজ করবে
            if (!state.isDragging) {
                actionOnTap();
            }
        };

        document.addEventListener('touchmove', onTouchMove, { passive: false });
        document.addEventListener('touchend', onTouchEnd);
    }, { passive: false });
}

// ==========================================
// ৩. রান এবং স্টাইল ইনজেকশন
// ==========================================
(function() {
    const style = document.createElement('style');
    style.innerHTML = `
        #chatbot-trigger, #back-button-trigger { 
            position: fixed !important; 
            touch-action: none !important; 
            transition: none !important; 
            z-index: 99999 !important; /* লোডারের চেয়ে কম রাখুন */
            display: none !important; /* এখানে none দিন */
        }
    `;
    
    document.head.appendChild(style);

    setTimeout(() => {
        // চ্যাটবট বাটন সেটআপ
        makeButtonDraggable('chatbot-trigger', () => {
            const box = document.getElementById('chatbot-container');
            if(box) box.style.display = (box.style.display === 'flex') ? 'none' : 'flex';
        });

        // ব্যাক বাটন সেটআপ
        makeButtonDraggable('back-button-trigger', () => {
            executeBackStep();
        });
        // মিউজিক বাটন সেটআপ
        makeButtonDraggable('music-button-trigger', () => {
            const modal = document.getElementById('global-music-modal');
            if (modal) {
                // এখানে null পাঠানো হচ্ছে, যার মানে "বর্তমানে যা বাজছে তাই দেখাও"
                if(typeof openProPlayer === 'function') {
                    openProPlayer(null); 
                }
            }
        });
        
    }, 1500);
})();
</script>
</body> 
</html>